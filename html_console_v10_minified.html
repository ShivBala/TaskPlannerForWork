<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Enterprise Project Scheduler with Task Tracking</title><script src="https://cdn.tailwindcss.com"></script><style>:root{--primary-color:#1e3a8a;--secondary-color:#374151;--accent-color:#059669;--warning-color:#d97706;--danger-color:#dc2626;--background-color:#f8fafc;--card-background:#ffffff;--border-color:#e5e7eb;}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#f1f5f9 0%,#e2e8f0 100%);color:var(--secondary-color);}.enterprise-container{max-width:1600px;}.input-card,.output-card{background:var(--card-background);border:1px solid var(--border-color);box-shadow:0 2px 4px rgba(0,0,0,0.05);transition:all 0.2s ease;}.input-card.dirty,.output-card.dirty,div.card.dirty{background:#f0fdfa !important;border:1px solid #5eead4 !important;box-shadow:0 2px 4px rgba(45,212,191,0.1) !important;}.dirty{background-color:#f0fdfa !important;border-color:#5eead4 !important;}.input-card:hover,.output-card:hover{box-shadow:0 4px 6px rgba(0,0,0,0.07);}.input-card.dirty:hover,.output-card.dirty:hover,.card.dirty:hover{box-shadow:0 4px 6px rgba(45,212,191,0.15);}.enterprise-header{background:linear-gradient(135deg,var(--primary-color) 0%,#1e40af 100%);color:white;border-bottom:3px solid var(--accent-color);}.task-size-manager{background:linear-gradient(135deg,var(--primary-color) 0%,#1e40af 100%);color:white;border-radius:8px;padding:16px;margin-bottom:16px;}.task-size-card{background:rgba(255,255,255,0.1);border-radius:4px;padding:4px 8px;margin-bottom:0;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);transition:all 0.3s ease;display:inline-flex;flex-direction:column;align-items:center;min-width:80px;max-width:100px;}.task-size-card:hover{background:rgba(255,255,255,0.15);transform:translateY(-2px);}.size-input-enhanced{background:rgba(255,255,255,0.9);border:none;border-radius:3px;padding:3px 6px;color:var(--secondary-color);font-weight:600;text-align:center;width:50px;font-size:10px;}.size-controls{display:flex;flex-direction:column;align-items:center;gap:3px;flex-wrap:nowrap;width:100%;}.size-label-enhanced{font-weight:bold;font-size:11px;min-width:auto;text-align:center;}.size-metrics{font-size:9px;opacity:0.9;margin-top:2px;text-align:center;white-space:nowrap;}.preset-btn{background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:white;padding:4px 10px;border-radius:4px;font-size:11px;cursor:pointer;transition:all 0.3s ease;}.preset-btn:hover{background:rgba(255,255,255,0.3);transform:translateY(-1px);}.custom-size-form{background:rgba(255,255,255,0.1);border-radius:6px;padding:12px;margin-top:12px;border:1px dashed rgba(255,255,255,0.3);}.timeline-container{background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%);border:1px solid #bae6fd;}.timeline-scroll-container{scrollbar-width:thin;scrollbar-color:#6b7280 #f3f4f6;}.timeline-scroll-container::-webkit-scrollbar{width:12px;height:12px;}.timeline-scroll-container::-webkit-scrollbar-track{background:#f3f4f6;border-radius:6px;}.timeline-scroll-container::-webkit-scrollbar-thumb{background:#6b7280;border-radius:6px;border:2px solid #f3f4f6;}.timeline-scroll-container::-webkit-scrollbar-thumb:hover{background:#4b5563;}.timeline-scroll-container::-webkit-scrollbar-corner{background:#f3f4f6;}.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(30,58,138,0.4);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all 0.3s ease;}.modal-overlay.active{opacity:1;visibility:visible;}.modal-content{background:var(--card-background);border-radius:8px;padding:20px;max-width:600px;max-height:80vh;overflow-y:auto;box-shadow:0 20px 25px-5px rgba(0,0,0,0.1),0 10px 10px-5px rgba(0,0,0,0.04);transform:scale(0.9);transition:transform 0.3s ease;margin:20px;width:calc(100%-40px);border:2px solid var(--primary-color);}@media (min-width:640px){.modal-content{width:auto;margin:0;}}.modal-overlay.active .modal-content{transform:scale(1);}.modal-header{border-bottom:2px solid var(--primary-color);padding-bottom:12px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;}.modal-title{font-size:16px;font-weight:600;color:var(--primary-color);}.modal-close{background:none;border:none;font-size:20px;cursor:pointer;color:var(--secondary-color);padding:4px;border-radius:4px;transition:background-color 0.2s;}.modal-close:hover{background-color:#f3f4f6;}.calculation-details{font-family:'Courier New',monospace;font-size:12px;line-height:1.5;white-space:pre-wrap;background:#f8fafc;padding:12px;border-radius:6px;border-left:4px solid var(--primary-color);max-height:350px;overflow-y:auto;}.details-btn{background:var(--primary-color);color:white;border:none;padding:3px 6px;border-radius:3px;font-size:10px;cursor:pointer;margin-left:6px;transition:background-color 0.2s;}.details-btn:hover{background:#1e40af;}.size-dropdown{border:1px solid var(--border-color);border-radius:4px;padding:3px 6px;font-size:11px;font-weight:600;color:var(--primary-color);background:white;cursor:pointer;transition:all 0.2s ease;width:100%;min-width:70px;}.size-dropdown:hover{border-color:var(--primary-color);box-shadow:0 0 0 1px var(--primary-color);}.size-dropdown:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 2px rgba(30,58,138,0.2);}.size-dropdown option{padding:3px;font-weight:normal;}.timeline-marker{position:absolute;width:16px;height:16px;border-radius:50%;cursor:pointer;transition:all 0.3s ease;top:50%;transform:translateY(-50%);z-index:100;}.timeline-marker:hover{transform:translateY(-50%) scale(1.2);z-index:101;}.timeline-marker.active{transform:translateY(-50%) scale(1.4);z-index:102;}.timeline-tooltip{position:absolute;bottom:150%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.9);color:white;padding:12px 16px;border-radius:8px;font-size:13px;font-weight:500;white-space:normal;pointer-events:none;opacity:0;transition:all 0.3s ease;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,0.4);margin-bottom:12px;min-width:350px;max-width:450px;width:400px;text-align:left;line-height:1.4;}.timeline-tooltip.visible{opacity:1;transform:translateX(-50%) translateY(-8px);}.timeline-tooltip.tooltip-left.visible{opacity:1;transform:translateX(0) translateY(-8px);}.timeline-tooltip.tooltip-right.visible{opacity:1;transform:translateX(0) translateY(-8px);}.timeline-tooltip.tooltip-center.visible{opacity:1;transform:translateX(-50%) translateY(-8px);}.timeline-tooltip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:8px solid transparent;border-top-color:rgba(0,0,0,0.9);}.timeline-tooltip.tooltip-left::after{left:20px;transform:translateX(0);}.timeline-tooltip.tooltip-right::after{left:auto;right:20px;transform:translateX(0);}.timeline-delayed{background:linear-gradient(45deg,var(--danger-color) 0%,#b91c1c 100%);}.timeline-ontime{background:linear-gradient(45deg,var(--accent-color) 0%,#047857 100%);}.timeline-legend-item{display:flex;align-items:center;gap:4px;padding:2px 6px;background:rgba(255,255,255,0.8);border-radius:10px;border:1px solid rgba(0,0,0,0.1);font-size:11px;}.timeline-legend-dot{width:6px;height:6px;border-radius:50%;}.tooltip-container{position:relative;cursor:pointer;}.tooltip-text{visibility:hidden;width:280px;background-color:var(--secondary-color);color:#fff;text-align:left;border-radius:6px;padding:8px;position:absolute;z-index:10;bottom:125%;left:50%;margin-left:-140px;opacity:0;transition:opacity 0.3s;font-size:0.8rem;pointer-events:none;white-space:pre-wrap;}.tooltip-container:hover .tooltip-text{visibility:visible;opacity:1;}.select-multiple{appearance:none;-webkit-appearance:none;-moz-appearance:none;background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%236b7280'%3e%3cpath d='M7 7l3-3 3 3m0 6l-3 3-3-3' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right 0.5rem center;background-size:1.5em;}.compact-spacing{gap:12px;}.compact-card{padding:12px;}.btn-enterprise{background:var(--primary-color);color:white;border:none;padding:8px 16px;border-radius:4px;font-weight:500;cursor:pointer;transition:all 0.2s ease;font-size:13px;}.btn-enterprise:hover{background:#1e40af;transform:translateY(-1px);box-shadow:0 2px 4px rgba(0,0,0,0.1);}.btn-secondary{background:var(--secondary-color);}.btn-secondary:hover{background:#4b5563;}.btn-success{background:var(--accent-color);}.btn-success:hover{background:#047857;}.btn-danger{background:var(--danger-color);}.btn-danger:hover{background:#b91c1c;}#main-content{display:block !important;margin-bottom:2rem !important;}@media (max-width:1024px){#main-content{display:block !important;}.task-config-container{width:100% !important;float:none !important;margin-right:0 !important;margin-bottom:20px !important;}}.task-config-container{width:100% !important;max-width:100% !important;float:none !important;margin-right:0 !important;margin-bottom:20px !important;margin-top:20px !important;}.task-management-area{width:100% !important;overflow:visible !important;}#task-size-cards{display:flex !important;flex-direction:row !important;flex-wrap:wrap !important;gap:8px !important;margin-bottom:12px !important;}#task-size-cards>*{margin-top:0 !important;flex:0 0 auto !important;}.team-availability-scroll{scrollbar-width:thin;scrollbar-color:#cbd5e1 #f1f5f9;position:relative;}.team-availability-scroll::-webkit-scrollbar{width:6px;}.team-availability-scroll::-webkit-scrollbar-track{background:#f1f5f9;border-radius:3px;}.team-availability-scroll::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px;}.team-availability-scroll::-webkit-scrollbar-thumb:hover{background:#94a3b8;}.team-availability-scroll::after{content:'';position:absolute;bottom:0;left:0;right:0;height:20px;background:linear-gradient(transparent,rgba(248,250,252,0.8));pointer-events:none;border-radius:0 0 8px 8px;}.team-availability-scroll .person-card{transition:all 0.2s ease;}.team-availability-scroll .person-card:hover{transform:translateX(2px);box-shadow:0 2px 4px rgba(0,0,0,0.1);}.enterprise-table{font-size:12px;}.enterprise-table th{padding:8px 12px;background:var(--primary-color);color:white;font-weight:600;text-transform:uppercase;font-size:10px;letter-spacing:0.5px;}.enterprise-table td{padding:6px 12px;border-bottom:1px solid var(--border-color);}.enterprise-table tr:hover{background:rgba(30,58,138,0.03);}.enterprise-input{background:var(--card-background);border:2px solid var(--border-color);border-radius:6px;padding:8px 12px;color:var(--secondary-color);font-weight:500;transition:all 0.2s ease;outline:none;}.enterprise-input:focus{border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(30,58,138,0.1);}.enterprise-input:hover{border-color:var(--primary-color);}.form-section{transition:all 0.3s ease;}.form-section:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.05);}.compact-grid{gap:0.75rem;}.compact-grid input,.compact-grid select{height:36px;}.btn-enterprise{position:relative;overflow:hidden;}.btn-enterprise::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:left 0.5s;}.btn-enterprise:hover::before{left:100%;}.section-header{border-bottom:2px solid #e5e7eb;margin-bottom:1rem;padding-bottom:0.5rem;}input,select,button,.card{transition:all 0.2s cubic-bezier(0.4,0,0.2,1);}.mb-tight{margin-bottom:0.5rem;}.mt-tight{margin-top:0.5rem;}.space-y-tight>*+*{margin-top:0.75rem;}.status-badge{display:inline-flex;align-items:center;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.2s ease;border:1px solid transparent;white-space:nowrap;user-select:none;}.status-badge:hover{transform:translateY(-1px);box-shadow:0 2px 4px rgba(0,0,0,0.1);}.status-badge.status-done{background:#dbeafe;color:#1e40af;border-color:#93c5fd;}.status-badge.status-todo:hover{background:#bfdbfe;}.status-badge.status-closed{background:#6b7280;color:#fff;border-color:#6b7280;}.status-badge.status-closed:hover{background:#374151;border-color:#374151;}.status-badge.status-inprogress{background:#fef3c7;color:#d97706;border-color:#fcd34d;}.status-badge.status-inprogress:hover{background:#fde68a;}.status-badge.status-paused{background:#fed7aa;color:#ea580c;border-color:#fdba74;}.status-badge.status-paused:hover{background:#fec996;}.status-badge.status-done{background:#dcfce7;color:#166534;border-color:#86efac;}.status-badge.status-done:hover{background:#bbf7d0;}</style></head><body class="p-4 md:p-8"><div id="app" class="enterprise-container mx-auto"><div class="enterprise-header flex justify-between items-center mb-4 p-4 rounded-lg"><h1 class="text-2xl font-bold">Enterprise Project Tracking Console</h1><div class="flex gap-2"><button id="export-closed-btn" onclick="exportClosedItems()" class="btn-enterprise flex items-center" disabled><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Export Closed</button><button onclick="exportConfiguration()" class="btn-enterprise flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>Export Config</button><button onclick="triggerImport()" class="btn-enterprise flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/></svg>Import Config</button><button onclick="triggerTaskImport()" class="btn-enterprise flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>Import Tasks</button><button onclick="exportData()" class="btn-enterprise flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>Export Schedule</button><button onclick="resetToDefaults()" class="btn-danger flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>Reset</button></div></div><p id="auth-status" class="text-xs text-gray-600 mb-3">ğŸ“Š Enterprise data management-All information stored securely in browser storage.</p><input type="file" id="import-config-file" accept=".csv" style="display:none;" onchange="handleConfigImport(event)"><input type="file" id="import-tasks-file" accept=".csv" style="display:none;" onchange="handleTaskImport(event)"><div id="loading-spinner" class="text-center p-10 hidden"></div><div id="main-content" class="mb-8"><div class="task-management-area input-card enterprise-table p-4 rounded-lg"><h2 class="text-lg font-semibold mb-3 text-primary-dark flex items-center mt-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Task Management</h2><div class="mb-3 p-4 enterprise-card border rounded-lg bg-gradient-to-r from-blue-50 to-indigo-50"><div class="flex items-center justify-between gap-6"><div class="flex items-center gap-4"><label class="flex items-center cursor-pointer group"><input type="checkbox" id="use-common-start-date" onchange="toggleCommonStartDate()" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 transition-all"><span class="ml-2 text-sm font-semibold text-primary-dark group-hover:text-blue-700 transition-colors">ğŸ“… Unified Start Date</span></label><input type="date" id="common-start-date" disabled class="enterprise-input text-sm w-36 transition-all duration-200" title="Common start date for all tasks" onchange="updateAllTaskStartDates()"></div><div class="text-right bg-white/70 backdrop-blur-sm rounded-lg p-3 border border-blue-200/50"><div class="flex items-center gap-2 mb-1"><span class="text-xs font-medium text-gray-600">ğŸ PROJECT COMPLETION</span></div><div class="flex items-center justify-end gap-2"><div class="text-sm font-bold text-blue-800" id="furthest-completion-date">No tasks</div><div class="text-xs font-medium text-white bg-blue-600 px-2 py-1 rounded-full" id="furthest-completion-week">â€”</div></div></div></div><div class="text-xs text-gray-600 mt-2 italic">ğŸ’¡ Synchronizes all task start dates for streamlined project planning</div></div><div class="mb-4 p-4 bg-white border rounded-lg shadow-sm"><div class="flex items-center gap-2 mb-3"><h3 class="font-bold text-md text-primary-dark">â• Add New Task</h3><div class="flex-1 border-t border-gray-200"></div></div><div class="grid grid-cols-1 lg:grid-cols-12 gap-3 items-end"><div class="lg:col-span-4"><label class="block text-xs font-medium text-gray-700 mb-1">Task Description</label><input type="text" id="new-ticket-desc" placeholder="Enter task description..." class="enterprise-input w-full focus:ring-2 focus:ring-blue-500 transition-all"></div><div class="lg:col-span-2"><label class="block text-xs font-medium text-gray-700 mb-1">Start Date</label><input type="date" id="new-ticket-start-date" class="enterprise-input w-full focus:ring-2 focus:ring-blue-500 transition-all" title="Start Date"></div><div class="lg:col-span-2 grid grid-cols-2 gap-2"><div><label class="block text-xs font-medium text-gray-700 mb-1">Size</label><select id="new-ticket-size" class="enterprise-input w-full focus:ring-2 focus:ring-blue-500 transition-all"></select></div><div><label class="block text-xs font-medium text-gray-700 mb-1">Priority</label><select id="new-ticket-priority" class="enterprise-input w-full focus:ring-2 focus:ring-blue-500 transition-all" title="Priority"><option value="P3">P3</option><option value="P1">P1</option><option value="P2">P2</option><option value="P4">P4</option><option value="P5">P5</option></select></div></div><div class="lg:col-span-1 flex items-end pb-1 gap-2"><label class="flex items-center gap-1 text-xs font-medium text-gray-700 cursor-pointer" title="Check to make task duration split among assignees. Unchecked (default) keeps fixed duration regardless of assignees."><input type="checkbox" id="new-ticket-flexible" class="w-4 h-4 text-blue-600 focus:ring-2 focus:ring-blue-500 rounded"><span>Flexible</span></label><button type="button" id="new-ticket-details-icon" onclick="openNewTicketDetailsModal()" class="text-gray-400 hover:text-blue-600 transition-colors" title="Add task details (description,positives,negatives)"><span style="font-size:1.2em;">ğŸ“</span></button></div><div class="lg:col-span-1"><label class="block text-xs font-medium text-gray-700 mb-1">Stakeholder*</label><select id="new-ticket-stakeholder" class="enterprise-input w-full focus:ring-2 focus:ring-blue-500 transition-all" required></select></div><div class="lg:col-span-1"><label class="block text-xs font-medium text-gray-700 mb-1">Initiative*</label><select id="new-ticket-initiative" class="enterprise-input w-full focus:ring-2 focus:ring-blue-500 transition-all" required></select></div><div class="lg:col-span-2"><label class="block text-xs font-medium text-gray-700 mb-1">Assign to:</label><div id="new-ticket-assigned" class="flex flex-wrap gap-1 p-2 border border-gray-300 rounded-md bg-gray-50 min-h-[36px] items-center transition-all hover:bg-white focus-within:bg-white focus-within:border-blue-500"></div></div><div class="lg:col-span-1"><button onclick="addTicket()" class="btn-enterprise w-full h-[36px] font-semibold shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105">Add Task</button></div></div><div class="text-xs text-gray-500 mt-2 bg-gray-50 rounded p-2">ğŸ’¡<span id="start-date-help">Individual start dates enabled. Team availability calculated from earliest task.</span></div></div><div class="space-y-3"><div class="flex items-center gap-2"><h3 class="text-lg font-bold text-primary-dark">ğŸ“‹ Task Schedule</h3><div class="flex-1 border-t border-gray-300"></div></div><div id="task-filter-section" class="p-3 bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-200 rounded-lg"><div class="flex items-center gap-3"><span class="text-sm font-semibold text-gray-700 whitespace-nowrap">ğŸ” Filter by person:</span><div id="person-filter-buttons" class="flex flex-wrap gap-2 flex-1"></div><button id="clear-filter-btn" onclick="clearPersonFilter()" class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600 transition-colors flex-shrink-0" style="display:none;">Clear</button></div><div class="flex items-center gap-3 mt-2"><span class="text-sm font-semibold text-gray-700 whitespace-nowrap">ğŸ“Š Filter by status:</span><div id="status-filter-buttons" class="flex flex-wrap gap-2 flex-1"></div><button id="clear-status-filter-btn" onclick="clearStatusFilter()" class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600 transition-colors flex-shrink-0" style="display:none;">Clear</button></div><div class="flex items-center gap-3 mt-2"><span class="text-sm font-semibold text-gray-700 whitespace-nowrap">ğŸ“… Filter by date:</span><div id="date-filter-buttons" class="flex flex-wrap gap-2 flex-1"></div><button id="clear-date-filter-btn" onclick="clearDateFilter()" class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600 transition-colors flex-shrink-0" style="display:none;">Clear</button></div><div class="flex items-center gap-3 mt-2"><span class="text-sm font-semibold text-gray-700 whitespace-nowrap">ğŸ‘¥ Filter by stakeholder:</span><select id="stakeholder-filter-dropdown" onchange="filterByStakeholder(this.value)" class="flex-1 px-3 py-1.5 bg-white border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500"><option value="">All Stakeholders</option></select></div><div class="flex items-center gap-3 mt-2"><span class="text-sm font-semibold text-gray-700 whitespace-nowrap">ğŸ“Š Filter by initiative:</span><select id="initiative-filter-dropdown" onchange="filterByInitiative(this.value)" class="flex-1 px-3 py-1.5 bg-white border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"><option value="">All Initiatives</option></select></div><div id="filter-status" class="text-xs text-gray-600 mt-2" style="display:none;"></div></div><div class="overflow-x-auto rounded-lg border"><table class="enterprise-table min-w-full divide-y"><thead><tr><th class="px-3 py-2 text-left w-16">ID</th><th class="px-3 py-2 text-left min-w-0 flex-1">Description</th><th class="px-3 py-2 text-left w-32"><span id="start-date-column-header">Start Date</span></th><th class="px-3 py-2 text-left" style="min-width:120px;">Size</th><th class="px-3 py-2 text-left w-24 tooltip-container">Task Type<div class="tooltip-text">ğŸ”’ Fixed-Length:Duration constant regardless of assignees<br>âš¡ Flexible:Duration splits among assignees</div></th><th class="px-3 py-2 text-left w-20">Priority</th><th class="px-3 py-2 text-left w-24">Status</th><th class="px-3 py-2 text-left w-28">Stakeholder</th><th class="px-3 py-2 text-left w-28">Initiative</th><th class="px-3 py-2 text-left w-48">Assigned</th><th class="px-3 py-2 text-left w-32 tooltip-container">End Date<div class="tooltip-text">Calculated from start date,team availability,and effort hours.</div></th><th class="px-3 py-2 text-left w-24">Actions</th></tr></thead><tbody id="ticket-table-body" class="divide-y"></tbody></table></div><p id="no-tickets" class="text-center py-3 text-gray-500 hidden">No tasks defined. Add a task to begin!</p></div></div></div></div><div class="w-full p-4 bg-gradient-to-r from-teal-50 via-cyan-50 to-blue-50 border-t-2 border-teal-400 mt-6"><h2 class="text-lg font-bold mb-3 text-center text-teal-800 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>âš™ï¸ Configuration Management</h2><div class="grid grid-cols-1 lg:grid-cols-2 gap-4 max-w-7xl mx-auto"><div class="bg-white rounded-lg p-3 shadow-sm border-l-4 border-teal-500"><h3 class="text-base font-bold mb-2 text-teal-700 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>ğŸ‘¥ Stakeholders</h3><div id="stakeholders-list" class="flex flex-wrap gap-1.5 mb-3 min-h-[40px] p-2 bg-gray-50 rounded border border-gray-200"></div><div class="flex gap-2"><input type="text" id="new-stakeholder-input" placeholder="Enter stakeholder name..." class="enterprise-input flex-1 text-sm" onkeypress="if(event.key==='Enter') addStakeholder()"><button onclick="addStakeholder()" class="btn-enterprise px-4 py-1.5 text-sm font-semibold">â• Add</button></div><div class="text-xs text-teal-600 mt-2 italic">ğŸ’¡ "General" is the default and cannot be removed.</div></div><div class="bg-white rounded-lg p-3 shadow-sm border-l-4 border-orange-500"><h3 class="text-base font-bold mb-2 text-orange-700 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>ğŸ“Š Initiatives</h3><div id="initiatives-list" class="flex flex-wrap gap-1.5 mb-3 min-h-[40px] p-2 bg-gray-50 rounded border border-gray-200"></div><div class="flex gap-2"><input type="text" id="new-initiative-input" placeholder="Enter initiative name..." class="enterprise-input flex-1 text-sm" onkeypress="if(event.key==='Enter') addInitiative()"><button onclick="addInitiative()" class="btn-enterprise px-4 py-1.5 text-sm font-semibold">â• Add</button></div><div class="text-xs text-orange-600 mt-2 italic">ğŸ’¡ "General" is the default and cannot be removed.</div></div></div></div></div><div id="calculation-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3 class="modal-title" id="modal-title">Calculation Details</h3><button class="modal-close" onclick="closeCalculationModal()">&times;</button></div><div class="calculation-details" id="calculation-content"></div></div></div><div id="overdue-tasks-modal" class="modal-overlay"><div class="modal-content" style="max-width:700px;"><div class="modal-header"><h3 class="modal-title">âš ï¸ Overdue Tasks Found</h3><button class="modal-close" onclick="closeOverdueTasksModal()">&times;</button></div><div style="margin-bottom:20px;"><p style="margin-bottom:8px;color:var(--text-color);">The following "To Do" tasks have start dates in the past:</p><p style="margin-bottom:12px;color:var(--text-secondary);font-size:13px;font-style:italic;">ğŸ’¡ Tip:Use the buttons on each task for individual actions,or use the buttons below to apply to all remaining tasks.</p><div id="overdue-tasks-list" style="background:var(--background-color);border-radius:6px;padding:12px;max-height:350px;overflow-y:auto;margin-bottom:16px;"></div><p style="margin-bottom:12px;color:var(--text-color);font-size:14px;font-weight:600;border-top:1px solid var(--border-color);padding-top:12px;">Bulk Actions (apply to all remaining tasks):</p><div style="display:flex;gap:10px;flex-wrap:wrap;"><button onclick="handleOverdueTasksAction('move')" class="btn-enterprise" style="flex:1;min-width:180px;">ğŸ“… Move All to Today</button><button onclick="handleOverdueTasksAction('progress')" class="btn-enterprise" style="flex:1;min-width:180px;">â–¶ï¸ Change All to In Progress</button><button onclick="handleOverdueTasksAction('skip')" class="btn-enterprise" style="flex:1;min-width:180px;">â­ï¸ Skip/Dismiss</button></div></div></div></div><div id="task-details-modal" class="modal-overlay"><div class="modal-content" style="max-width:60vw;width:60vw;"><div class="modal-header"><h3 class="modal-title">ğŸ“ Task Details</h3><button class="modal-close" onclick="closeTaskDetailsModal()">&times;</button></div><div style="padding:20px;"><input type="hidden" id="details-modal-task-id"><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“„ Description</label><textarea id="details-modal-description" rows="6" placeholder="Enter task description..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"></textarea></div><div><label class="block text-sm font-medium text-green-700 mb-2">âœ… Positives</label><textarea id="details-modal-positives" rows="6" placeholder="Benefits,positive outcomes,advantages..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 text-sm"></textarea></div><div><label class="block text-sm font-medium text-red-700 mb-2">âš ï¸ Negatives</label><textarea id="details-modal-negatives" rows="6" placeholder="Risks,challenges,concerns..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 text-sm"></textarea></div></div><div class="flex gap-3 mt-6 justify-end"><button onclick="closeTaskDetailsModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button><button onclick="saveTaskDetails()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">ğŸ’¾ Save Details</button></div></div></div></div><div id="new-ticket-details-modal" class="modal-overlay"><div class="modal-content" style="max-width:60vw;width:60vw;"><div class="modal-header"><h3 class="modal-title">ğŸ“ Add Task Details (Optional)</h3><button class="modal-close" onclick="closeNewTicketDetailsModal()">&times;</button></div><div style="padding:20px;"><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“„ Description</label><textarea id="new-ticket-details-description" rows="6" placeholder="Enter task description..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"></textarea></div><div><label class="block text-sm font-medium text-green-700 mb-2">âœ… Positives</label><textarea id="new-ticket-details-positives" rows="6" placeholder="Benefits,positive outcomes,advantages..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 text-sm"></textarea></div><div><label class="block text-sm font-medium text-red-700 mb-2">âš ï¸ Negatives</label><textarea id="new-ticket-details-negatives" rows="6" placeholder="Risks,challenges,concerns..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 text-sm"></textarea></div></div><div class="flex gap-3 mt-6 justify-end"><button onclick="closeNewTicketDetailsModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button><button onclick="saveNewTicketDetails()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">ğŸ’¾ Save Details</button></div></div></div></div><div class="container mx-auto px-4 py-6"><div class="card"><div class="card-header"><div class="flex justify-between items-center"><div><h2 class="card-title">ğŸ“Š Team Workload Heat Map (Next 8 Weeks)</h2><p class="text-sm text-gray-600 mt-1">Visual overview of team capacity utilization based on individual availability</p></div><div class="flex gap-2"><button onclick="openBulkTaskResolution()" class="btn-enterprise flex items-center gap-2"><span>âœ…</span>Resolve Completed</button><button onclick="generateDelayAnalysis()" class="btn-enterprise flex items-center gap-2"><span>ğŸ“…</span>Analyze Start Date Delays</button><button onclick="generateEndDateDelayAnalysis()" class="btn-enterprise flex items-center gap-2"><span>â°</span>Analyze End Date Delays</button><button onclick="generateComprehensiveDelayAnalysis()" class="btn-enterprise flex items-center gap-2"><span>ğŸ”</span>Analyze All Delays</button><button onclick="generateCompletionGraph()" class="btn-enterprise flex items-center gap-2"><span>ğŸ“ˆ</span>Generate Completion Graph</button><button onclick="exportTaskMapCSV()" class="btn-enterprise flex items-center gap-2"><span>ğŸ“Š</span>Export Task Map CSV</button></div></div></div><div class="card-content"><div id="workload-heatmap" class="overflow-x-auto"></div><div class="mt-4 flex flex-wrap gap-4 text-sm"><div class="flex items-center gap-2"><div class="w-4 h-4 bg-green-100 border border-green-300 rounded"></div><span>0-60% Capacity (Available)</span></div><div class="flex items-center gap-2"><div class="w-4 h-4 bg-yellow-100 border border-yellow-300 rounded"></div><span>61-90% Capacity (Busy)</span></div><div class="flex items-center gap-2"><div class="w-4 h-4 bg-red-100 border border-red-300 rounded"></div><span>91%+Capacity (Overloaded)</span></div></div></div></div></div><div id="completionGraphModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-auto"><div class="flex justify-between items-center p-6 border-b"><h2 class="text-2xl font-bold text-gray-800">ğŸ“ˆ Task Completion Projection</h2><button onclick="closeCompletionGraph()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button></div><div class="p-6"><div id="completionGraphContent" class="w-full h-96"></div><div class="mt-4 text-sm text-gray-600"><p><strong>ğŸ“Š Chart Explanation:</strong>This graph shows the projected completion dates for all tasks based on current scheduling and team capacity.</p></div></div></div></div><div id="delayAnalysisModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-auto"><div class="flex justify-between items-center p-6 border-b"><h2 class="text-2xl font-bold text-gray-800">â° Start Date Delay Analysis</h2><button onclick="closeDelayAnalysis()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button></div><div class="p-6"><div id="delayAnalysisContent" class="w-full"></div></div></div></div><div id="bulkTaskResolutionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white rounded-lg shadow-xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-auto"><div class="flex justify-between items-center p-6 border-b"><h2 class="text-2xl font-bold text-gray-800">âœ… Resolve Completed Tasks</h2><button onclick="closeBulkTaskResolution()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button></div><div class="p-6"><div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg"><p class="text-sm text-blue-800"><strong>ğŸ“‹ Tasks shown:</strong>"In Progress" tasks with calculated end dates in the past (overdue). Use the actions below to resolve each task or extend deadlines as needed.</p></div><div id="bulkTaskResolutionContent" class="w-full"></div></div></div></div><div class="container mx-auto px-4 py-6"><div class="card"><div class="card-header"><h2 class="card-title">ğŸ‘¥ Team Configuration</h2><p id="availability-header" class="text-sm text-gray-600 mt-1">Team Availability (Next 8 Weeks)</p></div><div class="card-content"><div id="people-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-6"></div><div class="border-t pt-4"><h3 class="text-lg font-semibold mb-3">Add New Team Member</h3><div class="flex gap-3 items-center max-w-md"><input type="text" id="new-person-name" placeholder="Enter team member name" class="enterprise-input flex-grow"><button onclick="addPerson()" class="btn-enterprise">Add Member</button></div></div></div></div></div><div class="container mx-auto px-4"><div class="task-config-container input-card enterprise-table p-4 rounded-lg"><div class="task-size-manager"><div class="flex items-center justify-between mb-3"><h2 class="text-base font-bold flex items-center text-primary-dark"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>ğŸ“ Task Configuration</h2><div class="flex gap-2 flex-wrap text-xs"><button onclick="applyPreset('agile')" class="btn-enterprise">ğŸƒ Agile</button><button onclick="applyPreset('enterprise')" class="btn-enterprise">ğŸ¢ Enterprise</button><button onclick="applyPreset('startup')" class="btn-enterprise">ğŸš€ Startup</button><button onclick="applyPreset('conservative')" class="btn-enterprise">ğŸ›¡ï¸ Conservative</button><button onclick="showCustomSizeForm()" class="btn-enterprise">â• Custom</button></div></div><div class="compact-spacing"><div class="mb-3 flex items-center gap-6 flex-wrap"><div class="flex items-center gap-2"><label class="text-sm font-semibold text-white">Estimation Base (hrs/day):</label><input type="number" id="estimation-base-hours" value="5" min="1" max="12" onchange="updateEstimationBase(event.target.value)" class="enterprise-input w-16 text-base font-bold"><span class="text-xs font-medium text-blue-100">â„¹ï¸ Productive hours (after meetings)</span></div><div class="flex items-center gap-2"><label class="text-sm font-semibold text-white">Project Hours/Day:</label><input type="number" id="project-hours-per-day" value="8" min="1" max="24" onchange="updateProjectHours(event.target.value)" class="enterprise-input w-16 text-base font-bold"><span class="text-xs font-medium text-blue-100">Task Effort=Days Ã—<span id="estimation-base-display" class="font-bold text-yellow-300">5</span>h</span></div></div><div id="task-size-cards" class="mb-3"></div><div id="custom-size-form" class="custom-size-form hidden"><h4 class="font-semibold mb-2 text-sm">Add Custom Task Size</h4><div class="flex gap-2 items-end flex-wrap"><div><label class="block text-xs mb-1">Key</label><input type="text" id="new-size-key" placeholder="XS" maxlength="4" class="enterprise-input w-16"></div><div><label class="block text-xs mb-1">Name</label><input type="text" id="new-size-name" placeholder="Extra Small" class="enterprise-input w-24"></div><div><label class="block text-xs mb-1">Days</label><input type="number" id="new-size-days" placeholder="0.5" min="0.1" max="50" step="0.5" class="enterprise-input w-16"></div><button onclick="addCustomSize()" class="btn-enterprise">Add</button><button onclick="hideCustomSizeForm()" class="btn-danger">Cancel</button></div></div></div></div></div></div><div class="container mx-auto px-4 py-6"><div class="card"><div class="card-header"><h2 class="card-title">ğŸ§® Calculation Formulas</h2><p class="text-sm text-gray-600 mt-1">Click below to understand how end dates and capacity utilization are calculated</p></div><div class="card-content"><div class="grid grid-cols-1 md:grid-cols-3 gap-3"><button onclick="showEndDateFormula()" class="p-4 bg-gradient-to-br from-blue-600 to-blue-700 border border-blue-800 rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-200 flex flex-col items-center gap-2 group shadow-md"><div class="flex items-center gap-2"><span class="text-2xl">ğŸ“…</span><span class="text-base font-semibold text-white">End Date Calculation</span></div><p class="text-xs text-blue-100 text-center">How task end dates are calculated</p><span class="text-xs text-blue-200 group-hover:text-white font-medium">Click to view formula â†’</span></button><button onclick="showHeatMapFormula()" class="p-4 bg-gradient-to-br from-blue-600 to-blue-700 border border-blue-800 rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-200 flex flex-col items-center gap-2 group shadow-md"><div class="flex items-center gap-2"><span class="text-2xl">ğŸ“Š</span><span class="text-base font-semibold text-white">Heat Map Calculation</span></div><p class="text-xs text-blue-100 text-center">Team capacity utilization per week</p><span class="text-xs text-blue-200 group-hover:text-white font-medium">Click to view formula â†’</span></button><button onclick="showInitiativeTimeline()" class="p-4 bg-gradient-to-br from-blue-600 to-blue-700 border border-blue-800 rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-200 flex flex-col items-center gap-2 group shadow-md"><div class="flex items-center gap-2"><span class="text-2xl">ğŸ¯</span><span class="text-base font-semibold text-white">Initiative Timeline</span></div><p class="text-xs text-blue-100 text-center">View initiatives with date ranges</p><span class="text-xs text-blue-200 group-hover:text-white font-medium">Click to view timeline â†’</span></button></div></div></div></div><div id="formula-modal" class="modal-overlay"><div class="modal-content" style="max-width:800px;"><div class="modal-header"><h3 class="modal-title" id="formula-modal-title">Calculation Formula</h3><button class="modal-close" onclick="closeFormulaModal()">&times;</button></div><div style="padding:20px;"><div id="formula-modal-content" style="white-space:pre-wrap;font-family:'Segoe UI',sans-serif;line-height:1.8;"></div><div class="flex gap-3 mt-6 justify-end"><button onclick="closeFormulaModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Close</button></div></div></div></div><div id="week-task-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden"><div class="bg-blue-600 text-white px-6 py-4 flex justify-between items-center"><h3 id="modal-title" class="text-xl font-semibold">Week Task Details</h3><button onclick="closeWeekTaskModal()" class="text-white hover:text-gray-200 text-2xl">&times;</button></div><div class="p-6 overflow-y-auto max-h-[60vh]"><div id="modal-content"></div></div></div></div><div id="initiative-timeline-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[80vh] overflow-hidden"><div class="bg-gradient-to-r from-purple-600 to-purple-700 text-white px-6 py-4 flex justify-between items-center"><div><h3 class="text-xl font-semibold">ğŸ¯ Initiative Timeline</h3><p class="text-sm text-purple-100 mt-1">Overview of all initiatives with date ranges and status</p></div><button onclick="closeInitiativeTimeline()" class="text-white hover:text-purple-200 text-2xl">&times;</button></div><div class="p-6 overflow-y-auto max-h-[60vh]"><div class="flex gap-4 mb-6 text-sm"><div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-blue-500"></div><span class="text-gray-700">Active Now</span></div><div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-gray-400"></div><span class="text-gray-700">Future</span></div></div><div id="initiative-timeline-content" class="space-y-4"></div></div></div></div><script>const IS_TEST_MODE=window.self !==window.top;const originalAlert=window.alert;const originalConfirm=window.confirm;if (IS_TEST_MODE){console.log('ğŸ§ª Test mode detected (running in iframe)-suppressing alerts and clearing localStorage...');window.alert=function(message){console.log('ğŸ”• [Alert suppressed in test mode]:',message);};window.confirm=function(message){console.log('ğŸ”• [Confirm auto-accepted in test mode]:',message);return true;};const keysToRemove=[];for (let i=0;i<localStorage.length;i++){const key=localStorage.key(i);if (key && (key.startsWith('taskScheduler_') || key.startsWith('projectScheduler'))){keysToRemove.push(key);}}keysToRemove.forEach(key=>localStorage.removeItem(key));console.log(`âœ… Cleared ${keysToRemove.length}localStorage keys for testing`);}const STORAGE_KEY='projectSchedulerDataV10';const APP_VERSION='10.0.0';let people=[];let tickets=[];let stakeholders=['General'];let initiatives=[{name:'General',creationDate:getLocalDateString(new Date()),startDate:null}];let estimationBaseHours=5;let projectHoursPerDay=8;let ticketDays={S:1,M:2,L:5,XL:10,XXL:15};let closedItemsExported=false;function generateUUID(){if (typeof crypto !=='undefined' && crypto.randomUUID){return crypto.randomUUID();}return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){const r=Math.random()*16 | 0;const v=c==='x' ? r:(r & 0x3 | 0x8);return v.toString(16);});}function getNextDisplayId(){if (tickets.length===0) return 1;const maxId=Math.max(...tickets.map(t=>t.id || 0));return maxId+1;}function normalizeTitle(title){return title.toLowerCase().replace(/\s+/g,'');}function findSimilarTasks(title){const normalized=normalizeTitle(title);const matches=[];for (const ticket of tickets){const ticketNormalized=normalizeTitle(ticket.description);if (ticketNormalized===normalized){matches.push({ticket,matchType:'exact',confidence:100});continue;}if (ticketNormalized.includes(normalized) || normalized.includes(ticketNormalized)){const confidence=Math.round((Math.min(normalized.length,ticketNormalized.length)/Math.max(normalized.length,ticketNormalized.length))*100);matches.push({ticket,matchType:'contains',confidence});continue;}const distance=levenshteinDistance(normalized,ticketNormalized);const maxLen=Math.max(normalized.length,ticketNormalized.length);const similarity=(1-distance/maxLen)*100;if (similarity>=70){matches.push({ticket,matchType:'fuzzy',confidence:Math.round(similarity)});}}matches.sort((a,b)=>b.confidence-a.confidence);return matches;}function levenshteinDistance(str1,str2){const matrix=[];for (let i=0;i<=str2.length;i++){matrix[i]=[i];}for (let j=0;j<=str1.length;j++){matrix[0][j]=j;}for (let i=1;i<=str2.length;i++){for (let j=1;j<=str1.length;j++){if (str2.charAt(i-1)===str1.charAt(j-1)){matrix[i][j]=matrix[i-1][j-1];}else{matrix[i][j]=Math.min( matrix[i-1][j-1]+1,matrix[i][j-1]+1,matrix[i-1][j]+1 );}}}return matrix[str2.length][str1.length];}let renderDebounceTimer=null;let renderPending=false;function scheduleRender(){if (!renderPending){renderPending=true;requestAnimationFrame(()=>{clearTimeout(renderDebounceTimer);renderDebounceTimer=setTimeout(()=>{renderPending=false;calculateProjection();},50);});}}function immediateRender(){clearTimeout(renderDebounceTimer);renderPending=false;calculateProjection();}let taskSizeDefinitions={S:{name:'Small',days:1,removable:false},M:{name:'Medium',days:2,removable:false},L:{name:'Large',days:5,removable:false},XL:{name:'X-Large',days:10,removable:false},XXL:{name:'XX-Large',days:15,removable:false}};function getLocalDateString(date){return date.getFullYear()+'-'+String(date.getMonth()+1).padStart(2,'0')+'-'+String(date.getDate()).padStart(2,'0');}function initializeStartDateHistory(ticket){if (!ticket.startDateHistory){ticket.startDateHistory=[];if (ticket.startDate){ticket.startDateHistory.push({date:ticket.startDate,timestamp:new Date().toISOString(),reason:'Initial planning'});}}return ticket;}function trackStartDateChange(ticket,oldDate,newDate,reason='Manual update'){initializeStartDateHistory(ticket);if (oldDate !==newDate){ticket.startDateHistory.push({date:newDate,timestamp:new Date().toISOString(),reason:reason,previousDate:oldDate});console.log(`ğŸ“… Start date changed for "${ticket.description}":${oldDate}â†’ ${newDate}(${reason})`);}}function initializeEndDateHistory(ticket){if (!ticket.endDateHistory){ticket.endDateHistory=[];}return ticket;}function trackEndDateChange(ticket,oldDate,newDate,reason='Date extension'){initializeEndDateHistory(ticket);if (oldDate !==newDate){ticket.endDateHistory.push({date:newDate,timestamp:new Date().toISOString(),reason:reason,previousDate:oldDate});console.log(`ğŸ“… End date changed for "${ticket.description}":${oldDate}â†’ ${newDate}(${reason})`);}}function initializeSizeHistory(ticket){if (!ticket.sizeHistory){ticket.sizeHistory=[];if (ticket.size){ticket.sizeHistory.push({size:ticket.size,days:taskSizeDefinitions[ticket.size]?.days || 0,timestamp:new Date().toISOString(),reason:'Initial sizing'});}}return ticket;}function trackSizeChange(ticket,oldSize,newSize,reason='Manual update'){initializeSizeHistory(ticket);if (oldSize !==newSize){ticket.sizeHistory.push({size:newSize,days:taskSizeDefinitions[newSize]?.days || 0,timestamp:new Date().toISOString(),reason:reason,previousSize:oldSize,previousDays:taskSizeDefinitions[oldSize]?.days || 0});console.log(`ğŸ“Š Size changed for "${ticket.description}":${oldSize}â†’ ${newSize}(${reason})`);}}let effortMap={};let currentTicketId=1;let useCommonStartDate=false;let selectedPersonFilters=[];let isUnassignedFilterActive=false;let selectedStatusFilters=[];let selectedDateFilters=[];let selectedStakeholderFilter='';let selectedInitiativeFilter='';let isDirty=false;function setDirtyState(dirty=true){isDirty=dirty;const cards=document.querySelectorAll('.input-card,.output-card,.card');if (dirty){cards.forEach(card=>card.classList.add('dirty'));document.title='ğŸ’¾ Enterprise Project Tracking Console (Unsaved Changes)';console.log('ğŸ’¾ Unsaved changes detected-export configuration to save');}else{cards.forEach(card=>card.classList.remove('dirty'));document.title='Enterprise Project Tracking Console';console.log('âœ… Configuration saved-all changes exported');}}function markDirty(){if (!isDirty){setDirtyState(true);closedItemsExported=false;updateExportButtonsState();}}function markClean(){setDirtyState(false);}const startDate=getNextMonday(new Date());function getEffectiveStartDate(){if (useCommonStartDate){const commonDate=document.getElementById('common-start-date')?.value;if (commonDate){const date=new Date(commonDate);return getMondayOfWeek(date);}}const earliestTaskDate=getEarliestTaskStartDate();if (earliestTaskDate){return getMondayOfWeek(earliestTaskDate);}return startDate;}function getMondayOfWeek(date){const d=new Date(date);const day=d.getDay();const diff=d.getDate()-day+(day===0 ?-6:1);const monday=new Date(d.setDate(diff));monday.setHours(0,0,0,0);return monday;}function getEarliestTaskStartDate(){if (tickets.length===0) return null;const taskDates=tickets .map(ticket=>ticket.startDate ? new Date(ticket.startDate):null) .filter(date=>date !==null) .sort((a,b)=>a-b);return taskDates.length>0 ? taskDates[0]:null;}function saveToLocalStorage(){console.log('ğŸ’¾ Saving to localStorage...');console.log('ğŸ“Š taskSizeDefinitions being saved:',taskSizeDefinitions);const data={people,tickets,stakeholders,initiatives,estimationBaseHours,projectHoursPerDay,ticketDays,taskSizeDefinitions,currentTicketId,useCommonStartDate,version:APP_VERSION,lastUpdated:new Date().toISOString()};try{localStorage.setItem(STORAGE_KEY,JSON.stringify(data));console.log('âœ… Save successful (V10)');}catch (e){console.error("Error saving to local storage:",e);}}function loadFromLocalStorage(){try{console.log('ğŸ”§ Loading from localStorage...');const storedData=localStorage.getItem(STORAGE_KEY);if (storedData){console.log('ğŸ“¦ Found stored data,parsing...');const data=JSON.parse(storedData);people=data.people || [];people.forEach(person=>{if (person.isProjectReady===undefined){person.isProjectReady=true;}});tickets=data.tickets || [];stakeholders=data.stakeholders || ['General'];initiatives=data.initiatives || [{name:'General',creationDate:getLocalDateString(new Date()),startDate:null}];tickets=tickets.map(ticket=>{ticket=initializeStartDateHistory(ticket);ticket=initializeEndDateHistory(ticket);ticket=initializeSizeHistory(ticket);if (ticket.isFixedLength===undefined){ticket.isFixedLength=true;}if (!ticket.uuid){ticket.uuid=generateUUID();}if (!ticket.stakeholder){ticket.stakeholder='General';}if (!ticket.initiative){ticket.initiative='General';}return ticket;});recalculateAllInitiativeStartDates();estimationBaseHours=data.estimationBaseHours || 5;projectHoursPerDay=data.projectHoursPerDay || data.hoursPerDay || 8;ticketDays=data.ticketDays ||{S:1,M:2,L:5,XL:10,XXL:15};console.log('ğŸ“Š Loaded taskSizeDefinitions from storage:',data.taskSizeDefinitions);taskSizeDefinitions=data.taskSizeDefinitions ||{S:{name:'Small',days:1,removable:false},M:{name:'Medium',days:2,removable:false},L:{name:'Large',days:5,removable:false},XL:{name:'X-Large',days:10,removable:false},XXL:{name:'XX-Large',days:15,removable:false}};console.log('ğŸ“Š Final taskSizeDefinitions after loading:',taskSizeDefinitions);backupTaskSizeDefinitions();currentTicketId=data.currentTicketId || (tickets.length>0 ? Math.max(...tickets.map(t=>t.id))+1:1);useCommonStartDate=data.useCommonStartDate || false;console.log('ğŸ”„ About to sync task sizes...');syncTaskSizes();console.log('ğŸ“Š taskSizeDefinitions after sync:',taskSizeDefinitions);migratePeopleToEightWeeks();markClean();return true;}}catch (e){console.error("Error loading from local storage:",e);}return false;}function syncTaskSizes(){Object.keys(taskSizeDefinitions).forEach(key=>{ticketDays[key]=taskSizeDefinitions[key].days;});}function migratePeopleToEightWeeks(){people.forEach(person=>{if (!person.availability){person.availability=[25,25,25,25,25,25,25,25];}else if (person.availability.length<8){const lastValue=person.availability[person.availability.length-1] || 25;while (person.availability.length<8){person.availability.push(lastValue);}}else if (person.availability.length>8){person.availability=person.availability.slice(0,8);}});saveToLocalStorage();}function getNextMonday(date){const d=new Date(date);const currentDay=d.getDay();let daysUntilMonday;if (currentDay===0){daysUntilMonday=1;}else if (currentDay===1){daysUntilMonday=(d.getHours()<9) ? 0:7;}else{daysUntilMonday=8-currentDay;}const nextMonday=new Date(d);nextMonday.setDate(d.getDate()+daysUntilMonday);nextMonday.setHours(0,0,0,0);return nextMonday;}function generatePersonFilterButtons(){const container=document.getElementById('person-filter-buttons');if (!container) return;container.innerHTML='';people.forEach(person=>{const button=document.createElement('button');button.className='person-filter-btn px-3 py-1 rounded-md text-xs transition-all duration-200 border';button.textContent=person.name;button.onclick=()=>togglePersonFilter(person.name);button.setAttribute('data-person',person.name);updatePersonFilterButtonState(button,person.name);container.appendChild(button);});const unassignedButton=document.createElement('button');unassignedButton.className='person-filter-btn px-3 py-1 rounded-md text-xs transition-all duration-200 border';unassignedButton.textContent='ğŸš« Unassigned';unassignedButton.onclick=()=>toggleUnassignedFilter();unassignedButton.setAttribute('data-person','__unassigned__');updateUnassignedFilterButtonState(unassignedButton);container.appendChild(unassignedButton);}function updatePersonFilterButtonState(button,personName){const isSelected=selectedPersonFilters.includes(personName);if (isSelected){button.className='person-filter-btn px-3 py-1 rounded-md text-xs transition-all duration-200 border bg-blue-600 text-white border-blue-600 font-medium';button.title=`âœ“ Showing ${personName}'s tasks (click to remove filter)`;}else if (selectedPersonFilters.length>0){button.className='person-filter-btn px-3 py-1 rounded-md text-xs transition-all duration-200 border bg-gray-100 text-gray-500 border-gray-300';button.title=`Click to show ${personName}'s tasks`;}else{button.className='person-filter-btn px-3 py-1 rounded-md text-xs transition-all duration-200 border bg-white text-gray-700 border-gray-300 hover:bg-gray-50';button.title=`Click to filter ${personName}'s tasks`;}}function togglePersonFilter(personName){if (selectedPersonFilters.includes(personName)){selectedPersonFilters=selectedPersonFilters.filter(name=>name !==personName);}else{selectedPersonFilters.push(personName);isUnassignedFilterActive=false;}updateFilterUI();updateTable();}function toggleUnassignedFilter(){isUnassignedFilterActive=!isUnassignedFilterActive;if (isUnassignedFilterActive){selectedPersonFilters=[];}updateFilterUI();updateTable();}function updateUnassignedFilterButtonState(button){if (isUnassignedFilterActive){button.className='person-filter-btn px-3 py-1 rounded-md text-xs transition-all duration-200 border bg-blue-600 text-white border-blue-600 font-medium';button.title='âœ“ Showing unassigned tasks (click to remove filter)';}else if (selectedPersonFilters.length>0){button.className='person-filter-btn px-3 py-1 rounded-md text-xs transition-all duration-200 border bg-gray-100 text-gray-500 border-gray-300';button.title='Click to show unassigned tasks';}else{button.className='person-filter-btn px-3 py-1 rounded-md text-xs transition-all duration-200 border bg-white text-gray-700 border-gray-300 hover:bg-gray-50';button.title='Click to filter unassigned tasks';}}function clearPersonFilter(){selectedPersonFilters=[];isUnassignedFilterActive=false;updateFilterUI();updateTable();}function updateFilterUI(){try{document.querySelectorAll('.person-filter-btn').forEach(button=>{const personName=button.getAttribute('data-person');if (personName==='__unassigned__'){updateUnassignedFilterButtonState(button);}else{updatePersonFilterButtonState(button,personName);}});document.querySelectorAll('.status-filter-btn').forEach(button=>{const status=button.getAttribute('data-status');updateStatusFilterButtonState(button,status);});document.querySelectorAll('.date-filter-btn').forEach(button=>{const dateRange=button.getAttribute('data-date');updateDateFilterButtonState(button,dateRange);});const filterStatus=document.getElementById('filter-status');const clearBtn=document.getElementById('clear-filter-btn');const clearStatusBtn=document.getElementById('clear-status-filter-btn');const clearDateBtn=document.getElementById('clear-date-filter-btn');if (!filterStatus){console.warn('Filter status element not found');return;}if (clearBtn){clearBtn.style.display=(selectedPersonFilters.length>0 || isUnassignedFilterActive) ? 'inline-block':'none';}if (clearStatusBtn){clearStatusBtn.style.display=selectedStatusFilters.length>0 ? 'inline-block':'none';}if (clearDateBtn){clearDateBtn.style.display=selectedDateFilters.length>0 ? 'inline-block':'none';}const hasAnyFilter=selectedPersonFilters.length>0 || isUnassignedFilterActive || selectedStatusFilters.length>0 || selectedDateFilters.length>0 || selectedStakeholderFilter || selectedInitiativeFilter;if (!hasAnyFilter){filterStatus.style.display='none';}else{filterStatus.style.display='block';const filteredTaskCount=getFilteredTickets().length;let statusMessage='Showing tasks';let hasCondition=false;if (isUnassignedFilterActive){statusMessage+=` that are<strong>Unassigned</strong>`;hasCondition=true;}else if (selectedPersonFilters.length>0){statusMessage+=` assigned to:<strong>${selectedPersonFilters.join(',')}</strong>`;hasCondition=true;}if (selectedStatusFilters.length>0){if (hasCondition) statusMessage+=' and';statusMessage+=` with status:<strong>${selectedStatusFilters.join(',')}</strong>`;hasCondition=true;}if (selectedDateFilters.length>0){if (hasCondition) statusMessage+=' and';statusMessage+=` active in:<strong>${selectedDateFilters.join(',')}</strong>`;hasCondition=true;}if (selectedStakeholderFilter){if (hasCondition) statusMessage+=' and';statusMessage+=` for stakeholder:<strong>${selectedStakeholderFilter}</strong>`;hasCondition=true;}if (selectedInitiativeFilter){if (hasCondition) statusMessage+=' and';statusMessage+=` in initiative:<strong>${selectedInitiativeFilter}</strong>`;hasCondition=true;}statusMessage+=` (${filteredTaskCount}task${filteredTaskCount !==1 ? 's':''}visible)`;filterStatus.innerHTML=statusMessage;}}catch (error){console.error('Error updating filter UI:',error);}}function generateStatusFilterButtons(){const container=document.getElementById('status-filter-buttons');if (!container) return;container.innerHTML='';const statuses=['To Do','In Progress','Paused','Done','Closed'];const statusIcons={'To Do':'ğŸ“‹','In Progress':'ğŸš€','Paused':'â¸ï¸','Done':'âœ…','Closed':'ğŸ—ƒï¸'};statuses.forEach(status=>{const button=document.createElement('button');button.className='status-filter-btn px-3 py-1 rounded-md text-xs transition-all duration-200 border';button.innerHTML=`${statusIcons[status]}${status}`;button.onclick=()=>toggleStatusFilter(status);button.setAttribute('data-status',status);updateStatusFilterButtonState(button,status);container.appendChild(button);});}function updateStatusFilterButtonState(button,status){const isSelected=selectedStatusFilters.includes(status);if (isSelected){button.className='status-filter-btn px-3 py-1 rounded-md text-xs transition-all duration-200 border bg-green-600 text-white border-green-600 font-medium';button.title=`âœ“ Showing "${status}" tasks (click to remove filter)`;}else if (selectedStatusFilters.length>0){button.className='status-filter-btn px-3 py-1 rounded-md text-xs transition-all duration-200 border bg-gray-100 text-gray-500 border-gray-300';button.title=`Click to show "${status}" tasks`;}else{button.className='status-filter-btn px-3 py-1 rounded-md text-xs transition-all duration-200 border bg-white text-gray-700 border-gray-300 hover:border-green-400';button.title=`Click to filter by "${status}" tasks`;}}function toggleStatusFilter(status){if (selectedStatusFilters.includes(status)){selectedStatusFilters=selectedStatusFilters.filter(s=>s !==status);}else{selectedStatusFilters.push(status);}updateFilterUI();updateTable();}function clearStatusFilter(){selectedStatusFilters=[];updateFilterUI();updateTable();}function generateDateFilterButtons(){const container=document.getElementById('date-filter-buttons');if (!container) return;container.innerHTML='';const dateRanges=['Today','This Week','Next Week'];const dateIcons={'Today':'ğŸ“…','This Week':'ğŸ“†','Next Week':'ğŸ—“ï¸'};dateRanges.forEach(dateRange=>{const button=document.createElement('button');button.className='date-filter-btn px-3 py-1 rounded-md text-xs transition-all duration-200 border';button.innerHTML=`${dateIcons[dateRange]}${dateRange}`;button.onclick=()=>toggleDateFilter(dateRange);button.setAttribute('data-date',dateRange);updateDateFilterButtonState(button,dateRange);container.appendChild(button);});}function updateDateFilterButtonState(button,dateRange){const isSelected=selectedDateFilters.includes(dateRange);if (isSelected){button.className='date-filter-btn px-3 py-1 rounded-md text-xs transition-all duration-200 border bg-blue-600 text-white border-blue-600 font-medium';button.title=`âœ“ Showing tasks active "${dateRange}" (click to remove filter)`;}else if (selectedDateFilters.length>0){button.className='date-filter-btn px-3 py-1 rounded-md text-xs transition-all duration-200 border bg-gray-100 text-gray-500 border-gray-300';button.title=`Click to show tasks active "${dateRange}"`;}else{button.className='date-filter-btn px-3 py-1 rounded-md text-xs transition-all duration-200 border bg-white text-gray-700 border-gray-300 hover:border-blue-400';button.title=`Click to filter by tasks active "${dateRange}"`;}}function toggleDateFilter(dateRange){if (selectedDateFilters.includes(dateRange)){selectedDateFilters=selectedDateFilters.filter(d=>d !==dateRange);}else{selectedDateFilters.push(dateRange);}updateFilterUI();updateTable();}function clearDateFilter(){selectedDateFilters=[];updateFilterUI();updateTable();}function filterByStakeholder(stakeholder){selectedStakeholderFilter=stakeholder;updateFilterUI();updateTable();}function populateStakeholderFilterDropdown(){const dropdown=document.getElementById('stakeholder-filter-dropdown');if (!dropdown) return;dropdown.innerHTML='<option value="">All Stakeholders</option>';stakeholders.forEach(sh=>{const option=document.createElement('option');option.value=sh;option.textContent=sh;if (sh===selectedStakeholderFilter){option.selected=true;}dropdown.appendChild(option);});}function filterByInitiative(initiative){selectedInitiativeFilter=initiative;updateFilterUI();updateTable();}function populateInitiativeFilterDropdown(){const dropdown=document.getElementById('initiative-filter-dropdown');if (!dropdown) return;dropdown.innerHTML='<option value="">All Initiatives</option>';initiatives.forEach(init=>{const option=document.createElement('option');option.value=init.name;option.textContent=init.name;if (init.name===selectedInitiativeFilter){option.selected=true;}dropdown.appendChild(option);});}function isTaskActiveInDateRange(ticket,dateRange){const today=new Date();today.setHours(0,0,0,0);let rangeStart,rangeEnd;if (dateRange==='Today'){rangeStart=new Date(today);rangeEnd=new Date(today);}else if (dateRange==='This Week'){rangeStart=new Date(today);const dayOfWeek=rangeStart.getDay();const mondayOffset=dayOfWeek===0 ?-6:1-dayOfWeek;rangeStart.setDate(rangeStart.getDate()+mondayOffset);rangeEnd=new Date(rangeStart);rangeEnd.setDate(rangeStart.getDate()+4);}else if (dateRange==='Next Week'){rangeStart=new Date(today);const dayOfWeek=rangeStart.getDay();const nextMondayOffset=dayOfWeek===0 ? 1:8-dayOfWeek;rangeStart.setDate(rangeStart.getDate()+nextMondayOffset);rangeEnd=new Date(rangeStart);rangeEnd.setDate(rangeStart.getDate()+4);}const taskStartDate=new Date(ticket.startDate);taskStartDate.setHours(0,0,0,0);const projectedTickets=getProjectedTickets();const projectedTicket=projectedTickets.find(pt=>pt.id===ticket.id);let taskEndDate=taskStartDate;if (projectedTicket && projectedTicket.rawEndDate){taskEndDate=new Date(projectedTicket.rawEndDate);taskEndDate.setHours(0,0,0,0);}return taskStartDate<=rangeEnd && taskEndDate>=rangeStart;}function shouldShowTicket(ticket){let personFilterPassed=false;if (isUnassignedFilterActive){personFilterPassed=!ticket.assigned || ticket.assigned.length===0;}else if (selectedPersonFilters.length===0){personFilterPassed=true;}else{personFilterPassed=selectedPersonFilters.some(filterPerson=>ticket.assigned.some(assignedPerson=>assignedPerson.toLowerCase()===filterPerson.toLowerCase() ) );}const statusFilterPassed=selectedStatusFilters.length===0 || selectedStatusFilters.includes(ticket.status || 'To Do');const dateFilterPassed=selectedDateFilters.length===0 || selectedDateFilters.some(dateRange=>isTaskActiveInDateRange(ticket,dateRange));const stakeholderFilterPassed=!selectedStakeholderFilter || ticket.stakeholder===selectedStakeholderFilter;const initiativeFilterPassed=!selectedInitiativeFilter || ticket.initiative===selectedInitiativeFilter;return personFilterPassed && statusFilterPassed && dateFilterPassed && stakeholderFilterPassed && initiativeFilterPassed;}function getFilteredTickets(){return tickets.filter(ticket=>shouldShowTicket(ticket));}function updateTable(){scheduleRender();}function getDefaultTaskStartDate(){const today=new Date();const currentDay=today.getDay();const currentHour=today.getHours();if (currentDay>=1 && currentDay<=4 && currentHour<17){return today;}if (currentDay===5 && currentHour<12){return today;}if (currentDay>=1 && currentDay<=4){const tomorrow=new Date(today);tomorrow.setDate(today.getDate()+1);return tomorrow;}return getNextMonday(today);}function formatDate(dateString){if (!dateString) return 'Not set';const date=new Date(dateString);return date.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}function formatWeekEndDate(weekIndex){const effectiveStart=getEffectiveStartDate();const date=new Date(effectiveStart);date.setDate(date.getDate()+(weekIndex*7)+4);return date.toLocaleDateString('en-US',{month:'short',day:'numeric'});}function getWeekDateRange(weekIndex){let startDate;if (heatMapStartDate){startDate=new Date(heatMapStartDate);}else{startDate=new Date();while (startDate.getDay() !==1){startDate.setDate(startDate.getDate()-1);}}const weekStartDate=new Date(startDate);weekStartDate.setDate(startDate.getDate()+(weekIndex*7));const weekEndDate=new Date(weekStartDate);weekEndDate.setDate(weekEndDate.getDate()+4);return `${weekStartDate.toLocaleDateString('en-US',{month:'short',day:'numeric'})}-${weekEndDate.toLocaleDateString('en-US',{month:'short',day:'numeric'})}`;}function formatCompletionDate(startWeekIndex,remainingHours,totalWeeklyCapacity){const effectiveStart=getEffectiveStartDate();const completionDate=new Date(effectiveStart);let daysIntoWeek=0;if (totalWeeklyCapacity>0){const daysNeeded=remainingHours/projectHoursPerDay;daysIntoWeek=Math.ceil(daysNeeded);daysIntoWeek=Math.min(daysIntoWeek,5);}completionDate.setDate(completionDate.getDate()+(startWeekIndex*7)+daysIntoWeek);let dayOfWeek=completionDate.getDay();if (dayOfWeek===6){completionDate.setDate(completionDate.getDate()+2);}else if (dayOfWeek===0){completionDate.setDate(completionDate.getDate()+1);}return completionDate.toLocaleDateString('en-US',{month:'short',day:'numeric'});}function getCompletionDateDetails(startWeekIndex,remainingHours,totalWeeklyCapacity){const effectiveStart=getEffectiveStartDate();const weekStartDate=new Date(effectiveStart);weekStartDate.setDate(weekStartDate.getDate()+(startWeekIndex*7));const actualStartDate=getNextBusinessDay(weekStartDate);if (totalWeeklyCapacity>0){const daysNeeded=Math.ceil(remainingHours/projectHoursPerDay);const completionDate=addBusinessDays(actualStartDate,Math.max(1,daysNeeded-1));return{formatted:completionDate.toLocaleDateString('en-US',{month:'short',day:'numeric'}),rawDate:new Date(completionDate)};}return{formatted:actualStartDate.toLocaleDateString('en-US',{month:'short',day:'numeric'}),rawDate:new Date(actualStartDate)};}function getDefaultTaskSizeDefinitions(){return{S:{name:'Small',days:1,removable:false},M:{name:'Medium',days:2,removable:false},L:{name:'Large',days:5,removable:false},XL:{name:'X-Large',days:10,removable:false},XXL:{name:'XX-Large',days:15,removable:false}};}function backupTaskSizeDefinitions(){if (!taskSizeDefinitions || Object.keys(taskSizeDefinitions).length===0){return;}try{const existingBackup=localStorage.getItem('taskSizeDefinitions_backup');const currentData=JSON.stringify(taskSizeDefinitions);if (existingBackup===currentData){return;}localStorage.setItem('taskSizeDefinitions_backup',currentData);const timestamp=new Date().toISOString();localStorage.setItem('taskSizeDefinitions_backup_timestamp',timestamp);console.log('ğŸ“ Backed up taskSizeDefinitions (changed data detected)');cleanupOldBackups();}catch (e){console.log('âš ï¸ Could not create backup:',e.message);}}function cleanupOldBackups(){try{const keysToCheck=['taskSizeDefinitions_backup_1','taskSizeDefinitions_backup_2','taskSizeDefinitions_backup_old'];keysToCheck.forEach(key=>{if (localStorage.getItem(key)){localStorage.removeItem(key);console.log(`ğŸ§¹ Cleaned up old backup:${key}`);}});}catch (e){console.log('âš ï¸ Could not clean up old backups:',e.message);}}function restoreTaskSizeDefinitions(){console.log('ğŸ”§ Attempting to restore taskSizeDefinitions...');try{const backup=localStorage.getItem('taskSizeDefinitions_backup');const backupTimestamp=localStorage.getItem('taskSizeDefinitions_backup_timestamp');if (backup){const restored=JSON.parse(backup);if (restored && Object.keys(restored).length>0){console.log('âœ… Restored from backup:',restored);if (backupTimestamp){console.log('ğŸ“… Backup created:',new Date(backupTimestamp).toLocaleString());}return restored;}}}catch (e){console.log('âš ï¸ Could not restore from backup:',e.message);}const defaults=getDefaultTaskSizeDefinitions();console.log('âœ… Restored from defaults:',defaults);return defaults;}function calculateEffortMap(){console.log('ğŸ”§ calculateEffortMap called');console.log('ğŸ“Š taskSizeDefinitions keys count:',Object.keys(taskSizeDefinitions).length);console.log('ğŸ“Š taskSizeDefinitions:',taskSizeDefinitions);if (Object.keys(taskSizeDefinitions).length===0){console.error('âŒ CRITICAL:taskSizeDefinitions is empty! Stack trace:');console.trace();taskSizeDefinitions=restoreTaskSizeDefinitions();}effortMap={};Object.keys(taskSizeDefinitions).forEach(key=>{const days=taskSizeDefinitions[key].days;const effort=days*estimationBaseHours;effortMap[key]=effort;console.log(`ğŸ“Š Size ${key}:${days}days Ã— ${estimationBaseHours}hours=${effort}hours`);});console.log('ğŸ“Š Final effort map:',effortMap);}function getProjectedTickets(){console.log('ğŸ”§ getProjectedTickets called');console.log('ğŸ“Š People count:',people.length);console.log('ğŸ“Š Tickets count:',tickets.length);if (people.length===0 || tickets.length===0){console.log('âŒ No people or tickets,returning N/A end dates');return tickets.map(t=>({...t,endDate:'N/A',explanation:'No people or no effort.',isDelayed:false}));}calculateEffortMap();console.log('ğŸ“Š Effort map:',effortMap);console.log('ğŸ“Š Task size definitions:',taskSizeDefinitions);const availabilityTracker=people.reduce((acc,p)=>{acc[p.name]=[...p.availability];return acc;},{});const sortedTickets=[...tickets].sort((a,b)=>{const dateA=new Date(a.startDate || getEffectiveStartDate());const dateB=new Date(b.startDate || getEffectiveStartDate());return dateA-dateB;});console.log('ğŸ“… Processing tickets in chronological order:');sortedTickets.forEach(ticket=>{console.log(`-Ticket ${ticket.id}:${ticket.description},Start:${ticket.startDate},Size:${ticket.size}`);});const projectedTickets=sortedTickets.map(ticket=>{console.log(`ğŸ« Processing ticket ${ticket.id}:${ticket.description}`);if (ticket.customEndDate){console.log(`ğŸ“… Using custom end date for ticket ${ticket.id}:${ticket.customEndDate}`);const customDate=new Date(ticket.customEndDate);const result={...ticket,endDate:customDate.toLocaleDateString('en-US',{month:'short',day:'numeric'}),rawEndDate:customDate,explanation:`Custom deadline set via bulk resolution:${customDate.toLocaleDateString()}`,isDelayed:false};console.log(`ğŸ“… Custom end date result for ticket ${ticket.id}:`,result);return result;}const isFixedLength=ticket.isFixedLength !==false;if (isFixedLength && ticket.assigned.length>0){console.log(`ğŸ”’ Fixed-Length task ${ticket.id}:Duration is fixed regardless of assignees`);const taskDays=taskSizeDefinitions[ticket.size]?.days || 0;const totalEffortHours=effortMap[ticket.size] || 0;let taskStartDate;if (useCommonStartDate){const commonDate=document.getElementById('common-start-date').value;taskStartDate=commonDate ? new Date(commonDate):getEffectiveStartDate();}else{taskStartDate=new Date(ticket.startDate || getEffectiveStartDate());}taskStartDate=getNextBusinessDay(taskStartDate);const endDate=addBusinessDays(new Date(taskStartDate),taskDays);const explanation=`ğŸ”’ Fixed-Length Task\n`+`Task Size:${ticket.size}=${taskDays}business days\n`+`Total Effort:${totalEffortHours}hours\n`+`Assigned to:${ticket.assigned.join(',')}(${ticket.assigned.length}person(s))\n`+`Start Date:${formatDate(taskStartDate.toISOString().split('T')[0])}\n`+`Duration:${taskDays}business days (fixed,regardless of team size)\n`+`Daily Capacity per Person:${(totalEffortHours/(taskDays*ticket.assigned.length)).toFixed(1)}hours/day (${((totalEffortHours/(taskDays*ticket.assigned.length))/projectHoursPerDay*100).toFixed(0)}% of ${projectHoursPerDay}h day)\n`+`End Date:${formatDate(endDate.toISOString().split('T')[0])}\n\n`+`Note:Fixed-Length tasks maintain the same duration regardless of how many people are assigned.\n`+`Each person works on the task proportionally over the full duration.`;return{...ticket,endDate:endDate.toLocaleDateString('en-US',{month:'short',day:'numeric'}),rawEndDate:endDate,explanation:explanation,isDelayed:false};}const totalEffortHours=effortMap[ticket.size] || 0;const assignedCount=ticket.assigned.length;console.log(`ğŸ“Š Ticket ${ticket.id}-Size:${ticket.size},Effort:${totalEffortHours}h,Assigned:${assignedCount}people`);const projectReadyPeople=ticket.assigned.filter(name=>{const person=people.find(p=>p.name===name);return person && person.isProjectReady;});const notProjectReadyPeople=ticket.assigned.filter(name=>{const person=people.find(p=>p.name===name);return person && !person.isProjectReady;});console.log(`ğŸ‘¥ Assigned to:${ticket.assigned.join(',')}`);if (projectReadyPeople.length>0){console.log(`ğŸ¯ Project Ready (Contributing):${projectReadyPeople.join(',')}`);}if (notProjectReadyPeople.length>0){console.log(`ğŸ“‹ Tracked Only (Not Contributing):${notProjectReadyPeople.join(',')}`);}const taskAvailabilityTracker=people.reduce((acc,p)=>{acc[p.name]=[...p.availability];return acc;},{});ticket.assigned.forEach(personName=>{console.log(`ğŸ” ${personName}availability:`,taskAvailabilityTracker[personName]);});const thisTaskStartDate=new Date(ticket.startDate || getEffectiveStartDate());sortedTickets.forEach(prevTicket=>{if (prevTicket.id===ticket.id) return;const prevStartDate=new Date(prevTicket.startDate || getEffectiveStartDate());if (prevStartDate>=thisTaskStartDate) return;});if (totalEffortHours===0 || assignedCount===0){console.log(`âŒ Ticket ${ticket.id}-No effort defined or no one assigned`);return{...ticket,endDate:'N/A',explanation:'No effort defined or no one assigned.',isDelayed:false};}let taskStartDate;if (useCommonStartDate){const commonDate=document.getElementById('common-start-date').value;taskStartDate=commonDate ? new Date(commonDate):getEffectiveStartDate();}else{taskStartDate=new Date(ticket.startDate || getEffectiveStartDate());}taskStartDate=getNextBusinessDay(taskStartDate);let heatMapBaselineDate=new Date();if (tickets.length>0){const earliestTask=tickets.reduce((earliest,task)=>new Date(task.startDate)<new Date(earliest.startDate) ? task:earliest );heatMapBaselineDate=new Date(earliestTask.startDate);}while (heatMapBaselineDate.getDay() !==1){heatMapBaselineDate.setDate(heatMapBaselineDate.getDate()-1);}const normalizedTaskStart=new Date(Date.UTC(taskStartDate.getFullYear(),taskStartDate.getMonth(),taskStartDate.getDate()));const normalizedBaseline=new Date(Date.UTC(heatMapBaselineDate.getFullYear(),heatMapBaselineDate.getMonth(),heatMapBaselineDate.getDate()));const daysDiff=Math.max(0,Math.round((normalizedTaskStart-normalizedBaseline)/(1000*60*60*24)));console.log(`ğŸ” Debug date calculation (UTC normalization):`);console.log(`-Original task start:${taskStartDate.toDateString()}`);console.log(`-Original baseline:${heatMapBaselineDate.toDateString()}`);console.log(`-UTC task start:${normalizedTaskStart.toISOString()}`);console.log(`-UTC baseline:${normalizedBaseline.toISOString()}`);console.log(`-Raw difference (ms):${normalizedTaskStart-normalizedBaseline}`);console.log(`-Calculated days:${(normalizedTaskStart-normalizedBaseline)/(1000*60*60*24)}`);console.log(`-Days difference (rounded):${daysDiff}`);const startWeekIndex=Math.floor(daysDiff/7);console.log(`ğŸ“… Task ${ticket.id}week calculation:`);console.log(`-Task start date:${taskStartDate.toDateString()}`);console.log(`-Heat map baseline (Monday):${heatMapBaselineDate.toDateString()}`);console.log(`-Days difference:${daysDiff}`);console.log(`-Calculated week index:${startWeekIndex}(Week ${startWeekIndex+1})`);console.log(`-Week range:${getWeekDateRange(startWeekIndex)}`);let hoursRemaining=totalEffortHours;const initialHours=hoursRemaining;let completionWeekIndex=-1;let finalCapacity=0;let pooledCapacityThisWeek=0;let explanation=`Ticket Effort:${totalEffortHours}hours (${ticket.size},${taskSizeDefinitions[ticket.size].days}person-days).\n`;explanation+=`Assigned:${ticket.assigned.join(',')}(${assignedCount}person(s)).\n`;if (useCommonStartDate){const commonDate=document.getElementById('common-start-date').value;explanation+=`Start Date:${formatDate(taskStartDate.toISOString().split('T')[0])}(Week ${startWeekIndex+1}) [Common Start Date].\n`;}else{explanation+=`Start Date:${formatDate(taskStartDate.toISOString().split('T')[0])}(Week ${startWeekIndex+1}).\n`;}explanation+=`Required Duration Hours (pooled):${initialHours.toFixed(1)}hours.\n`;explanation+=`Planning baseline:Week 1 starts ${formatDate(heatMapBaselineDate.toISOString().split('T')[0])}.\n\n`;let currentHoursToConsume=hoursRemaining;for (let w=startWeekIndex;w<8;w++){pooledCapacityThisWeek=0;const capacityBreakdown={};const projectReadyAssigned=ticket.assigned.filter(name=>{const person=people.find(p=>p.name===name);return person && person.isProjectReady;});const notProjectReadyAssigned=ticket.assigned.filter(name=>{const person=people.find(p=>p.name===name);return person && !person.isProjectReady;});projectReadyAssigned.forEach(name=>{const personCapacity=taskAvailabilityTracker[name] ? taskAvailabilityTracker[name][w] || 0:0;pooledCapacityThisWeek+=personCapacity;capacityBreakdown[name]=personCapacity;console.log(`ğŸ‘¤ ${name}Week ${w+1}:${personCapacity}hours available (Project Ready)`);});notProjectReadyAssigned.forEach(name=>{const personCapacity=taskAvailabilityTracker[name] ? taskAvailabilityTracker[name][w] || 0:0;capacityBreakdown[name]=`${personCapacity}(Not Contributing)`;console.log(`ğŸ‘¤ ${name}Week ${w+1}:${personCapacity}hours available (Not Project Ready-Tracked Only)`);});explanation+=`---Week ${w+1}(${getWeekDateRange(w)})---\n`;if (projectReadyAssigned.length>0){explanation+=`Project Ready Resources:${projectReadyAssigned.join(',')}\n`;}if (notProjectReadyAssigned.length>0){explanation+=`Tracked Only (Not Contributing):${notProjectReadyAssigned.join(',')}\n`;}explanation+=`Pooled Capacity:${pooledCapacityThisWeek.toFixed(1)}hours.\n`;console.log(`ğŸ“Š Week ${w+1}Total Pooled Capacity:${pooledCapacityThisWeek}hours,Need:${currentHoursToConsume}hours`);if (pooledCapacityThisWeek<=0){explanation+='No capacity this week from assigned team members. Moving to next week.\n';console.log(`â­ï¸ Week ${w+1}:No capacity,moving to next week`);continue;}if (currentHoursToConsume<=pooledCapacityThisWeek){completionWeekIndex=w;finalCapacity=currentHoursToConsume;explanation+=`Task completes this week,consuming ${currentHoursToConsume.toFixed(1)}hours of pooled capacity.\n`;console.log(`âœ… Task completes in Week ${w+1},using ${currentHoursToConsume}hours of ${pooledCapacityThisWeek}available`);let capacityUsed=currentHoursToConsume;ticket.assigned.forEach(name=>{const personCapacity=capacityBreakdown[name];if (personCapacity>0){const proportion=personCapacity/pooledCapacityThisWeek;const timeToDeduct=capacityUsed*proportion;taskAvailabilityTracker[name][w]-=timeToDeduct;explanation+=`-${name}contribution:${timeToDeduct.toFixed(1)}hours (Remaining:${taskAvailabilityTracker[name][w].toFixed(1)}).\n`;}});break;}else{currentHoursToConsume-=pooledCapacityThisWeek;explanation+=`Full capacity consumed (${pooledCapacityThisWeek.toFixed(1)}hours). Remaining hours for task:${currentHoursToConsume.toFixed(1)}.\n`;console.log(`ğŸ”„ Week ${w+1}:Used all ${pooledCapacityThisWeek}hours,${currentHoursToConsume}hours remaining`);ticket.assigned.forEach(name=>{taskAvailabilityTracker[name][w]=0;});}}let endDate;let rawEndDate=null;let isDelayed=false;if (completionWeekIndex !==-1){const baseWeekDate=new Date(taskStartDate);const weekOffset=completionWeekIndex-startWeekIndex;baseWeekDate.setDate(baseWeekDate.getDate()+(weekOffset*7));if (pooledCapacityThisWeek>0 && finalCapacity>0){const dailyPooledCapacity=pooledCapacityThisWeek/5;const businessDaysNeeded=Math.ceil(finalCapacity/dailyPooledCapacity);const completionDate=addBusinessDays(baseWeekDate,businessDaysNeeded-1);endDate=completionDate.toLocaleDateString('en-US',{month:'short',day:'numeric'});rawEndDate=completionDate;}else{const businessDayStart=getNextBusinessDay(baseWeekDate);endDate=businessDayStart.toLocaleDateString('en-US',{month:'short',day:'numeric'});rawEndDate=businessDayStart;}explanation+=`\nTask completes in Week ${completionWeekIndex+1}:${endDate}\n`;}else{explanation+='\nTask cannot complete within the 8-week planning window based on available capacity.';isDelayed=true;const estimatedDate=new Date(taskStartDate);estimatedDate.setDate(estimatedDate.getDate()+56);endDate=estimatedDate.toLocaleDateString('en-US',{month:'short',day:'numeric'});rawEndDate=estimatedDate;}return{...ticket,endDate:endDate,rawEndDate:rawEndDate,explanation:explanation,isDelayed:isDelayed};});const orderedResults=tickets.map(originalTicket=>projectedTickets.find(pt=>pt.id===originalTicket.id) || originalTicket );return orderedResults;}function calculateProjection(){const projectedTickets=getProjectedTickets();renderTickets(projectedTickets);renderWorkloadHeatMap();updateFurthestCompletionDate(projectedTickets);populateStakeholderDropdowns();populateInitiativeDropdowns();renderStakeholdersList();renderInitiativesList();}function getPersonNextAvailableDate(personName){const projectedTickets=getProjectedTickets();const today=new Date();const personTasks=projectedTickets.filter(ticket=>ticket.assigned && ticket.assigned.includes(personName) );if (personTasks.length===0){const nextBusinessDay=getNextBusinessDay(today);return{nextAvailable:nextBusinessDay,status:'Available immediately',lastTaskEnd:null};}let latestEndDate=new Date(today);let latestTaskDescription='';personTasks.forEach(task=>{if (task.rawEndDate){const taskEndDate=new Date(task.rawEndDate);if (taskEndDate>latestEndDate){latestEndDate=taskEndDate;latestTaskDescription=task.description;}}});const nextAvailable=new Date(latestEndDate);nextAvailable.setDate(nextAvailable.getDate()+1);const nextBusinessDay=getNextBusinessDay(nextAvailable);return{nextAvailable:nextBusinessDay,status:`Busy until ${latestEndDate.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})}`,lastTaskEnd:latestEndDate,lastTaskDescription:latestTaskDescription};}function showPersonAvailability(personName){const availability=getPersonNextAvailableDate(personName);const nextAvailableFormatted=availability.nextAvailable.toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric',year:'numeric'});const today=new Date();const daysFromToday=Math.ceil((availability.nextAvailable-today)/(1000*60*60*24));const daysText=daysFromToday<=0 ? 'Available now':daysFromToday===1 ? 'Available tomorrow':`Available in ${daysFromToday}days`;let message=`ğŸ‘¤ ${personName}-Availability Status\n`;message+=`${'='.repeat(40)}\n\n`;message+=`ğŸ“… Next Available:${nextAvailableFormatted}\n`;message+=`â° Timeline:${daysText}\n\n`;message+=`ğŸ“Š Current Status:${availability.status}\n`;if (availability.lastTaskDescription){message+=`ğŸ”— Last Task:"${availability.lastTaskDescription}"\n`;}message+=`\nğŸ’¡ Tip:Use this date as the start date when assigning new tasks to avoid overallocation.`;alert(message);}function updateFurthestCompletionDate(projectedTickets){const furthestDateEl=document.getElementById('furthest-completion-date');const furthestWeekEl=document.getElementById('furthest-completion-week');if (!projectedTickets || projectedTickets.length===0){furthestDateEl.textContent='No tasks';furthestWeekEl.textContent='â€”';return;}let furthestDate=null;let furthestTaskId=null;projectedTickets.forEach(ticket=>{if (ticket.rawEndDate && !ticket.isDelayed){if (!furthestDate || ticket.rawEndDate>furthestDate){furthestDate=ticket.rawEndDate;furthestTaskId=ticket.id;}}});if (furthestDate){const formattedDate=formatDate(furthestDate.toLocaleDateString('en-CA'));furthestDateEl.textContent=formattedDate;const effectiveStartDate=getEffectiveStartDate();const daysDifference=Math.ceil((furthestDate-effectiveStartDate)/(1000*60*60*24));const weekNumber=Math.ceil(daysDifference/7);furthestWeekEl.textContent=`Week ${weekNumber}`;furthestWeekEl.title=`Task #${furthestTaskId}completes in week ${weekNumber}`;}else{const hasDelayedTasks=projectedTickets.some(ticket=>ticket.isDelayed || (ticket.endDate && ticket.endDate.includes('>')));if (hasDelayedTasks){furthestDateEl.textContent='Beyond 8 weeks';furthestWeekEl.textContent='Week 8+';furthestWeekEl.title='Some tasks extend beyond the 8-week planning horizon';}else{furthestDateEl.textContent='No valid dates';furthestWeekEl.textContent='â€”';}}}function renderEffortMap(){calculateEffortMap();document.getElementById('estimation-base-display').textContent=estimationBaseHours;document.getElementById('estimation-base-hours').value=estimationBaseHours;document.getElementById('project-hours-per-day').value=projectHoursPerDay;renderTaskSizeCards();}function renderTaskSizeCards(){const container=document.getElementById('task-size-cards');if (!container) return;container.innerHTML=Object.keys(taskSizeDefinitions).map(key=>{const size=taskSizeDefinitions[key];const totalHours=size.days*estimationBaseHours;return `<div class="task-size-card"><div class="size-controls"><div class="flex justify-between items-center w-full gap-1" style="min-height:18px;"><div class="size-label-enhanced">${key}</div>${size.removable ? `<button onclick="removeTaskSize('${key}')" class="text-red-300 hover:text-red-100" style="font-size:10px;line-height:1;">âœ•</button>`:'<span style="width:10px;"></span>'}</div><input type="number" value="${size.days}" min="0.1" max="50" step="0.5" onchange="updateTaskSizeDaysEnhanced('${key}',this.value)" class="size-input-enhanced" title="${size.name}"><div class="size-metrics"><div style="font-size:9px;">${totalHours}h</div></div></div></div>`;}).join('');updateTicketSizeDropdown();}function updateEstimationBase(newHours){estimationBaseHours=parseFloat(newHours);document.getElementById('estimation-base-display').textContent=estimationBaseHours;console.log('ğŸ“Š Estimation Base Hours updated to:',estimationBaseHours);markDirty();calculateEffortMap();renderTaskSizeCards();calculateProjection();}function updateProjectHours(newHours){projectHoursPerDay=parseFloat(newHours);console.log('ğŸ“Š Project Hours/Day updated to:',projectHoursPerDay);markDirty();calculateProjection();}function updateTaskSizeDaysEnhanced(sizeKey,newDays){const days=parseFloat(newDays);if (isNaN(days) || days<=0){alert('Please enter a valid number of days');return;}backupTaskSizeDefinitions();taskSizeDefinitions[sizeKey].days=days;syncTaskSizes();calculateEffortMap();renderTaskSizeCards();updateTable();saveData();console.log(`âœ… Updated ${sizeKey}to ${days}days and backed up configuration`);}function updateTicketSizeDropdown(){const dropdown=document.getElementById('new-ticket-size');if (!dropdown) return;dropdown.innerHTML=Object.keys(taskSizeDefinitions).map(key=>{const size=taskSizeDefinitions[key];return `<option value="${key}">${size.name}(${key})</option>`;}).join('');}function updateAvailabilityHeader(){const header=document.getElementById('availability-header');if (useCommonStartDate){const commonDate=document.getElementById('common-start-date')?.value;if (commonDate){const formattedDate=formatDate(commonDate);header.textContent=`Team Availability (8 weeks from ${formattedDate})`;}else{header.textContent='Team Availability (8 weeks from common start date)';}}else{const earliestTaskDate=getEarliestTaskStartDate();if (earliestTaskDate){const formattedDate=formatDate(earliestTaskDate.toISOString().split('T')[0]);header.textContent=`Team Availability (8 weeks from ${formattedDate})`;}else{header.textContent='Team Availability (Next 8 Weeks)';}}}function updateStartDateColumnHeader(){const header=document.getElementById('start-date-column-header');if (useCommonStartDate){header.textContent='Start Date (Common)';}else{header.textContent='Start Date (Editable)';}}function populateStakeholderDropdowns(){const addTaskStakeholder=document.getElementById('new-ticket-stakeholder');if (addTaskStakeholder){addTaskStakeholder.innerHTML=stakeholders.map(sh=>`<option value="${sh}">${sh}</option>` ).join('');}populateStakeholderFilterDropdown();}function populateInitiativeDropdowns(){const addTaskInitiative=document.getElementById('new-ticket-initiative');if (addTaskInitiative){addTaskInitiative.innerHTML=initiatives.map(init=>`<option value="${init.name}">${init.name}</option>` ).join('');}populateInitiativeFilterDropdown();}function renderStakeholdersList(){const container=document.getElementById('stakeholders-list');if (!container) return;container.innerHTML=stakeholders.map(sh=>{const canRemove=sh !=='General';return `<span class="inline-flex items-center gap-1.5 px-2.5 py-1.5 bg-teal-100 text-teal-800 rounded-full text-xs font-semibold shadow-sm hover:bg-teal-200 transition">ğŸ‘¤ ${sh}${canRemove ? `<button onclick="removeStakeholder('${sh.replace(/'/g,"\\'")}')" class="text-red-600 hover:text-red-800 font-bold" title="Remove stakeholder">âœ•</button>`:`<span class="text-[10px] text-teal-600 italic">(default)</span>`}</span>`;}).join('');}function renderInitiativesList(){const container=document.getElementById('initiatives-list');if (!container) return;container.innerHTML=initiatives.map(init=>{const canRemove=init.name !=='General';const startDateDisplay=init.startDate ? formatDate(init.startDate):'(no tasks)';return `<div class="inline-flex items-center gap-1.5 px-2.5 py-1.5 bg-orange-100 text-orange-800 rounded-md text-xs shadow-sm hover:bg-orange-200 transition" title="Created:${formatDate(init.creationDate)}| Start:${startDateDisplay}"><span class="font-semibold">ğŸ“Š ${init.name}</span><span class="text-orange-600">â€¢</span><span class="text-orange-700">${startDateDisplay}</span>${canRemove ? `<button onclick="removeInitiative('${init.name.replace(/'/g,"\\'")}')" class="text-red-600 hover:text-red-800 font-bold ml-1" title="Remove initiative">âœ•</button>`:`<span class="text-[10px] text-orange-600 italic ml-1">(default)</span>`}</div>`;}).join('');}window.addStakeholder=function(){const input=document.getElementById('new-stakeholder-input');const name=input.value.trim();if (!name){alert('Please enter a stakeholder name.');return;}if (stakeholders.includes(name)){alert(`Stakeholder "${name}" already exists.`);return;}stakeholders.push(name);input.value='';markDirty();saveToLocalStorage();renderStakeholdersList();populateStakeholderDropdowns();console.log(`âœ… Added stakeholder:"${name}"`);}window.removeStakeholder=function(name){if (name==='General'){alert('Cannot remove the default "General" stakeholder.');return;}const tasksUsingStakeholder=tickets.filter(t=>t.stakeholder===name);if (tasksUsingStakeholder.length>0){const confirm=window.confirm( `âš ï¸ Warning:${tasksUsingStakeholder.length}task(s) are assigned to stakeholder "${name}".\n\n`+`These tasks will be reassigned to "General".\n\n`+`Continue?` );if (!confirm) return;tasksUsingStakeholder.forEach(task=>{task.stakeholder='General';});}stakeholders=stakeholders.filter(sh=>sh !==name);if (selectedStakeholderFilter===name){selectedStakeholderFilter='';updateFilterUI();}markDirty();saveToLocalStorage();renderStakeholdersList();populateStakeholderDropdowns();calculateProjection();console.log(`âœ… Removed stakeholder:"${name}"`);}window.addInitiative=function(){const input=document.getElementById('new-initiative-input');const name=input.value.trim();if (!name){alert('Please enter an initiative name.');return;}if (initiatives.find(init=>init.name===name)){alert(`Initiative "${name}" already exists.`);return;}initiatives.push({name:name,creationDate:getLocalDateString(new Date()),startDate:null});input.value='';markDirty();saveToLocalStorage();renderInitiativesList();populateInitiativeDropdowns();console.log(`âœ… Added initiative:"${name}"`);}window.removeInitiative=function(name){if (name==='General'){alert('Cannot remove the default "General" initiative.');return;}const tasksUsingInitiative=tickets.filter(t=>t.initiative===name);if (tasksUsingInitiative.length>0){const confirm=window.confirm( `âš ï¸ Warning:${tasksUsingInitiative.length}task(s) are assigned to initiative "${name}".\n\n`+`These tasks will be reassigned to "General".\n\n`+`Continue?` );if (!confirm) return;tasksUsingInitiative.forEach(task=>{task.initiative='General';});}initiatives=initiatives.filter(init=>init.name !==name);if (selectedInitiativeFilter===name){selectedInitiativeFilter='';updateFilterUI();}markDirty();saveToLocalStorage();renderInitiativesList();populateInitiativeDropdowns();calculateProjection();console.log(`âœ… Removed initiative:"${name}"`);}function renderPeople(){updateAvailabilityHeader();const peopleList=document.getElementById('people-list');const assignContainer=document.getElementById('new-ticket-assigned');peopleList.innerHTML='';assignContainer.innerHTML='';people.forEach((person,pIndex)=>{const card=document.createElement('div');card.className='p-4 bg-indigo-50 rounded-lg border border-indigo-200 hover:bg-indigo-100 transition-colors';let availabilityInputs='';for (let w=0;w<8;w++){const weekEnd=formatWeekEndDate(w);availabilityInputs+=`<div class="flex flex-col items-center min-w-[40px]"><label class="text-xs text-gray-600 mb-1">W${w+1}</label><label class="text-xs text-gray-500 mb-1">${weekEnd}</label><input type="number" value="${person.availability[w] || 0}" min="0" onchange="updatePersonAvailability('${person.name}',${w},this.value)" class="w-10 p-1 text-xs border border-gray-300 rounded text-center focus:border-blue-500 focus:ring-1 focus:ring-blue-200"></div>`;}const weekRangeInfo=useCommonStartDate ? ' (Based on common start date)':(getEarliestTaskStartDate() ? ' (Based on earliest task start date)':'');card.innerHTML=`<div class="flex justify-between items-start mb-3"><span class="font-bold text-indigo-800 text-base cursor-pointer hover:text-blue-600 hover:underline transition-colors" onclick="showPersonAvailability('${person.name}')" title="Click to see availability">ğŸ“… ${person.name}</span><button onclick="removePerson('${person.name}')" class="text-red-500 hover:text-red-700 transition p-1 rounded hover:bg-red-50"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div><div class="flex items-center gap-2 mb-3 px-1"><label class="flex items-center gap-1 text-sm cursor-pointer"><input type="checkbox" ${person.isProjectReady ? 'checked':''}onchange="updatePersonProjectReady('${person.name}',this.checked)" class="w-3 h-3 text-blue-600 border-gray-300 rounded focus:ring-blue-500 focus:ring-1"><span class="text-blue-700 font-medium" title="When checked,this person contributes to project delivery timelines. When unchecked,their capacity is tracked but doesn't affect completion dates.">ğŸ¯ Project Ready Resource</span></label></div><div class="overflow-x-auto"><div class="flex gap-1 text-xs min-w-max">${availabilityInputs}</div></div>${weekRangeInfo ? `<div class="text-xs text-blue-600 mt-2">${weekRangeInfo}</div>`:''}`;peopleList.appendChild(card);const checkboxWrapper=document.createElement('label');checkboxWrapper.className='flex items-center space-x-1 px-2 py-1 hover:bg-gray-100 rounded cursor-pointer';const projectReadyIndicator=person.isProjectReady ? 'ğŸ¯':'ğŸ“‹';const projectReadyTitle=person.isProjectReady ? 'Project Ready-Contributes to delivery timelines':'Tracked Only-Does not affect delivery dates';checkboxWrapper.innerHTML=`<input type="checkbox" value="${person.name}" class="w-3 h-3 text-blue-600 border-gray-300 rounded focus:ring-blue-500 focus:ring-1"><span class="text-sm cursor-pointer hover:text-blue-600 ${person.isProjectReady ? 'text-gray-700':'text-gray-500'}" onclick="event.preventDefault();showPersonAvailability('${person.name}')" title="Click to see availability-${projectReadyTitle}">${projectReadyIndicator}${person.name}</span>`;assignContainer.appendChild(checkboxWrapper);});generatePersonFilterButtons();generateStatusFilterButtons();generateDateFilterButtons();populateStakeholderFilterDropdown();populateInitiativeFilterDropdown();}function renderTickets(projectedTickets){const tbody=document.getElementById('ticket-table-body');tbody.innerHTML='';updateStartDateColumnHeader();const filteredTickets=projectedTickets.filter(ticket=>shouldShowTicket(ticket));if (filteredTickets.length===0){document.getElementById('no-tickets').classList.remove('hidden');const noTicketsMsg=document.getElementById('no-tickets');if (selectedPersonFilters.length>0 || isUnassignedFilterActive || selectedStatusFilters.length>0 || selectedDateFilters.length>0){let filterMessage='No tasks found';if (isUnassignedFilterActive){filterMessage+=` that are unassigned`;}else if (selectedPersonFilters.length>0){filterMessage+=` for ${selectedPersonFilters.join(',')}`;}if (selectedStatusFilters.length>0){if (selectedPersonFilters.length>0 || isUnassignedFilterActive) filterMessage+=' and';filterMessage+=` with status ${selectedStatusFilters.join(',')}`;}if (selectedDateFilters.length>0){if (selectedPersonFilters.length>0 || isUnassignedFilterActive || selectedStatusFilters.length>0) filterMessage+=' and';filterMessage+=` active in ${selectedDateFilters.join(',')}`;}filterMessage+='.';noTicketsMsg.textContent=filterMessage;}else{noTicketsMsg.textContent='No tasks defined. Add a task to begin!';}return;}document.getElementById('no-tickets').classList.add('hidden');filteredTickets.forEach(ticket=>{const tr=document.createElement('tr');tr.className='hover:bg-gray-50';const assignedNames=Array.isArray(ticket.assigned) ? ticket.assigned.map(n=>n.trim().replace(/^"|"$/g,'').toLowerCase()):[];const assignmentCheckboxes=people.map(p=>{const normalizedPersonName=p.name.trim().replace(/^"|"$/g,'').toLowerCase();const isChecked=assignedNames.includes(normalizedPersonName);return `<label class="flex items-center space-x-1 text-xs whitespace-nowrap"><input type="checkbox" value="${p.name}" ${isChecked ? 'checked':''}onchange="handleAssignmentCheckboxChange(this,${ticket.id})" class="w-3 h-3 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"><span class="text-gray-700 cursor-pointer hover:text-blue-600" onclick="event.preventDefault();showPersonAvailability('${p.name}')" title="Click to see availability">ğŸ“… ${p.name}</span></label>`;}).join('');const sizeOptions=Object.keys(taskSizeDefinitions).map(key=>{const size=taskSizeDefinitions[key];const isSelected=ticket.size===key;return `<option value="${key}" ${isSelected ? 'selected':''}>${size.name}(${key})</option>`;}).join('');const priorityOptions=['P1','P2','P3','P4','P5'].map(priority=>{const isSelected=(ticket.priority || 'P3')===priority;return `<option value="${priority}" ${isSelected ? 'selected':''}>${priority}</option>`;}).join('');const completionDateClass=ticket.isDelayed ? 'bg-red-100 text-red-700 font-bold p-1 rounded':'text-green-600 font-semibold';let displayStartDate;let startDateInput='';if (useCommonStartDate){const commonDate=document.getElementById('common-start-date').value;displayStartDate=formatDate(commonDate)+' ğŸ”—';startDateInput=`<span class="text-gray-500 text-sm">${displayStartDate}</span>`;}else{startDateInput=`<input type="date" value="${ticket.startDate || ''}" onchange="handleStartDateChange(this,${ticket.id})" class="w-full p-1 border border-gray-300 rounded-lg text-xs bg-white" title="Change task start date">`;}const taskTypeIcon=(ticket.isFixedLength===false) ? 'âš¡':'ğŸ”’';const taskTypeTitle=(ticket.isFixedLength===false) ? 'Flexible Task (click to change to Fixed-Length)':'Fixed-Length Task (click to change to Flexible)';const stakeholderOptions=stakeholders.map(sh=>{const isSelected=(ticket.stakeholder || 'General')===sh;return `<option value="${sh}" ${isSelected ? 'selected':''}>${sh}</option>`;}).join('');const initiativeOptions=initiatives.map(init=>{const isSelected=(ticket.initiative || 'General')===init.name;return `<option value="${init.name}" ${isSelected ? 'selected':''}>${init.name}</option>`;}).join('');tr.innerHTML=`<td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${ticket.id}</td><td class="px-3 py-2 text-sm text-gray-900 w-1/3"><span class="cursor-pointer hover:opacity-70 transition-opacity" title="${taskTypeTitle}" onclick="toggleTaskType(${ticket.id})" style="font-size:1.2em;user-select:none;">${taskTypeIcon}</span>${ticket.description}</td><td class="px-3 py-2 whitespace-nowrap text-sm text-gray-600">${startDateInput}</td><td class="px-3 py-2 whitespace-nowrap text-sm font-medium"><select class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white text-indigo-600 font-semibold" onchange="handleSizeChange(this,${ticket.id})" title="Change task size" style="min-width:100px;font-size:13px;">${sizeOptions}</select></td><td class="px-3 py-2 whitespace-nowrap text-center"><div class="flex items-center justify-center gap-2"><span style="font-size:1.2em;">${taskTypeIcon}</span><label class="flex items-center cursor-pointer" title="Check for Flexible,uncheck for Fixed-Length"><input type="checkbox" ${ticket.isFixedLength===false ? 'checked':''}onchange="toggleTaskType(${ticket.id})" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"><span class="ml-1 text-xs text-gray-600">Flex</span></label></div></td><td class="px-3 py-2 whitespace-nowrap text-sm font-medium"><select class="w-full p-1 border border-gray-300 rounded-lg text-xs bg-white text-purple-600 font-medium" onchange="handlePriorityChange(this,${ticket.id})" title="Change task priority">${priorityOptions}</select></td><td class="px-3 py-2 whitespace-nowrap text-sm font-medium"><span class="status-badge ${getStatusClass(ticket.status || 'To Do')}" onclick="cycleTaskStatus(${ticket.id})" oncontextmenu="handleStatusRightClick(event,${ticket.id})" data-ticket-id="${ticket.id}" title="Click to change status">${getStatusDisplayWithComments(ticket)}</span></td><td class="px-3 py-2 whitespace-nowrap text-sm font-medium"><select class="w-full p-1 border border-gray-300 rounded-lg text-xs bg-white text-teal-600 font-medium" onchange="handleStakeholderChange(this,${ticket.id})" title="Change stakeholder">${stakeholderOptions}</select></td><td class="px-3 py-2 whitespace-nowrap text-sm font-medium"><select class="w-full p-1 border border-gray-300 rounded-lg text-xs bg-white text-orange-600 font-medium" onchange="handleInitiativeChange(this,${ticket.id})" title="Change initiative">${initiativeOptions}</select></td><td class="px-3 py-2 text-sm text-gray-500 w-1/4"><div class="flex flex-wrap gap-1 min-h-[40px] items-center">${assignmentCheckboxes}</div></td><td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900"><div class="flex items-center"><span class="${completionDateClass}">${ticket.endDate}</span>${ticket.customEndDate ? '<span class="ml-1 text-xs text-blue-600" title="Custom deadline set">ğŸ“…</span>':''}<button onclick="showCalculationDetails(${ticket.id})" class="details-btn" title="Show calculation details">Details</button></div></td><td class="px-3 py-2 whitespace-nowrap text-right text-sm font-medium"><div class="flex items-center justify-end gap-2"><button onclick="openTaskDetailsModal(${ticket.id})" class="${ticket.taskDetails && (ticket.taskDetails.description || ticket.taskDetails.positives || ticket.taskDetails.negatives) ? 'text-blue-600 hover:text-blue-800':'text-gray-400 hover:text-gray-600'}transition" title="Edit task details"><span style="font-size:1.2em;">ğŸ“</span></button><button onclick="removeTicket(${ticket.id})" class="text-red-500 hover:text-red-700 transition" title="Delete task"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div></td>`;tbody.appendChild(tr);const statusBadge=tr.querySelector('.status-badge');if (statusBadge && ticket.status==='Paused' && ticket.pauseComments && ticket.pauseComments.length>0){const latestComment=ticket.pauseComments[ticket.pauseComments.length-1];let tooltip='Left click:Change status\nRight click:Edit latest comment\n\nLatest pause reason:\n"'+latestComment.comment+'"\n('+latestComment.timestamp+')';if (ticket.pauseComments.length>1){tooltip+='\n\n'+ticket.pauseComments.length+' total pause comments';}statusBadge.title=tooltip;console.log(`ğŸ·ï¸ Set tooltip for ticket ${ticket.id}:`,tooltip);}else if (statusBadge && ticket.status==='Paused'){statusBadge.title='Left click:Change status\nRight click:Add pause comment';}});updateExportButtonsState();}window.exportData=()=>{const projectedTickets=getProjectedTickets();if (projectedTickets.length===0){alert("No tickets to export.");return;}let csvContent="Ticket ID,Description,Start Date,Size,Priority,Status,Task Type,Pause Comments,Person Days,Total Hours,Assigned Team,Projected End Date,Detailed Explanation,Details:Description,Details:Positives,Details:Negatives\n";projectedTickets.forEach(ticket=>{const totalHours=effortMap[ticket.size] || 0;const personDays=taskSizeDefinitions[ticket.size]?.days || 0;const escapeCSV=(value)=>`"${String(value).replace(/"/g,'""')}"`;const pauseCommentsText=ticket.pauseComments && ticket.pauseComments.length>0 ? ticket.pauseComments.map(pc=>`[${pc.timestamp}] ${pc.comment}`).join(' | '):'';const isFixedLength=ticket.isFixedLength !==false;const taskType=isFixedLength ? 'Fixed':'Flexible';const taskDetails=ticket.taskDetails ||{};const detailsDescription=escapeCSV(taskDetails.description || '');const detailsPositives=escapeCSV(taskDetails.positives || '');const detailsNegatives=escapeCSV(taskDetails.negatives || '');const row=[ ticket.id,escapeCSV(ticket.description),formatDate(ticket.startDate),ticket.size,ticket.priority || 'P3',escapeCSV(ticket.status || 'To Do'),taskType,escapeCSV(pauseCommentsText),personDays,totalHours,escapeCSV(ticket.assigned.join(';')),ticket.endDate.replace(/,/g,''),escapeCSV(ticket.explanation.replace(/\n/g,' | ')),detailsDescription,detailsPositives,detailsNegatives ].join(',');csvContent+=row+"\n";});const blob=new Blob([csvContent],{type:'text/csv;charset=utf-8;'});const link=document.createElement("a");const url=URL.createObjectURL(blob);link.setAttribute("href",url);link.setAttribute("download",`project_schedule_${new Date().toISOString().slice(0,10)}.csv`);link.style.visibility='hidden';document.body.appendChild(link);link.click();document.body.removeChild(link);}function updateExportButtonsState(){const closedTickets=tickets.filter(ticket=>(ticket.status || 'To Do')==='Closed');const exportClosedBtn=document.getElementById('export-closed-btn');if (exportClosedBtn){if (closedTickets.length>0 && !closedItemsExported){exportClosedBtn.disabled=false;exportClosedBtn.classList.remove('opacity-50','cursor-not-allowed');}else if (closedTickets.length===0){exportClosedBtn.disabled=true;exportClosedBtn.classList.add('opacity-50','cursor-not-allowed');}}}window.exportClosedItems=()=>{const timestamp=new Date().toISOString().slice(0,19).replace('T','_').replace(/:/g,'-');const closedTickets=tickets.filter(ticket=>(ticket.status || 'To Do')==='Closed');if (closedTickets.length===0){return;}const configData={metadata:{exportDate:new Date().toISOString(),version:'2.0',description:'Enterprise Project Tracking Console Configuration Export-Closed Items'},settings:{estimationBaseHours:estimationBaseHours,projectHoursPerDay:projectHoursPerDay,useCommonStartDate:useCommonStartDate,commonStartDate:document.getElementById('common-start-date')?.value || '',currentTicketId:currentTicketId},taskSizeDefinitions:taskSizeDefinitions,people:people,tickets:closedTickets};let csvContent='';csvContent+="SECTION,METADATA\n";csvContent+="Key,Value\n";csvContent+=`Export Date,${configData.metadata.exportDate}\n`;csvContent+=`Version,${configData.metadata.version}\n`;csvContent+=`Description,${configData.metadata.description}\n`;csvContent+="\n";csvContent+="SECTION,SETTINGS\n";csvContent+="Key,Value\n";csvContent+=`Estimation Base Hours,${configData.settings.estimationBaseHours}\n`;csvContent+=`Project Hours Per Day,${configData.settings.projectHoursPerDay}\n`;csvContent+=`Use Common Start Date,${configData.settings.useCommonStartDate}\n`;csvContent+=`Common Start Date,${configData.settings.commonStartDate}\n`;csvContent+=`Current Ticket ID,${configData.settings.currentTicketId}\n`;csvContent+="\n";csvContent+="SECTION,TASK_SIZES\n";csvContent+="Size Key,Name,Days,Removable\n";Object.keys(configData.taskSizeDefinitions).forEach(key=>{const size=configData.taskSizeDefinitions[key];csvContent+=`${key},"${size.name}",${size.days},${size.removable}\n`;});csvContent+="\n";csvContent+="SECTION,PEOPLE\n";csvContent+="Name,Week1,Week2,Week3,Week4,Week5,Week6,Week7,Week8,Project Ready\n";configData.people.forEach(person=>{const availability=[...person.availability];while (availability.length<8){availability.push(25);}const isProjectReady=person.isProjectReady !==undefined ? person.isProjectReady:true;csvContent+=`"${person.name}",${availability.slice(0,8).join(',')},${isProjectReady ? 'Yes':'No'}\n`;});csvContent+="\n";csvContent+="SECTION,TICKETS\n";csvContent+="ID,Description,Start Date,Size,Priority,Assigned Team,Status,Task Type,Pause Comments,Start Date History,End Date History,Size History,Custom End Date,Details:Description,Details:Positives,Details:Negatives\n";configData.tickets.forEach(ticket=>{const assignedTeam=ticket.assigned.join(';');const priority=ticket.priority || 'P3';const status=ticket.status || 'Closed';const isFixedLength=ticket.isFixedLength !==false;const taskType=isFixedLength ? 'Fixed':'Flexible';const pauseCommentsText=ticket.pauseComments && ticket.pauseComments.length>0 ? ticket.pauseComments.map(pc=>`[${pc.timestamp}] ${pc.comment}`).join(' | '):'';const startDateHistoryText=ticket.startDateHistory && ticket.startDateHistory.length>0 ? ticket.startDateHistory.map(entry=>`${entry.date}(${entry.reason}@${entry.timestamp})` ).join(' | '):'';const endDateHistoryText=ticket.endDateHistory && ticket.endDateHistory.length>0 ? ticket.endDateHistory.map(entry=>`${entry.date}(${entry.reason}@${entry.timestamp})` ).join(' | '):'';const sizeHistoryText=ticket.sizeHistory && ticket.sizeHistory.length>0 ? ticket.sizeHistory.map(entry=>`${entry.size}:${entry.days}d(${entry.reason}@${entry.timestamp})` ).join(' | '):'';const customEndDate=ticket.customEndDate || '';const taskDetails=ticket.taskDetails ||{};const detailsDescription=(taskDetails.description || '').replace(/"/g,'""');const detailsPositives=(taskDetails.positives || '').replace(/"/g,'""');const detailsNegatives=(taskDetails.negatives || '').replace(/"/g,'""');csvContent+=`${ticket.id},"${ticket.description.replace(/"/g,'""')}",${ticket.startDate},${ticket.size},${priority},"${assignedTeam}","${status}","${taskType}","${pauseCommentsText}","${startDateHistoryText}","${endDateHistoryText}","${sizeHistoryText}","${customEndDate}","${detailsDescription}","${detailsPositives}","${detailsNegatives}"\n`;});const blob=new Blob([csvContent],{type:'text/csv;charset=utf-8;'});const link=document.createElement("a");const url=URL.createObjectURL(blob);link.setAttribute("href",url);link.setAttribute("download",`project_config_closed_${timestamp}.csv`);link.style.visibility='hidden';document.body.appendChild(link);link.click();document.body.removeChild(link);closedItemsExported=true;const exportClosedBtn=document.getElementById('export-closed-btn');if (exportClosedBtn){exportClosedBtn.disabled=true;exportClosedBtn.classList.add('opacity-50','cursor-not-allowed');}alert(`âœ… Closed items exported successfully!\n\nFile:project_config_closed_${timestamp}.csv\n\nNow you can click "Export Config" to export active tasks.`);}window.exportConfiguration=()=>{const closedTickets=tickets.filter(ticket=>(ticket.status || 'To Do')==='Closed');if (closedTickets.length>0 && !closedItemsExported){alert('âš ï¸ Please export closed items first!\n\nClick the "Export Closed" button before exporting the configuration.\n\nThis prevents the browser from blocking multiple file downloads.');return;}const timestamp=new Date().toISOString().slice(0,19).replace('T','_').replace(/:/g,'-');const configData={metadata:{exportDate:new Date().toISOString(),version:'2.0',description:'Enterprise Project Tracking Console Configuration Export'},settings:{estimationBaseHours:estimationBaseHours,projectHoursPerDay:projectHoursPerDay,useCommonStartDate:useCommonStartDate,commonStartDate:document.getElementById('common-start-date')?.value || '',currentTicketId:currentTicketId},taskSizeDefinitions:taskSizeDefinitions,people:people,tickets:tickets};let csvContent='';csvContent+="SECTION,METADATA\n";csvContent+="Key,Value\n";csvContent+=`Export Date,${configData.metadata.exportDate}\n`;csvContent+=`Version,${configData.metadata.version}\n`;csvContent+=`Description,${configData.metadata.description}\n`;csvContent+="\n";csvContent+="SECTION,SETTINGS\n";csvContent+="Key,Value\n";csvContent+=`Estimation Base Hours,${configData.settings.estimationBaseHours}\n`;csvContent+=`Project Hours Per Day,${configData.settings.projectHoursPerDay}\n`;csvContent+=`Use Common Start Date,${configData.settings.useCommonStartDate}\n`;csvContent+=`Common Start Date,${configData.settings.commonStartDate}\n`;csvContent+=`Current Ticket ID,${configData.settings.currentTicketId}\n`;csvContent+="\n";csvContent+="SECTION,TASK_SIZES\n";csvContent+="Size Key,Name,Days,Removable\n";Object.keys(configData.taskSizeDefinitions).forEach(key=>{const size=configData.taskSizeDefinitions[key];csvContent+=`${key},"${size.name}",${size.days},${size.removable}\n`;});csvContent+="\n";csvContent+="SECTION,PEOPLE\n";csvContent+="Name,Week1,Week2,Week3,Week4,Week5,Week6,Week7,Week8,Project Ready\n";configData.people.forEach(person=>{const availability=[...person.availability];while (availability.length<8){availability.push(25);}const isProjectReady=person.isProjectReady !==undefined ? person.isProjectReady:true;csvContent+=`"${person.name}",${availability.slice(0,8).join(',')},${isProjectReady ? 'Yes':'No'}\n`;});csvContent+="\n";csvContent+="SECTION,STAKEHOLDERS\n";csvContent+="Name\n";stakeholders.forEach(sh=>{csvContent+=`"${sh}"\n`;});csvContent+="\n";csvContent+="SECTION,INITIATIVES\n";csvContent+="Name,Creation Date,Start Date\n";initiatives.forEach(init=>{csvContent+=`"${init.name}",${init.creationDate},${init.startDate || ''}\n`;});csvContent+="\n";csvContent+="SECTION,TICKETS\n";csvContent+="UUID,ID,Description,Start Date,Size,Priority,Stakeholder,Initiative,Assigned Team,Status,Task Type,Pause Comments,Start Date History,End Date History,Size History,Custom End Date,Details:Description,Details:Positives,Details:Negatives\n";configData.tickets.filter(ticket=>(ticket.status || 'To Do') !=='Closed').forEach(ticket=>{const uuid=ticket.uuid || generateUUID();const stakeholder=(ticket.stakeholder || 'General').replace(/"/g,'""');const initiative=(ticket.initiative || 'General').replace(/"/g,'""');const assignedTeam=ticket.assigned.join(';');const priority=ticket.priority || 'P3';const status=ticket.status || 'To Do';const isFixedLength=ticket.isFixedLength !==false;const taskType=isFixedLength ? 'Fixed':'Flexible';const pauseCommentsText=ticket.pauseComments && ticket.pauseComments.length>0 ? ticket.pauseComments.map(pc=>`[${pc.timestamp}] ${pc.comment}`).join(' | '):'';const startDateHistoryText=ticket.startDateHistory && ticket.startDateHistory.length>0 ? ticket.startDateHistory.map(entry=>`${entry.date}(${entry.reason}@${entry.timestamp})` ).join(' | '):'';const endDateHistoryText=ticket.endDateHistory && ticket.endDateHistory.length>0 ? ticket.endDateHistory.map(entry=>`${entry.date}(${entry.reason}@${entry.timestamp})` ).join(' | '):'';const sizeHistoryText=ticket.sizeHistory && ticket.sizeHistory.length>0 ? ticket.sizeHistory.map(entry=>`${entry.size}:${entry.days}d(${entry.reason}@${entry.timestamp})` ).join(' | '):'';const customEndDate=ticket.customEndDate || '';const taskDetails=ticket.taskDetails ||{};const detailsDescription=(taskDetails.description || '').replace(/"/g,'""');const detailsPositives=(taskDetails.positives || '').replace(/"/g,'""');const detailsNegatives=(taskDetails.negatives || '').replace(/"/g,'""');csvContent+=`${uuid},${ticket.id},"${ticket.description.replace(/"/g,'""')}",${ticket.startDate},${ticket.size},${priority},"${stakeholder}","${initiative}","${assignedTeam}","${status}","${taskType}","${pauseCommentsText}","${startDateHistoryText}","${endDateHistoryText}","${sizeHistoryText}","${customEndDate}","${detailsDescription}","${detailsPositives}","${detailsNegatives}"\n`;});const blob=new Blob([csvContent],{type:'text/csv;charset=utf-8;'});const link=document.createElement("a");const url=URL.createObjectURL(blob);link.setAttribute("href",url);link.setAttribute("download",`project_config_${timestamp}.csv`);link.style.visibility='hidden';document.body.appendChild(link);link.click();document.body.removeChild(link);markClean();closedItemsExported=false;const hasClosedItems=tickets.some(ticket=>(ticket.status || 'To Do')==='Closed');const exportClosedBtn=document.getElementById('export-closed-btn');if (exportClosedBtn && hasClosedItems){exportClosedBtn.disabled=false;exportClosedBtn.classList.remove('opacity-50','cursor-not-allowed');}alert(`âœ… Configuration exported successfully!\n\nFile:project_config_${timestamp}.csv\n\nThis file contains all active and non-closed tasks.\n\nUse "Import Config" to restore this configuration later.`);}window.updateTaskStartDate=function(taskId,newDate){const ticket=tickets.find(t=>t.id===taskId);if (ticket && newDate){const oldDate=ticket.startDate;ticket.startDate=newDate;trackStartDateChange(ticket,oldDate,newDate,'Changed from heat map popup');recalculateAllInitiativeStartDates();markDirty();saveToLocalStorage();immediateRender();const modal=document.getElementById('week-task-modal');if (!modal.classList.contains('hidden')){const title=document.getElementById('modal-title').textContent;const match=title.match(/^(.*)-Week (\d+)/);if (match){const personName=match[1].trim();const weekIndex=parseInt(match[2],10)-1;const rangeMatch=title.match(/\(([^-]+)-([^)]+)\)/);if (rangeMatch){const weekStart=rangeMatch[1].trim();const weekEnd=rangeMatch[2].trim();showWeekTaskDetails(personName,weekIndex,weekStart,weekEnd);}}}console.log(`âœ… V10:Task #${taskId}start date updated and synced to table:${oldDate}â†’ ${newDate}`);}}window.updateTaskAssignment=function(taskId,personName,isChecked,weekIndex){const ticket=tickets.find(t=>t.id===taskId);if (!ticket){console.log('updateTaskAssignment:Ticket not found for id',taskId);return;}let assigned=Array.isArray(ticket.assigned) ? [...ticket.assigned]:[];if (isChecked){if (!assigned.includes(personName)){assigned.push(personName);}}else{assigned=assigned.filter(n=>n !==personName);}ticket.assigned=assigned;console.log('updateTaskAssignment:',{taskId,personName,isChecked,assigned});saveToLocalStorage();updateTable();renderWorkloadHeatMap();const modal=document.getElementById('week-task-modal');if (!modal.classList.contains('hidden')){const title=document.getElementById('modal-title').textContent;const match=title.match(/^(.*)-Week (\d+)/);if (match){const personName=match[1].trim();const weekIndex=parseInt(match[2],10)-1;const rangeMatch=title.match(/\(([^-]+)-([^)]+)\)/);if (rangeMatch){const weekStart=rangeMatch[1].trim();const weekEnd=rangeMatch[2].trim();showWeekTaskDetails(personName,weekIndex,weekStart,weekEnd);}}}console.log('Updated ticket:',ticket);}window.triggerImport=()=>{const fileInput=document.getElementById('import-config-file');fileInput.click();}window.handleConfigImport=(event)=>{const file=event.target.files[0];if (!file) return;if (!file.name.endsWith('.csv')){alert('âŒ Please select a CSV configuration file.');return;}const reader=new FileReader();reader.onload=function(e){try{const csvContent=e.target.result;importConfiguration(csvContent);}catch (error){alert(`âŒ Error reading file:${error.message}`);}};reader.readAsText(file);event.target.value='';}function importConfiguration(csvContent){const lines=csvContent.split('\n').map(line=>line.trim()).filter(line=>line);let currentSection='';let importedData={settings:{},taskSizeDefinitions:{},people:[],tickets:[],stakeholders:['General'],initiatives:[{name:'General',creationDate:getLocalDateString(new Date()),startDate:null}]};let skipHeader=false;for (let i=0;i<lines.length;i++){const line=lines[i];if (line.startsWith('SECTION,')){currentSection=line.split(',')[1];skipHeader=true;continue;}if (skipHeader){skipHeader=false;continue;}if (!line) continue;try{if (currentSection==='SETTINGS'){const [key,value]=parseCSVLine(line);if (key==='Estimation Base Hours') importedData.settings.estimationBaseHours=parseInt(value);else if (key==='Project Hours Per Day') importedData.settings.projectHoursPerDay=parseInt(value);else if (key==='Hours Per Day') importedData.settings.projectHoursPerDay=parseInt(value);else if (key==='Use Common Start Date') importedData.settings.useCommonStartDate=value==='true';else if (key==='Common Start Date') importedData.settings.commonStartDate=value;else if (key==='Current Ticket ID') importedData.settings.currentTicketId=parseInt(value);}else if (currentSection==='TASK_SIZES'){const [sizeKey,name,days,removable]=parseCSVLine(line);importedData.taskSizeDefinitions[sizeKey]={name:name,days:parseFloat(days),removable:removable==='true'};}else if (currentSection==='STAKEHOLDERS'){const parsed=parseCSVLine(line);const stakeholderName=parsed[0];if (stakeholderName && stakeholderName.trim()){if (importedData.stakeholders.length===1 && importedData.stakeholders[0]==='General'){importedData.stakeholders=[];}importedData.stakeholders.push(stakeholderName);}}else if (currentSection==='INITIATIVES'){const parsed=parseCSVLine(line);const [name,creationDate,startDate]=parsed;if (name && name.trim()){if (importedData.initiatives.length===1 && importedData.initiatives[0].name==='General'){importedData.initiatives=[];}importedData.initiatives.push({name:name,creationDate:creationDate || getLocalDateString(new Date()),startDate:(startDate && startDate.trim()) ? startDate:null});}}else if (currentSection==='PEOPLE'){const parsed=parseCSVLine(line);const name=parsed[0];const availabilityValues=parsed.slice(1,-1).map(val=>parseInt(val) || 0);const isProjectReady=parsed.length>9 ? (parsed[parsed.length-1]==='true' || parsed[parsed.length-1]==='Yes'):true;while (availabilityValues.length<8){const lastValue=availabilityValues[availabilityValues.length-1] || 25;availabilityValues.push(lastValue);}if (availabilityValues.length>8){availabilityValues.length=8;}importedData.people.push({name:name,availability:availabilityValues,isProjectReady:isProjectReady});}else if (currentSection==='TICKETS'){const columns=parseCSVLine(line);let uuid,id,description,startDate,size,priority,stakeholder,initiative,assignedTeam,status,taskType,pauseComments,startDateHistory,endDateHistory,sizeHistory,customEndDate,detailsDescription,detailsPositives,detailsNegatives;const firstCol=columns[0];const isV10Format=firstCol && firstCol.includes('-');if (isV10Format){[uuid,id,description,startDate,size,priority,stakeholder,initiative,assignedTeam,status,taskType,pauseComments,startDateHistory,endDateHistory,sizeHistory,customEndDate,detailsDescription,detailsPositives,detailsNegatives]=columns;}else{[id,description,startDate,size,priority,assignedTeam,status,taskType,pauseComments,startDateHistory,endDateHistory,sizeHistory,customEndDate,detailsDescription,detailsPositives,detailsNegatives]=columns;uuid=generateUUID();stakeholder='General';initiative='General';}const assigned=assignedTeam ? assignedTeam.split(';').map(name=>name.trim().replace(/^"|"$/g,'')).filter(name=>name):[];let isFixedLength=true;if (taskType){const taskTypeNormalized=taskType.trim().toLowerCase();if (taskTypeNormalized==='flexible' || taskTypeNormalized==='flex'){isFixedLength=false;}}const parsedPauseComments=[];if (pauseComments && pauseComments.trim()){const commentEntries=pauseComments.split(' | ');commentEntries.forEach(entry=>{const match=entry.match(/^\[([^\]]+)\] (.+)$/);if (match){parsedPauseComments.push({timestamp:match[1],comment:match[2]});}});}const parsedStartDateHistory=[];if (startDateHistory && startDateHistory.trim()){const historyEntries=startDateHistory.split(' | ');historyEntries.forEach(entry=>{const match=entry.match(/^([^(]+)\(([^@]+)@([^)]+)\)$/);if (match){parsedStartDateHistory.push({date:match[1],reason:match[2],timestamp:match[3]});}});}const parsedEndDateHistory=[];if (endDateHistory && endDateHistory.trim()){const historyEntries=endDateHistory.split(' | ');historyEntries.forEach(entry=>{const match=entry.match(/^([^(]+)\(([^@]+)@([^)]+)\)$/);if (match){parsedEndDateHistory.push({date:match[1],reason:match[2],timestamp:match[3]});}});}const parsedSizeHistory=[];if (sizeHistory && sizeHistory.trim()){const historyEntries=sizeHistory.split(' | ');historyEntries.forEach(entry=>{const match=entry.match(/^([^:]+):(\d+)d\(([^@]+)@([^)]+)\)$/);if (match){parsedSizeHistory.push({size:match[1],days:parseInt(match[2]),reason:match[3],timestamp:match[4]});}});}const ticket={uuid:uuid || generateUUID(),id:parseInt(id),description:description,startDate:startDate,size:size,priority:priority || 'P3',stakeholder:stakeholder || 'General',initiative:initiative || 'General',assigned:assigned,status:status || 'To Do',isFixedLength:isFixedLength,pauseComments:parsedPauseComments,startDateHistory:parsedStartDateHistory,endDateHistory:parsedEndDateHistory,sizeHistory:parsedSizeHistory,customEndDate:(customEndDate && customEndDate.trim()) ? customEndDate:undefined};if (detailsDescription || detailsPositives || detailsNegatives){ticket.taskDetails={description:detailsDescription || '',positives:detailsPositives || '',negatives:detailsNegatives || ''};}importedData.tickets.push(ticket);}}catch (error){console.warn(`Skipping invalid line in ${currentSection}:${line}`);}}if (!validateImportedData(importedData)){alert('âŒ Invalid configuration file. Please check the file format and try again.');return;}const confirmMessage=`ğŸ“‹ Import Configuration\n\nFound:\nâ€¢ ${Object.keys(importedData.taskSizeDefinitions).length}task size definitions\nâ€¢ ${importedData.people.length}team members\nâ€¢ ${importedData.stakeholders.length}stakeholders\nâ€¢ ${importedData.initiatives.length}initiatives\nâ€¢ ${importedData.tickets.length}tickets\n\nâš ï¸ This will replace ALL current data!\n\nContinue with import?`;if (!confirm(confirmMessage)){return;}try{estimationBaseHours=importedData.settings.estimationBaseHours || 5;projectHoursPerDay=importedData.settings.projectHoursPerDay || importedData.settings.hoursPerDay || 8;useCommonStartDate=importedData.settings.useCommonStartDate || false;currentTicketId=importedData.settings.currentTicketId || 1;console.log('ğŸ”„ IMPORT:About to replace taskSizeDefinitions');console.log('ğŸ”„ IMPORT:Current taskSizeDefinitions:',taskSizeDefinitions);console.log('ğŸ”„ IMPORT:Incoming taskSizeDefinitions:',importedData.taskSizeDefinitions);taskSizeDefinitions=importedData.taskSizeDefinitions;console.log('ğŸ”„ IMPORT:After replacement:',taskSizeDefinitions);people=importedData.people;people.forEach(person=>{if (person.isProjectReady===undefined){person.isProjectReady=true;}});stakeholders=importedData.stakeholders;initiatives=importedData.initiatives;console.log('ğŸ”„ V10 IMPORT:Stakeholders:',stakeholders);console.log('ğŸ”„ V10 IMPORT:Initiatives:',initiatives);tickets=importedData.tickets;tickets=tickets.map(ticket=>{ticket=initializeStartDateHistory(ticket);ticket=initializeEndDateHistory(ticket);ticket=initializeSizeHistory(ticket);return ticket;});recalculateAllInitiativeStartDates();console.log('ğŸ”„ V10 IMPORT:Initiative start dates recalculated');console.log('ğŸ” People after import:',JSON.stringify(people,null,2));console.log('ğŸ” Tickets after import:',JSON.stringify(tickets,null,2));const closedTickets=tickets.filter(t=>(t.status || 'To Do')==='Closed');closedTickets.forEach(t=>{console.log(`ğŸ” Closed Ticket ${t.id}assigned:`,t.assigned);});if (people.length===0){alert('âŒ No people imported! Please check the PEOPLE section of your configuration CSV. Assigned people will not display unless team members are imported.');}if (Object.keys(taskSizeDefinitions).length===0){alert('âš ï¸ No task sizes imported! Please check the TASK_SIZES section of your configuration CSV.');}selectedPersonFilters=[];selectedStatusFilters=[];selectedDateFilters=[];document.getElementById('estimation-base-hours').value=estimationBaseHours;document.getElementById('project-hours-per-day').value=projectHoursPerDay;document.getElementById('estimation-base-display').textContent=estimationBaseHours;document.getElementById('use-common-start-date').checked=useCommonStartDate;if (importedData.settings.commonStartDate){document.getElementById('common-start-date').value=importedData.settings.commonStartDate;}if (useCommonStartDate){toggleCommonStartDate();}syncTaskSizes();calculateEffortMap();renderEffortMap();renderPeople();calculateProjection();updateFilterUI();saveToLocalStorage();markClean();alert(`âœ… Configuration imported successfully (V10)!\n\nâ€¢ ${Object.keys(taskSizeDefinitions).length}task sizes loaded\nâ€¢ ${people.length}team members configured\nâ€¢ ${stakeholders.length}stakeholders loaded\nâ€¢ ${initiatives.length}initiatives loaded\nâ€¢ ${tickets.length}tickets imported\n\nAll data has been restored and calculations updated.`);}catch (error){alert(`âŒ Error applying configuration:${error.message}\n\nPlease check your file and try again.`);}}function parseCSVLine(line){const result=[];let current='';let inQuotes=false;for (let i=0;i<line.length;i++){const char=line[i];if (char==='"' && (i===0 || line[i-1]===',')){inQuotes=true;}else if (char==='"' && inQuotes && (i===line.length-1 || line[i+1]===',')){inQuotes=false;}else if (char===',' && !inQuotes){result.push(current.trim());current='';}else{current+=char;}}result.push(current.trim());return result;}function validateImportedData(data){if (!data.settings || !data.taskSizeDefinitions || !data.people || !data.tickets){return false;}for (const person of data.people){if (!person.name || !Array.isArray(person.availability) || person.availability.length !==8){return false;}}for (const ticket of data.tickets){if (!ticket.id || !ticket.description || !ticket.size || !Array.isArray(ticket.assigned)){return false;}}return true;}window.triggerTaskImport=()=>{const fileInput=document.getElementById('import-tasks-file');fileInput.click();}window.handleTaskImport=(event)=>{const file=event.target.files[0];if (!file) return;if (!file.name.endsWith('.csv')){alert('âŒ Please select a CSV file with tasks.');return;}const reader=new FileReader();reader.onload=function(e){try{const csvContent=e.target.result;importTasksFromCSV(csvContent);}catch (error){alert(`âŒ Error reading file:${error.message}`);}};reader.readAsText(file);event.target.value='';}function importTasksFromCSV(csvContent){const lines=csvContent.split('\n').map(line=>line.trim()).filter(line=>line);if (lines.length===0){alert('âŒ The CSV file appears to be empty.');return;}const newTasks=[];let hasHeader=false;const firstLine=lines[0].toLowerCase();if (firstLine.includes('task') || firstLine.includes('description') || firstLine.includes('name')){hasHeader=true;}const startIndex=hasHeader ? 1:0;for (let i=startIndex;i<lines.length;i++){const line=lines[i];if (!line) continue;let taskName=line.replace(/^"(.*)"$/,'$1').replace(/""/g,'"').trim();if (!taskName) continue;if (taskName.length>200){console.warn(`Task name too long,truncating:${taskName.substring(0,50)}...`);taskName=taskName.substring(0,200);}newTasks.push(taskName);}if (newTasks.length===0){alert('âŒ No valid tasks found in the CSV file.\n\nExpected format:\nâ€¢ One task per line\nâ€¢ Optional header row\nâ€¢ Task names in first column');return;}const previewTasks=newTasks.slice(0,5);const previewText=previewTasks.join('\n');const moreText=newTasks.length>5 ? `\n... and ${newTasks.length-5}more tasks`:'';const confirmMessage=`ğŸ“‹ Import ${newTasks.length}Tasks\n\nPreview:\n${previewText}${moreText}\n\nâœ… Default settings will be applied:\nâ€¢ Size:Medium (M)\nâ€¢ Priority:P3\nâ€¢ Status:To Do\nâ€¢ Start Date:Next Monday\nâ€¢ Assigned:Unassigned\n\nContinue with import?`;if (!confirm(confirmMessage)){return;}const defaultSize='M';const defaultPriority='P3';const defaultStartDate=getLocalDateString(getNextMonday(new Date()));const defaultAssigned=[];let addedCount=0;let skippedCount=0;newTasks.forEach(taskName=>{const isDuplicate=tickets.some(ticket=>ticket.description.toLowerCase()===taskName.toLowerCase() );if (isDuplicate){skippedCount++;console.warn(`Skipping duplicate task:${taskName}`);return;}tickets.push({id:currentTicketId++,description:taskName,startDate:defaultStartDate,size:defaultSize,priority:defaultPriority,status:'To Do',assigned:[...defaultAssigned],pauseComments:[]});addedCount++;});if (addedCount>0){if (!useCommonStartDate){renderPeople();}calculateProjection();saveToLocalStorage();let message=`âœ… Task Import Complete!\n\nâ€¢ ${addedCount}tasks added successfully`;if (skippedCount>0){message+=`\nâ€¢ ${skippedCount}duplicates skipped`;}message+=`\n\nğŸ“ All tasks set to:\nâ€¢ Size:Medium (M)\nâ€¢ Priority:P3\nâ€¢ Start Date:${formatDate(defaultStartDate)}\nâ€¢ Status:Unassigned\n\nYou can now edit individual tasks as needed.`;alert(message);}else{alert('âŒ No tasks were added. All tasks may have been duplicates.');}}window.resetToDefaults=()=>{if (confirm('This will reset all data to defaults with current dates. Are you sure?')){localStorage.removeItem(STORAGE_KEY);initializeDefaultData();useCommonStartDate=false;document.getElementById('use-common-start-date').checked=false;calculateEffortMap();renderEffortMap();renderPeople();calculateProjection();renderStakeholdersList();renderInitiativesList();alert('Data reset to defaults with current dates!');}}window.toggleCommonStartDate=()=>{const checkbox=document.getElementById('use-common-start-date');const commonDateInput=document.getElementById('common-start-date');const individualDateInput=document.getElementById('new-ticket-start-date');const startDateHelp=document.getElementById('start-date-help');useCommonStartDate=checkbox.checked;if (useCommonStartDate){commonDateInput.disabled=false;commonDateInput.classList.remove('bg-gray-100');commonDateInput.classList.add('bg-white');if (!commonDateInput.value){commonDateInput.value=getLocalDateString(getDefaultTaskStartDate());}individualDateInput.disabled=true;individualDateInput.classList.add('bg-gray-100','text-gray-400');startDateHelp.innerHTML='Common start date is enabled-all tasks will use the same start date above.<strong>Team availability weeks are recalculated from this date.</strong>';}else{commonDateInput.disabled=true;commonDateInput.classList.add('bg-gray-100');commonDateInput.classList.remove('bg-white');individualDateInput.disabled=false;individualDateInput.classList.remove('bg-gray-100','text-gray-400');startDateHelp.innerHTML='Individual start dates enabled.<strong>Team availability weeks are calculated from the earliest task start date.</strong>';}renderPeople();markDirty();calculateProjection();saveToLocalStorage();}window.updateAllTaskStartDates=()=>{if (useCommonStartDate){updateAvailabilityHeader();renderPeople();calculateProjection();saveToLocalStorage();}}window.updateEffortMapping=(value)=>{updateProjectHours(value);};window.updateTicketSizeDays=(sizeKey,value)=>{const newDays=parseInt(value,10);if (isNaN(newDays) || newDays<1) return;ticketDays[sizeKey]=newDays;markDirty();calculateEffortMap();renderEffortMap();calculateProjection();saveToLocalStorage();}window.updateTicketSizeDaysEnhanced=(sizeKey,value)=>{const newDays=parseFloat(value);if (isNaN(newDays) || newDays<0.1) return;ticketDays[sizeKey]=newDays;taskSizeDefinitions[sizeKey].days=newDays;markDirty();calculateEffortMap();renderTaskSizeCards();calculateProjection();saveToLocalStorage();}window.applyPreset=(presetName)=>{const presets={agile:{XS:{name:'Extra Small',days:0.5,removable:true},S:{name:'Small',days:1,removable:false},M:{name:'Medium',days:3,removable:false},L:{name:'Large',days:5,removable:false},XL:{name:'X-Large',days:8,removable:false}},enterprise:{S:{name:'Small',days:2,removable:false},M:{name:'Medium',days:5,removable:false},L:{name:'Large',days:10,removable:false},XL:{name:'X-Large',days:20,removable:false},XXL:{name:'XX-Large',days:40,removable:false}},startup:{XS:{name:'Quick Fix',days:0.25,removable:true},S:{name:'Small',days:1,removable:false},M:{name:'Medium',days:2,removable:false},L:{name:'Large',days:5,removable:false},XL:{name:'Epic',days:10,removable:false}},conservative:{S:{name:'Small',days:3,removable:false},M:{name:'Medium',days:8,removable:false},L:{name:'Large',days:15,removable:false},XL:{name:'X-Large',days:25,removable:false},XXL:{name:'XX-Large',days:40,removable:false}}};if (presets[presetName]){if (confirm(`Apply ${presetName}preset? This will replace your current task sizes.`)){taskSizeDefinitions={...presets[presetName]};syncTaskSizes();markDirty();calculateEffortMap();renderTaskSizeCards();calculateProjection();saveToLocalStorage();}}}window.showCustomSizeForm=()=>{document.getElementById('custom-size-form').classList.remove('hidden');}window.hideCustomSizeForm=()=>{document.getElementById('custom-size-form').classList.add('hidden');document.getElementById('new-size-key').value='';document.getElementById('new-size-name').value='';document.getElementById('new-size-days').value='';}window.addCustomSize=()=>{const key=document.getElementById('new-size-key').value.trim().toUpperCase();const name=document.getElementById('new-size-name').value.trim();const days=parseFloat(document.getElementById('new-size-days').value);if (!key || !name || isNaN(days) || days<0.1){alert('Please fill all fields with valid values.');return;}if (taskSizeDefinitions[key]){alert('Size key already exists. Choose a different key.');return;}taskSizeDefinitions[key]={name,days,removable:true};ticketDays[key]=days;markDirty();calculateEffortMap();renderTaskSizeCards();hideCustomSizeForm();saveToLocalStorage();alert(`âœ… Added custom size:${name}(${key})-${days}days`);}window.removeTaskSize=(sizeKey)=>{if (!taskSizeDefinitions[sizeKey]?.removable){alert('This task size cannot be removed.');return;}const ticketsWithSize=tickets.filter(ticket=>ticket.size===sizeKey);if (ticketsWithSize.length>0){alert(`Cannot remove size ${sizeKey}. It's used by ${ticketsWithSize.length}ticket(s).`);return;}if (confirm(`Remove task size ${sizeKey}(${taskSizeDefinitions[sizeKey].name})?`)){delete taskSizeDefinitions[sizeKey];delete ticketDays[sizeKey];markDirty();calculateEffortMap();renderTaskSizeCards();saveToLocalStorage();}}window.addPerson=()=>{const nameInput=document.getElementById('new-person-name');const name=nameInput.value.trim();if (!name || people.some(p=>p.name===name)){if (name) alert("Person already exists or name is invalid.");return;}people.push({name:name,availability:[25,25,25,25,25,25,25,25],isProjectReady:true});nameInput.value='';markDirty();renderPeople();calculateProjection();saveToLocalStorage();}window.removePerson=(name)=>{people=people.filter(p=>p.name !==name);tickets.forEach(ticket=>{ticket.assigned=ticket.assigned.filter(n=>n !==name);});markDirty();renderPeople();calculateProjection();saveToLocalStorage();}window.updatePersonAvailability=(name,weekIndex,value)=>{const hours=Math.max(0,parseInt(value,10));if (isNaN(hours)) return;const person=people.find(p=>p.name===name);if (person){console.log(`ğŸ”„ AVAILABILITY UPDATE:${name}Week ${weekIndex+1}changed from ${person.availability[weekIndex]}to ${hours}hours`);person.availability[weekIndex]=hours;console.log(`ğŸ“Š Updated ${name}availability:`,person.availability);markDirty();calculateProjection();saveToLocalStorage();console.log(`âœ… Recalculation triggered for availability change`);}}window.updatePersonProjectReady=(name,isReady)=>{const person=people.find(p=>p.name===name);if (person){console.log(`ğŸ¯ PROJECT READY UPDATE:${name}changed from ${person.isProjectReady ? 'Project Ready':'Not Project Ready'}to ${isReady ? 'Project Ready':'Not Project Ready'}`);person.isProjectReady=isReady;console.log(`ğŸ“Š Updated ${name}project ready status:`,person.isProjectReady);markDirty();calculateProjection();saveToLocalStorage();console.log(`âœ… Recalculation triggered for project ready change`);}}function checkP1TaskConflicts(employeeNames,taskStartDate,taskSize,excludeTaskId=null){console.log('ğŸ” P1 Conflict Check:',{employeeNames,taskStartDate,taskSize,excludeTaskId});if (!Array.isArray(employeeNames) || employeeNames.length===0){console.log('âŒ No employees to check or invalid input');return{hasConflicts:false,conflictedEmployees:[],availableEmployees:[]};}const projectedTickets=getProjectedTickets();console.log('ğŸ“Š Fresh projected tickets count:',projectedTickets.length);console.log('ğŸ“Š Sample projected ticket:',projectedTickets[0]);const tempTask={id:-1,description:'temp',startDate:taskStartDate,size:taskSize,priority:'P1',assigned:employeeNames};console.log('ğŸ”§ Created temp task:',tempTask);const tempProjected=projectedTickets.concat([tempTask]);const recalculatedProjected=getProjectedTickets([tempTask]);let tempTaskProjected=recalculatedProjected.find(t=>t.id===-1);console.log('ğŸ“ˆ Temp task projected:',tempTaskProjected);if (!tempTaskProjected || !tempTaskProjected.rawEndDate){const estimatedEndDate=new Date(taskStartDate);estimatedEndDate.setDate(estimatedEndDate.getDate()+28);tempTaskProjected={rawEndDate:estimatedEndDate};console.log('âš ï¸ Using fallback end date calculation:',estimatedEndDate);}const newTaskStart=new Date(taskStartDate);const newTaskEnd=tempTaskProjected.rawEndDate;console.log('ğŸ—“ï¸ New task date range:',{start:newTaskStart.toDateString(),end:newTaskEnd.toDateString()});const conflictedEmployees=[];const availableEmployees=[];employeeNames.forEach(employeeName=>{console.log(`ğŸ” Checking ${employeeName}for P1 conflicts...`);let hasConflict=false;const existingP1Tasks=tickets.filter(ticket=>ticket.priority==='P1' && ticket.assigned.includes(employeeName) && ticket.id !==excludeTaskId );console.log(`ğŸ“‹ Found ${existingP1Tasks.length}existing P1 tasks for ${employeeName}:`,existingP1Tasks.map(t=>({id:t.id,desc:t.description,start:t.startDate})));for (const existingTask of existingP1Tasks){console.log(`ğŸ” Checking existing task:`,{id:existingTask.id,desc:existingTask.description,start:existingTask.startDate,size:existingTask.size});const existingProjected=projectedTickets.find(pt=>pt.id===existingTask.id);console.log(`ğŸ“Š Existing task projected:`,existingProjected);console.log(`ğŸ“Š Available properties:`,existingProjected ? Object.keys(existingProjected):'none');if (existingProjected && (existingProjected.rawEndDate || existingProjected.endDate)){const existingStart=new Date(existingTask.startDate);const existingEndValue=existingProjected.rawEndDate || existingProjected.endDate;const existingEnd=new Date(existingEndValue);console.log(`ğŸ“Š Date values:`,{existingEndValue,existingEnd,isValidDate:!isNaN(existingEnd.getTime())});if (isNaN(existingEnd.getTime()) || existingEndValue==='N/A'){console.error(`âŒ PROJECTION SYSTEM BUG:Task ${existingTask.id}has invalid end date '${existingEndValue}'. This must be fixed!`);console.log(`Task details:`,existingTask);console.log(`Projected details:`,existingProjected);return;}const hasOverlap=(newTaskStart<=existingEnd && newTaskEnd>=existingStart);console.log(`ğŸ“… Date overlap check for ${employeeName}:`,{newTaskStart:newTaskStart.toDateString(),newTaskEnd:newTaskEnd.toDateString(),existingStart:existingStart.toDateString(),existingEnd:existingEnd.toDateString(),hasOverlap,condition1:newTaskStart<=existingEnd,condition2:newTaskEnd>=existingStart});if (hasOverlap){console.log(`âš ï¸ CONFLICT DETECTED for ${employeeName}!`);hasConflict=true;if (!conflictedEmployees.find(ce=>ce.name===employeeName)){conflictedEmployees.push({name:employeeName,conflictingTaskId:existingTask.id,conflictingTaskDescription:existingTask.description,conflictingTaskStart:existingTask.startDate});}break;}}else{console.log(`âŒ No projected data found for existing task ${existingTask.id},available properties:`,existingProjected ? Object.keys(existingProjected):'task not found');}}if (!hasConflict){availableEmployees.push(employeeName);}});const allEmployees=people.map(p=>p.name);const unselectedEmployees=allEmployees.filter(name=>!employeeNames.includes(name));unselectedEmployees.forEach(employeeName=>{let hasConflict=false;const existingP1Tasks=tickets.filter(ticket=>ticket.priority==='P1' && ticket.assigned.includes(employeeName) && ticket.id !==excludeTaskId );for (const existingTask of existingP1Tasks){const existingProjected=projectedTickets.find(pt=>pt.id===existingTask.id);if (existingProjected && existingProjected.rawEndDate){const existingStart=new Date(existingTask.startDate);const existingEnd=existingProjected.rawEndDate;const hasOverlap=(newTaskStart<=existingEnd && newTaskEnd>=existingStart);if (hasOverlap){hasConflict=true;break;}}}if (!hasConflict){availableEmployees.push(employeeName);}});const result={hasConflicts:conflictedEmployees.length>0,conflictedEmployees:conflictedEmployees,availableEmployees:availableEmployees};console.log('âœ… P1 Conflict Check Result:',result);return result;}function showP1ConflictWarning(conflictResult){const conflictedNames=conflictResult.conflictedEmployees.map(ce=>ce.name);const availableNames=conflictResult.availableEmployees;let message='';if (conflictedNames.length===1){const conflict=conflictResult.conflictedEmployees[0];message=`Employee ${conflictedNames[0]}already has another P1 task assigned ("${conflict.conflictingTaskDescription}") starting ${formatDate(conflict.conflictingTaskStart)}.`;}else{const conflictDetails=conflictResult.conflictedEmployees.map(ce=>`${ce.name}("${ce.conflictingTaskDescription}" from ${formatDate(ce.conflictingTaskStart)})` ).join(',');message=`Employees ${conflictDetails}already have other P1 tasks assigned.`;}if (availableNames.length>0){message+=`\n\nFollowing employees have no P1 tasks against them during this period-${availableNames.join(',')}. You can pick any of them.`;}else{message+=`\n\nNo employees are available for P1 tasks during this period.`;}message+=`\n\nâš ï¸ Do you want to proceed anyway? This person will have multiple P1 tasks during overlapping periods.`;return confirm(message);}function updateInitiativeStartDate(initiativeName,taskStartDate){const initiative=initiatives.find(i=>i.name===initiativeName);if (!initiative) return;const associatedTasks=tickets.filter(t=>t.initiative===initiativeName && t.startDate);let earliestDate=taskStartDate;for (const task of associatedTasks){if (!earliestDate || task.startDate<earliestDate){earliestDate=task.startDate;}}if (initiative.startDate !==earliestDate){console.log(`ğŸ“Š Initiative "${initiativeName}" start date updated:${initiative.startDate}â†’ ${earliestDate}`);initiative.startDate=earliestDate;}}function recalculateAllInitiativeStartDates(){for (const initiative of initiatives){const associatedTasks=tickets.filter(t=>t.initiative===initiative.name && t.startDate);if (associatedTasks.length>0){const earliestDate=associatedTasks.reduce((earliest,task)=>{return !earliest || task.startDate<earliest ? task.startDate:earliest;},null);initiative.startDate=earliestDate;}else{initiative.startDate=null;}}}window.addTicket=()=>{const descInput=document.getElementById('new-ticket-desc');const startDateInput=document.getElementById('new-ticket-start-date');const sizeSelect=document.getElementById('new-ticket-size');const prioritySelect=document.getElementById('new-ticket-priority');const stakeholderSelect=document.getElementById('new-ticket-stakeholder');const initiativeSelect=document.getElementById('new-ticket-initiative');const assignedContainer=document.getElementById('new-ticket-assigned');const flexibleCheckbox=document.getElementById('new-ticket-flexible');const description=descInput.value.trim();let startDate;if (useCommonStartDate){const commonDate=document.getElementById('common-start-date').value;startDate=commonDate || getLocalDateString(getDefaultTaskStartDate());}else{startDate=startDateInput.value || getLocalDateString(getDefaultTaskStartDate());}const size=sizeSelect.value;const priority=prioritySelect.value;const stakeholder=stakeholderSelect.value;const initiative=initiativeSelect.value;const assigned=Array.from(assignedContainer.querySelectorAll('input[type="checkbox"]:checked')).map(checkbox=>checkbox.value);const isFixedLength=!flexibleCheckbox.checked;if (!description){alert("Ticket description cannot be empty.");return;}if (!stakeholder){alert("Please select a stakeholder.");return;}if (!initiative){alert("Please select an initiative.");return;}const similarTasks=findSimilarTasks(description);if (similarTasks.length>0){let message=`âš ï¸ Found ${similarTasks.length}similar task(s):\n\n`;similarTasks.slice(0,3).forEach((match,idx)=>{message+=`${idx+1}. "${match.ticket.description}" (${match.confidence}% match)\n`;message+=` ID:${match.ticket.id},Status:${match.ticket.status}\n\n`;});if (similarTasks.length>3){message+=`...and ${similarTasks.length-3}more.\n\n`;}message+="Do you want to:\n";message+="â€¢ OK-Change the title to make it unique\n";message+="â€¢ Cancel-Add anyway (not recommended)";const shouldChangeTitle=confirm(message);if (shouldChangeTitle){descInput.focus();descInput.select();return;}}if (priority==='P1' && assigned.length>0){const conflictResult=checkP1TaskConflicts(assigned,startDate,size);if (conflictResult.hasConflicts){const userWantsToProceed=showP1ConflictWarning(conflictResult);if (!userWantsToProceed){return;}}}const detailsDescription=document.getElementById('new-ticket-details-description').value.trim();const detailsPositives=document.getElementById('new-ticket-details-positives').value.trim();const detailsNegatives=document.getElementById('new-ticket-details-negatives').value.trim();const newTicket={uuid:generateUUID(),id:getNextDisplayId(),description:description,startDate:startDate,size:size,priority:priority,stakeholder:stakeholder,initiative:initiative,assigned:assigned,status:"To Do",pauseComments:[],isFixedLength:isFixedLength};updateInitiativeStartDate(initiative,startDate);if (detailsDescription || detailsPositives || detailsNegatives){newTicket.taskDetails={description:detailsDescription,positives:detailsPositives,negatives:detailsNegatives};}initializeStartDateHistory(newTicket);tickets.push(newTicket);descInput.value='';startDateInput.value='';sizeSelect.value='L';prioritySelect.value='P3';flexibleCheckbox.checked=false;document.getElementById('new-ticket-details-description').value='';document.getElementById('new-ticket-details-positives').value='';document.getElementById('new-ticket-details-negatives').value='';updateNewTicketDetailsIconColor();assignedContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox=>checkbox.checked=false);markDirty();if (!useCommonStartDate){renderPeople();}calculateProjection();saveToLocalStorage();}window.removeTicket=(id)=>{tickets=tickets.filter(t=>t.id !==id);markDirty();if (!useCommonStartDate){renderPeople();}calculateProjection();saveToLocalStorage();}window.openTaskDetailsModal=(taskId)=>{const task=tickets.find(t=>t.id===taskId);if (!task){alert("Task not found.");return;}document.getElementById('details-modal-task-id').value=taskId;const details=task.taskDetails ||{};document.getElementById('details-modal-description').value=details.description || '';document.getElementById('details-modal-positives').value=details.positives || '';document.getElementById('details-modal-negatives').value=details.negatives || '';document.getElementById('task-details-modal').classList.add('active');}window.closeTaskDetailsModal=()=>{document.getElementById('task-details-modal').classList.remove('active');document.getElementById('details-modal-task-id').value='';document.getElementById('details-modal-description').value='';document.getElementById('details-modal-positives').value='';document.getElementById('details-modal-negatives').value='';}window.saveTaskDetails=()=>{const taskId=parseInt(document.getElementById('details-modal-task-id').value);const task=tickets.find(t=>t.id===taskId);if (!task){alert("Task not found.");return;}const description=document.getElementById('details-modal-description').value.trim();const positives=document.getElementById('details-modal-positives').value.trim();const negatives=document.getElementById('details-modal-negatives').value.trim();if (description || positives || negatives){task.taskDetails={description:description,positives:positives,negatives:negatives};}else{delete task.taskDetails;}markDirty();saveToLocalStorage();calculateProjection();closeTaskDetailsModal();}window.openNewTicketDetailsModal=()=>{document.getElementById('new-ticket-details-modal').classList.add('active');updateNewTicketDetailsIconColor();}window.closeNewTicketDetailsModal=()=>{document.getElementById('new-ticket-details-modal').classList.remove('active');}window.saveNewTicketDetails=()=>{closeNewTicketDetailsModal();updateNewTicketDetailsIconColor();}window.updateNewTicketDetailsIconColor=()=>{const description=document.getElementById('new-ticket-details-description').value.trim();const positives=document.getElementById('new-ticket-details-positives').value.trim();const negatives=document.getElementById('new-ticket-details-negatives').value.trim();const icon=document.getElementById('new-ticket-details-icon');if (description || positives || negatives){icon.className='text-blue-600 hover:text-blue-700 transition-colors';}else{icon.className='text-gray-400 hover:text-blue-600 transition-colors';}}window.updateTicketAssignment=(id,newAssignedArray)=>{const ticket=tickets.find(t=>t.id===id);if (ticket){ticket.assigned=newAssignedArray;markDirty();calculateProjection();saveToLocalStorage();}}window.handleAssignmentChange=(selectElement,ticketId)=>{const newAssignedArray=Array.from(selectElement.selectedOptions).map(o=>o.value);window.updateTicketAssignment(ticketId,newAssignedArray);}window.handleAssignmentCheckboxChange=(checkboxElement,ticketId)=>{const personName=checkboxElement.value;const isChecked=checkboxElement.checked;const ticket=tickets.find(t=>t.id===ticketId);if (!ticket) return;if (isChecked && ticket.priority==='P1'){console.log('ğŸ” Checkbox P1 check triggered for:',{personName,ticketId,priority:ticket.priority});const conflictResult=checkP1TaskConflicts([personName],ticket.startDate,ticket.size,ticketId);if (conflictResult.hasConflicts){console.log('âš ï¸ P1 conflicts found,showing warning...');const userWantsToProceed=showP1ConflictWarning(conflictResult);if (!userWantsToProceed){checkboxElement.checked=false;return;}}else{console.log('âœ… No P1 conflicts found');}}if (isChecked){if (!ticket.assigned.includes(personName)){ticket.assigned.push(personName);}}else{ticket.assigned=ticket.assigned.filter(name=>name !==personName);}checkboxElement.parentElement.style.background='#dcfce7';setTimeout(()=>{checkboxElement.parentElement.style.background='transparent';},500);markDirty();calculateProjection();saveToLocalStorage();}window.handleSizeChange=(selectElement,ticketId)=>{const newSize=selectElement.value;const ticket=tickets.find(t=>t.id===ticketId);if (ticket){const oldSize=ticket.size;ticket.size=newSize;if (ticket.customEndDate){console.log(`ğŸ“… Clearing custom end date for ticket #${ticketId}due to manual size change:${oldSize}â†’ ${newSize}`);delete ticket.customEndDate;}selectElement.style.background='#dcfce7';setTimeout(()=>{selectElement.style.background='white';},500);markDirty();calculateProjection();saveToLocalStorage();console.log(`ğŸ“Š Ticket #${ticketId}size changed from ${oldSize}to ${newSize}-recalculating...`);}}window.handlePriorityChange=(selectElement,ticketId)=>{const newPriority=selectElement.value;const ticket=tickets.find(t=>t.id===ticketId);if (ticket){const oldPriority=ticket.priority || 'P3';if (newPriority==='P1' && ticket.assigned.length>0){console.log('ğŸ” Priority change P1 check triggered for:',{ticketId,assigned:ticket.assigned});const conflictResult=checkP1TaskConflicts(ticket.assigned,ticket.startDate,ticket.size,ticketId);if (conflictResult.hasConflicts){console.log('âš ï¸ P1 conflicts found during priority change,showing warning...');const userWantsToProceed=showP1ConflictWarning(conflictResult);if (!userWantsToProceed){selectElement.value=oldPriority;return;}}else{console.log('âœ… No P1 conflicts found during priority change');}}ticket.priority=newPriority;selectElement.style.background='#e0e7ff';setTimeout(()=>{selectElement.style.background='white';},500);markDirty();saveToLocalStorage();console.log(`â­ Ticket #${ticketId}priority changed from ${oldPriority}to ${newPriority}`);}}window.handleStakeholderChange=(selectElement,ticketId)=>{const newStakeholder=selectElement.value;const ticket=tickets.find(t=>t.id===ticketId);if (ticket){const oldStakeholder=ticket.stakeholder || 'General';ticket.stakeholder=newStakeholder;selectElement.style.background='#ccfbf1';setTimeout(()=>{selectElement.style.background='white';},500);markDirty();saveToLocalStorage();console.log(`ğŸ‘¤ Ticket #${ticketId}stakeholder changed from "${oldStakeholder}" to "${newStakeholder}"`);}}window.handleInitiativeChange=(selectElement,ticketId)=>{const newInitiative=selectElement.value;const ticket=tickets.find(t=>t.id===ticketId);if (ticket){const oldInitiative=ticket.initiative || 'General';ticket.initiative=newInitiative;selectElement.style.background='#fed7aa';setTimeout(()=>{selectElement.style.background='white';},500);recalculateAllInitiativeStartDates();markDirty();saveToLocalStorage();console.log(`ğŸ“Š Ticket #${ticketId}initiative changed from "${oldInitiative}" to "${newInitiative}"`);}}window.toggleTaskType=(ticketId)=>{const ticket=tickets.find(t=>t.id===ticketId);if (ticket){const wasFixed=ticket.isFixedLength !==false;ticket.isFixedLength=!wasFixed;const newType=ticket.isFixedLength ? 'Fixed-Length':'Flexible';const oldType=wasFixed ? 'Fixed-Length':'Flexible';console.log(`ğŸ”„ Ticket #${ticketId}task type changed from ${oldType}to ${newType}`);if (ticket.customEndDate){console.log(`ğŸ“… Clearing custom end date for ticket #${ticketId}due to task type change`);delete ticket.customEndDate;}markDirty();calculateProjection();saveToLocalStorage();}}window.getStatusClass=(status)=>{const statusClasses={'To Do':'status-todo','In Progress':'status-in-progress','Paused':'status-paused','Done':'status-done','Closed':'status-closed'};return statusClasses[status] || 'status-todo';}window.getStatusDisplay=(status)=>{const statusDisplay={'To Do':'ğŸ“‹ To Do','In Progress':'ğŸš€ In Progress','Paused':'â¸ï¸ Paused','Done':'âœ… Done','Closed':'ğŸ—ƒï¸ Closed'};return statusDisplay[status] || 'ğŸ“‹ To Do';}window.getStatusDisplayWithComments=(ticket)=>{const status=ticket.status || 'To Do';const baseDisplay=window.getStatusDisplay(status);if (status==='Paused' && ticket.pauseComments && ticket.pauseComments.length>0){return baseDisplay+' ğŸ’¬';}return baseDisplay;}window.getStatusTooltip=(ticket)=>{const status=ticket.status || 'To Do';let tooltip='Click to change status';if (status==='Paused' && ticket.pauseComments && ticket.pauseComments.length>0){const latestComment=ticket.pauseComments[ticket.pauseComments.length-1];tooltip+=`\n\nLatest pause reason:\n"${latestComment.comment}"\n(${latestComment.timestamp})`;if (ticket.pauseComments.length>1){tooltip+=`\n\n${ticket.pauseComments.length}total pause comments`;}}return tooltip;}function setTaskStatusDirect(ticketId,newStatus){const ticketIndex=tickets.findIndex(t=>t.id===ticketId);if (ticketIndex>-1){const oldStatus=tickets[ticketIndex].status || 'To Do';tickets[ticketIndex].status=newStatus;console.log(`ğŸ“Š Ticket #${ticketId}status changed from "${oldStatus}" to "${newStatus}" (bulk operation)`);return true;}return false;}window.handleStatusRightClick=(event,ticketId)=>{event.preventDefault();const ticket=tickets.find(t=>t.id===ticketId);if (!ticket){console.error(`Ticket ${ticketId}not found`);return;}if (ticket.status !=='Paused'){alert(`ğŸ’¡ Edit Comments\n\nThis feature is only available for paused tasks.\n\nCurrent status:${ticket.status || 'To Do'}\n\nTo add pause comments,first change the task status to "Paused".`);return;}if (!ticket.pauseComments || ticket.pauseComments.length===0){const newComment=prompt(`â• Add Pause Comment\n\nTask:"${ticket.description}"\n\nPlease provide a reason for why this task is paused:`);if (newComment===null){return;}if (!ticket.pauseComments){ticket.pauseComments=[];}const timestamp=new Date().toLocaleString();ticket.pauseComments.push({timestamp:timestamp,comment:newComment || '(No reason specified)',previousStatus:'Unknown'});console.log(`â• Added pause comment to ticket ${ticketId}:"${newComment}"`);}else{const latestComment=ticket.pauseComments[ticket.pauseComments.length-1];const currentComment=latestComment.comment;const editedComment=prompt(`âœï¸ Edit Latest Pause Comment\n\nTask:"${ticket.description}"\nOriginal comment:"${currentComment}"\nAdded:${latestComment.timestamp}\n\nEdit your comment:`,currentComment);if (editedComment===null){return;}latestComment.comment=editedComment || '(No reason specified)';latestComment.editedAt=new Date().toLocaleString();console.log(`âœï¸ Edited pause comment for ticket ${ticketId}:"${editedComment}"`);}markDirty();saveToLocalStorage();calculateProjection();alert(`âœ… Comment Updated\n\nThe pause comment has been successfully updated.\nThe changes are automatically saved.`);}window.cycleTaskStatus=(ticketId)=>{const statusCycle=['To Do','In Progress','Paused','Done','Closed'];const ticketIndex=tickets.findIndex(t=>t.id===ticketId);if (ticketIndex>-1){const ticket=tickets[ticketIndex];const currentStatus=ticket.status || 'To Do';const currentIndex=statusCycle.indexOf(currentStatus);const nextIndex=(currentIndex+1) % statusCycle.length;const nextStatus=statusCycle[nextIndex];const statusIcons={'To Do':'ğŸ“‹','In Progress':'ğŸš€','Paused':'â¸ï¸','Done':'âœ…','Closed':'ğŸ—ƒï¸'};if (nextStatus==='Paused'){const pauseComment=prompt(`â¸ï¸ Pausing Task:"${ticket.description}"\n\nPlease provide a reason for pausing this task:\n(This will help track why work was stopped)`);if (pauseComment===null){console.log(`âŒ Status change to Paused cancelled for Ticket #${ticketId}-no comment provided`);return;}if (!ticket.pauseComments){ticket.pauseComments=[];}const timestamp=new Date().toLocaleString();ticket.pauseComments.push({timestamp:timestamp,comment:pauseComment || '(No reason specified)',previousStatus:currentStatus});tickets[ticketIndex].status=nextStatus;console.log(`â¸ï¸ Ticket #${ticketId}paused with comment:"${pauseComment}"`);}else{const confirmMessage=`ğŸ”„ Change Task Status?\n\n`+`Task:"${ticket.description}"\n\n`+`${statusIcons[currentStatus]}Current:${currentStatus}\n`+`${statusIcons[nextStatus]}New:${nextStatus}\n\n`+`Continue with status change?`;if (!confirm(confirmMessage)){console.log(`âŒ Status change cancelled for Ticket #${ticketId}`);return;}tickets[ticketIndex].status=nextStatus;console.log(`ğŸ“Š Ticket #${ticketId}status changed from "${currentStatus}" to "${nextStatus}"`);}const statusElement=document.querySelector(`[onclick="cycleTaskStatus(${ticketId})"]`);if (statusElement){statusElement.style.transform='scale(1.1)';setTimeout(()=>{statusElement.style.transform='scale(1)';},150);}markDirty();saveToLocalStorage();calculateProjection();}}window.handleStartDateChange=(inputElement,ticketId)=>{const newStartDate=inputElement.value;const ticket=tickets.find(t=>t.id===ticketId);if (ticket){const oldStartDate=ticket.startDate;ticket.startDate=newStartDate;trackStartDateChange(ticket,oldStartDate,newStartDate,'Manual update via UI');recalculateAllInitiativeStartDates();inputElement.style.background='#dcfce7';setTimeout(()=>{inputElement.style.background='white';},500);markDirty();if (!useCommonStartDate){renderPeople();}calculateProjection();saveToLocalStorage();console.log(`ğŸ“… Ticket #${ticketId}start date changed from ${formatDate(oldStartDate)}to ${formatDate(newStartDate)}-recalculating...`);}}window.showCalculationDetails=(ticketId)=>{const projectedTickets=getProjectedTickets();const ticket=projectedTickets.find(t=>t.id===ticketId);if (!ticket){alert('Ticket not found.');return;}const isFixedLength=ticket.isFixedLength !==false;const taskTypeIcon=isFixedLength ? 'ğŸ”’':'âš¡';const taskTypeName=isFixedLength ? 'Fixed-Length Task':'Flexible Task';const taskTypeDescription=isFixedLength ? 'Duration is fixed regardless of team size. Each person contributes proportionally over the full duration.':'Duration splits among assignees. Each person works at full capacity for a shorter time.';const enhancedContent=` ğŸ¯ TICKET:${ticket.description}(ID:${ticket.id}) ${taskTypeIcon}TASK TYPE:${taskTypeName}${taskTypeDescription}ğŸ“Š SIZE:${ticket.size}ğŸ“… START DATE:${formatDate(ticket.startDate)}ğŸ‘¥ ASSIGNED TO:${ticket.assigned.join(',')}ğŸŒ PROJECTED END:${ticket.endDate}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” ${ticket.explanation}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” ğŸ’¡ HOW TO READ this calculation:â€¢ Week numbers correspond to the planning horizon (8 weeks total) â€¢ ${isFixedLength ? 'Fixed-Length:Duration stays constant,capacity per person scales with team size':'Flexible:Duration splits among team members,each works at full capacity'}â€¢ Pooled Capacity=combined hours available from all assigned team members â€¢ Hours are distributed proportionally based on each person's availability â€¢ Task completes when all required hours are allocated â€¢ Any capacity constraints or delays are noted in the weekly breakdown `.trim();document.getElementById('modal-title').textContent=`ğŸ“Š Calculation Details-Ticket #${ticket.id}`;document.getElementById('calculation-content').textContent=enhancedContent;const modal=document.getElementById('calculation-modal');modal.classList.add('active');modal.addEventListener('click',(e)=>{if (e.target===modal){closeCalculationModal();}});}window.closeCalculationModal=()=>{const modal=document.getElementById('calculation-modal');modal.classList.remove('active');}document.addEventListener('keydown',(e)=>{if (e.key==='Escape'){closeCalculationModal();closeOverdueTasksModal();}});let overdueTasksToHandle=[];let handledTaskIds=new Set();window.openOverdueTasksModal=(overdueTasks)=>{overdueTasksToHandle=overdueTasks;handledTaskIds.clear();const modal=document.getElementById('overdue-tasks-modal');const tasksList=document.getElementById('overdue-tasks-list');renderOverdueTasksList();modal.classList.add('active');modal.addEventListener('click',(e)=>{if (e.target===modal){closeOverdueTasksModal();}});};function renderOverdueTasksList(){const tasksList=document.getElementById('overdue-tasks-list');const remainingTasks=overdueTasksToHandle.filter(task=>!handledTaskIds.has(task.id));if (remainingTasks.length===0){closeOverdueTasksModal();return;}let tasksHTML='<ul style="list-style:none;padding:0;margin:0;">';remainingTasks.forEach(task=>{const daysOverdue=Math.floor((new Date()-new Date(task.startDate))/(1000*60*60*24));tasksHTML+=`<li id="task-item-${task.id}" style="padding:10px;margin-bottom:8px;border-left:3px solid var(--primary-color);background:var(--card-background);border-radius:4px;"><div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;"><div style="flex:1;"><div style="font-weight:600;color:var(--text-color);margin-bottom:4px;">${task.description}</div><div style="font-size:12px;color:var(--text-secondary);">Start Date:${task.startDate}(${daysOverdue}day${daysOverdue !==1 ? 's':''}overdue)</div></div><div style="display:flex;gap:6px;flex-shrink:0;"><button onclick="handleIndividualTask(${task.id},'move')" style="padding:4px 8px;font-size:11px;background:var(--primary-color);color:white;border:none;border-radius:4px;cursor:pointer;white-space:nowrap;" title="Move to Today">ğŸ“… Today</button><button onclick="handleIndividualTask(${task.id},'progress')" style="padding:4px 8px;font-size:11px;background:var(--primary-color);color:white;border:none;border-radius:4px;cursor:pointer;white-space:nowrap;" title="Change to In Progress">â–¶ï¸ Progress</button></div></div></li>`;});tasksHTML+='</ul>';tasksList.innerHTML=tasksHTML;}window.closeOverdueTasksModal=()=>{const modal=document.getElementById('overdue-tasks-modal');modal.classList.remove('active');overdueTasksToHandle=[];handledTaskIds.clear();};window.handleIndividualTask=(taskId,action)=>{const task=overdueTasksToHandle.find(t=>t.id===taskId);if (!task) return;const today=new Date();today.setHours(0,0,0,0);const todayStr=getLocalDateString(today);if (action==='move'){const oldStartDate=task.startDate;task.startDate=todayStr;trackStartDateChange(task,oldStartDate,todayStr,'Overdue task correction');console.log(`ğŸ“… Moved task #${task.id}"${task.description}" to today`);}else if (action==='progress'){setTaskStatusDirect(task.id,'In Progress');console.log(`ğŸš€ Changed task #${task.id}"${task.description}" to In Progress`);}handledTaskIds.add(taskId);markDirty();saveToLocalStorage();calculateProjection();renderOverdueTasksList();};window.handleOverdueTasksAction=(action)=>{if (action==='skip'){console.log('â­ï¸ User skipped overdue task resolution');closeOverdueTasksModal();return;}const today=new Date();today.setHours(0,0,0,0);const todayStr=getLocalDateString(today);let updatedCount=0;const remainingTasks=overdueTasksToHandle.filter(task=>!handledTaskIds.has(task.id));if (remainingTasks.length===0){console.log('âœ… All tasks already handled individually');closeOverdueTasksModal();return;}if (action==='move'){remainingTasks.forEach(task=>{const oldStartDate=task.startDate;task.startDate=todayStr;trackStartDateChange(task,oldStartDate,todayStr,'Overdue task correction');updatedCount++;});console.log(`ğŸ“… Updated ${updatedCount}remaining overdue tasks to start today (${todayStr})`);alert(`ğŸ“… Success!\n\nUpdated ${updatedCount}task(s) to start today.\nStart dates have been moved to ${formatDate(todayStr)}.`);}else if (action==='progress'){remainingTasks.forEach(task=>{if (setTaskStatusDirect(task.id,'In Progress')){updatedCount++;}});console.log(`ğŸš€ Changed ${updatedCount}remaining overdue tasks to "In Progress" status`);alert(`ğŸš€ Success!\n\nChanged ${updatedCount}task(s) to "In Progress" status.\nThese tasks are now marked as actively being worked on.`);}markDirty();saveToLocalStorage();calculateProjection();closeOverdueTasksModal();};function initializeDefaultData(){console.log("Setting up default people data.");people=[{name:'Vipul',availability:[25,25,25,25,25,25,25,25],isProjectReady:true},{name:'Sameet',availability:[25,25,25,25,25,25,25,25],isProjectReady:true},{name:'Peter',availability:[25,25,25,25,25,25,25,25],isProjectReady:true},{name:'Sharanya',availability:[25,25,25,25,25,25,25,25],isProjectReady:true},{name:'Divya',availability:[25,25,25,25,25,25,25,25],isProjectReady:true},];stakeholders=['General'];initiatives=[{name:'General',creationDate:getLocalDateString(new Date()),startDate:null}];const today=new Date();const nextMonday=getNextMonday(new Date());tickets=[{id:1,description:'Sample Task-Delete Me',size:'M',priority:'P3',status:'To Do',assigned:['Vipul'],startDate:getLocalDateString(nextMonday)}];tickets=tickets.map(ticket=>{ticket=initializeStartDateHistory(ticket);ticket=initializeEndDateHistory(ticket);ticket=initializeSizeHistory(ticket);return ticket;});currentTicketId=2;saveToLocalStorage();}function checkOverdueTasks(){console.log('ğŸ” Checking for overdue tasks...');const today=new Date();today.setHours(0,0,0,0);const todayStr=getLocalDateString(today);console.log(`ğŸ“… Today's date:${todayStr}`);console.log(`ğŸ“‹ Total tickets:${tickets.length}`);const overdueTasks=tickets.filter(ticket=>{const status=ticket.status || 'To Do';console.log(`ğŸ« Ticket #${ticket.id}:"${ticket.description}"-Status:"${status}",Start:${ticket.startDate}`);if (status !=='To Do'){console.log(` â­ï¸ Skipping-not "To Do" status`);return false;}const startDate=new Date(ticket.startDate);startDate.setHours(0,0,0,0);const isOverdue=startDate<today;console.log(` ğŸ“… Start date:${getLocalDateString(startDate)},Overdue:${isOverdue}`);return isOverdue;});console.log(`âš ï¸ Found ${overdueTasks.length}overdue tasks`);if (overdueTasks.length===0){console.log('âœ… No overdue tasks found');return;}openOverdueTasksModal(overdueTasks);}function initializeScheduler(){if (!loadFromLocalStorage()){initializeDefaultData();}let migrationNeeded=false;tickets.forEach(ticket=>{if (!ticket.priority){ticket.priority='P3';migrationNeeded=true;}if (!ticket.status){ticket.status='To Do';migrationNeeded=true;}});if (migrationNeeded){saveToLocalStorage();console.log('ğŸ“Š Migrated existing tasks to include priority and status fields');}const defaultStartDate=getLocalDateString(getDefaultTaskStartDate());document.getElementById('new-ticket-start-date').value=defaultStartDate;document.getElementById('common-start-date').value=defaultStartDate;const checkbox=document.getElementById('use-common-start-date');checkbox.checked=useCommonStartDate;if (useCommonStartDate){toggleCommonStartDate();}calculateEffortMap();renderEffortMap();renderPeople();calculateProjection();updateTicketSizeDropdown();updateExportButtonsState();updateFilterUI();document.getElementById('estimation-base-hours').value=estimationBaseHours;document.getElementById('project-hours-per-day').value=projectHoursPerDay;document.getElementById('estimation-base-display').textContent=estimationBaseHours;checkOverdueTasks();}let heatMapStartDate=null;function calculateWorkloadHeatMap(){const projectedTickets=getProjectedTickets();const activeTickets=projectedTickets.filter(ticket=>ticket.status !=='Done' && ticket.status !=='Paused' && ticket.status !=='Closed' );const heatMapData=[];let startDate=new Date();if (activeTickets.length>0){let earliestTaskDate=null;activeTickets.forEach(task=>{let taskStartDate=new Date(task.startDate);const dayOfWeek=taskStartDate.getDay();if (dayOfWeek===0){taskStartDate.setDate(taskStartDate.getDate()+1);}else if (dayOfWeek===6){taskStartDate.setDate(taskStartDate.getDate()+2);}if (!earliestTaskDate || taskStartDate<earliestTaskDate){earliestTaskDate=new Date(taskStartDate);}});if (earliestTaskDate){startDate=earliestTaskDate;}}while (startDate.getDay() !==1){startDate.setDate(startDate.getDate()-1);}heatMapStartDate=new Date(startDate);people.forEach(person=>{const personData={name:person.name,weeks:[]};for (let weekIndex=0;weekIndex<8;weekIndex++){const weekStart=new Date(startDate);weekStart.setDate(startDate.getDate()+(weekIndex*7));const weekEnd=new Date(weekStart);weekEnd.setDate(weekStart.getDate()+6);const availability=person.availability && person.availability[weekIndex] !==undefined ? person.availability[weekIndex]:projectHoursPerDay*5;let assignedHours=0;activeTickets.forEach(ticket=>{if (ticket.assigned.includes(person.name)){let taskStart=new Date(ticket.startDate);const isFixedLength=ticket.isFixedLength !==false;const totalTaskDays=taskSizeDefinitions[ticket.size]?.days || ticketDays[ticket.size] || 1;const totalTaskEffort=effortMap[ticket.size] || (totalTaskDays*estimationBaseHours);let taskEnd;let dailyHoursForPerson;if (isFixedLength){taskEnd=addBusinessDays(new Date(taskStart),totalTaskDays-1);dailyHoursForPerson=totalTaskEffort/(totalTaskDays*Math.max(ticket.assigned.length,1));}else{const daysPerPerson=totalTaskDays/Math.max(ticket.assigned.length,1);const businessDaysNeeded=Math.ceil(daysPerPerson);taskEnd=addBusinessDays(new Date(taskStart),businessDaysNeeded-1);dailyHoursForPerson=estimationBaseHours;}const taskStartDay=taskStart.getDay();if (taskStartDay===0){taskStart=new Date(taskStart);taskStart.setDate(taskStart.getDate()+1);}else if (taskStartDay===6){taskStart=new Date(taskStart);taskStart.setDate(taskStart.getDate()+2);}if (taskStart<=weekEnd && taskEnd>=weekStart){const overlapStart=new Date(Math.max(taskStart.getTime(),weekStart.getTime()));const overlapEnd=new Date(Math.min(taskEnd.getTime(),weekEnd.getTime()));let businessDays=0;const currentDate=new Date(overlapStart);while (currentDate<=overlapEnd){const dayOfWeek=currentDate.getDay();if (dayOfWeek>=1 && dayOfWeek<=5){businessDays++;}currentDate.setDate(currentDate.getDate()+1);}if (!isNaN(dailyHoursForPerson) && !isNaN(businessDays)){assignedHours+=dailyHoursForPerson*businessDays;}}}});let utilization=0;if (availability>0 && !isNaN(assignedHours) && !isNaN(availability)){utilization=Math.round((assignedHours/availability)*100);}else if (assignedHours>0 && availability===0){utilization=999;}if (isNaN(utilization) || !isFinite(utilization)){utilization=0;}let colorClass='bg-green-100 border-green-300 text-green-800';if (utilization===999 || utilization>90){colorClass='bg-red-100 border-red-300 text-red-800';}else if (utilization>60){colorClass='bg-yellow-100 border-yellow-300 text-yellow-800';}personData.weeks.push({weekIndex:weekIndex+1,weekStart:formatDate(weekStart),weekEnd:formatDate(weekEnd),availability:availability,assignedHours:Math.round(assignedHours*10)/10,utilization:utilization,colorClass:colorClass});}heatMapData.push(personData);});return heatMapData;}function calculateBusinessDays(startDate,endDate){let businessDays=0;const currentDate=new Date(startDate);while (currentDate<=endDate){const dayOfWeek=currentDate.getDay();if (dayOfWeek>=1 && dayOfWeek<=5){businessDays++;}currentDate.setDate(currentDate.getDate()+1);}return businessDays;}function addBusinessDays(startDate,businessDaysToAdd){const result=new Date(startDate);let daysAdded=0;while (daysAdded<businessDaysToAdd){result.setDate(result.getDate()+1);const dayOfWeek=result.getDay();if (dayOfWeek>=1 && dayOfWeek<=5){daysAdded++;}}return result;}function getNextBusinessDay(date){const result=new Date(date);const dayOfWeek=result.getDay();if (dayOfWeek===0){result.setDate(result.getDate()+1);}else if (dayOfWeek===6){result.setDate(result.getDate()+2);}return result;}function renderWorkloadHeatMap(){const heatMapData=calculateWorkloadHeatMap();const container=document.getElementById('workload-heatmap');if (heatMapData.length===0){container.innerHTML='<p class="text-center py-4 text-gray-500">No team members defined. Add team members to see workload heat map.</p>';return;}let html='<table class="w-full border-collapse">';html+='<thead><tr class="bg-gray-50">';html+='<th class="border border-gray-300 px-3 py-2 text-left font-semibold">Team Member</th>';for (let i=1;i<=8;i++){const weekRange=getWeekDateRange(i-1);html+=`<th class="border border-gray-300 px-2 py-2 text-center font-semibold text-sm"><div>Week ${i}</div><div class="text-xs text-gray-600 font-normal">${weekRange}</div></th>`;}html+='</tr></thead>';html+='<tbody>';heatMapData.forEach(person=>{html+='<tr>';html+=`<td class="border border-gray-300 px-3 py-2 font-medium">${person.name}</td>`;person.weeks.forEach((week,weekIndex)=>{const tooltip=`Week ${week.weekIndex}(${week.weekStart}-${week.weekEnd})\\nAvailable:${week.availability}h\\nAssigned:${week.assignedHours}h\\nUtilization:${week.utilization===999 ? 'Overloaded':week.utilization+'%'}`;const displayValue=week.utilization===999 ? 'OVR':`${week.utilization}%`;html+=`<td class="border border-gray-300 p-1"><div class="${week.colorClass}rounded px-2 py-1 text-center text-sm font-medium cursor-pointer hover:opacity-80 transition-opacity" title="${tooltip}" onclick="showWeekTaskDetails('${person.name}',${weekIndex},'${week.weekStart}','${week.weekEnd}')">${displayValue}</div></td>`;});html+='</tr>';});html+='</tbody></table>';container.innerHTML=html;}function generateTaskCalendar(weekTasks,weekStartDate){if (weekTasks.length===0) return '';const firstTaskDate=new Date(Math.min(...weekTasks.map(t=>t.taskStartDate.getTime())));const lastTaskDate=new Date(Math.max(...weekTasks.map(t=>t.taskEndDate ? t.taskEndDate.getTime():t.taskStartDate.getTime())));const calendarStart=new Date(firstTaskDate.getFullYear(),firstTaskDate.getMonth(),1);const calendarEnd=new Date(lastTaskDate.getFullYear(),lastTaskDate.getMonth()+1,0);let calendarHtml=`<div class="mt-6 border-t pt-4"><h5 class="font-semibold text-gray-800 mb-3">ğŸ“… Task Timeline Calendar</h5><div class="bg-white border border-gray-200 rounded-lg p-3">`;const taskColors=[ 'bg-blue-200 border-blue-400 text-blue-900','bg-green-200 border-green-400 text-green-900','bg-purple-200 border-purple-400 text-purple-900','bg-orange-200 border-orange-400 text-orange-900','bg-pink-200 border-pink-400 text-pink-900' ];let currentMonth=calendarStart.getMonth();let currentDate=new Date(calendarStart);while (currentDate<=calendarEnd){if (currentDate.getMonth() !==currentMonth){currentMonth=currentDate.getMonth();}const monthName=currentDate.toLocaleDateString('en-US',{month:'long',year:'numeric'});calendarHtml+=`<div class="text-center font-semibold text-gray-700 mb-2">${monthName}</div>`;calendarHtml+=`<div class="grid grid-cols-7 gap-1 mb-2 text-xs text-gray-600 text-center"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>`;const firstDayOfMonth=new Date(currentDate.getFullYear(),currentDate.getMonth(),1);const startPadding=firstDayOfMonth.getDay();const lastDayOfMonth=new Date(currentDate.getFullYear(),currentDate.getMonth()+1,0);const daysInMonth=lastDayOfMonth.getDate();calendarHtml+='<div class="grid grid-cols-7 gap-1">';for (let i=0;i<startPadding;i++){calendarHtml+='<div class="h-8"></div>';}for (let day=1;day<=daysInMonth;day++){const dayDate=new Date(currentDate.getFullYear(),currentDate.getMonth(),day);const dayStr=getLocalDateString(dayDate);const dayOfWeek=dayDate.getDay();const activeTasks=weekTasks.filter(task=>{const taskStart=task.taskStartDate;const taskEnd=task.taskEndDate || task.taskStartDate;const dayDateNormalized=new Date(dayDate.getFullYear(),dayDate.getMonth(),dayDate.getDate());const taskStartNormalized=new Date(taskStart.getFullYear(),taskStart.getMonth(),taskStart.getDate());const taskEndNormalized=new Date(taskEnd.getFullYear(),taskEnd.getMonth(),taskEnd.getDate());return dayDateNormalized>=taskStartNormalized && dayDateNormalized<=taskEndNormalized && dayOfWeek>=1 && dayOfWeek<=5;});let dayClass='h-8 flex items-center justify-center text-xs border border-gray-200';let dayContent=day;let title='';if (dayOfWeek===0 || dayOfWeek===6){dayClass+=' bg-gray-100 text-gray-400';}if (activeTasks.length>0){const primaryTask=activeTasks[0];const taskIndex=weekTasks.findIndex(t=>t.id===primaryTask.id);const colorClass=taskColors[taskIndex % taskColors.length];dayClass+=` ${colorClass}font-medium`;const taskTitles=activeTasks.map(t=>`${t.title || `Task ${t.id}`}(${t.size})`).join(',');title=`title="${taskTitles}"`;if (activeTasks.length>1){dayContent+=`<span class="ml-1 text-xs">+${activeTasks.length-1}</span>`;}}else{dayClass+=' hover:bg-gray-50';}calendarHtml+=`<div class="${dayClass}" ${title}>${dayContent}</div>`;}calendarHtml+='</div>';currentDate=new Date(currentDate.getFullYear(),currentDate.getMonth()+1,1);}if (weekTasks.length>0){calendarHtml+=`<div class="mt-3 pt-3 border-t border-gray-200"><div class="text-xs text-gray-600 mb-2">Legend:</div><div class="grid grid-cols-1 gap-1 text-xs">`;weekTasks.forEach((task,index)=>{const colorClass=taskColors[index % taskColors.length];calendarHtml+=`<div class="flex items-center gap-2"><div class="w-4 h-3 ${colorClass}border rounded"></div><span>${task.title || `Task ${task.id}`}(${task.size})</span></div>`;});calendarHtml+=`</div></div>`;}calendarHtml+='</div></div>';return calendarHtml;}function showWeekTaskDetails(personName,weekIndex,weekStart,weekEnd){const modal=document.getElementById('week-task-modal');const title=document.getElementById('modal-title');const content=document.getElementById('modal-content');title.textContent=`${personName}-Week ${weekIndex+1}(${weekStart}-${weekEnd})`;const projectedTickets=getProjectedTickets();const activeTickets=projectedTickets.filter(ticket=>ticket.status !=='Done' && ticket.status !=='Paused' );let heatMapStartDate=new Date();if (activeTickets.length>0){let earliestTaskDate=null;activeTickets.forEach(task=>{let taskStartDate=new Date(task.startDate);const dayOfWeek=taskStartDate.getDay();if (dayOfWeek===0){taskStartDate.setDate(taskStartDate.getDate()+1);}else if (dayOfWeek===6){taskStartDate.setDate(taskStartDate.getDate()+2);}if (!earliestTaskDate || taskStartDate<earliestTaskDate){earliestTaskDate=new Date(taskStartDate);}});if (earliestTaskDate){heatMapStartDate=earliestTaskDate;}}while (heatMapStartDate.getDay() !==1){heatMapStartDate.setDate(heatMapStartDate.getDate()-1);}const weekStartDate=new Date(heatMapStartDate);weekStartDate.setDate(heatMapStartDate.getDate()+(weekIndex*7));const weekEndDate=new Date(weekStartDate);weekEndDate.setDate(weekStartDate.getDate()+6);const weekTasks=[];tickets.forEach(ticket=>{if (Array.isArray(ticket.assigned) && ticket.assigned.includes(personName)){let taskStartDate=new Date(ticket.startDate);const totalTaskDays=taskSizeDefinitions[ticket.size]?.days || ticketDays[ticket.size] || 1;let taskEndDate;const isFixedLength=ticket.isFixedLength !==false;if (isFixedLength){const businessDaysNeeded=Math.ceil(totalTaskDays);taskEndDate=addBusinessDays(new Date(taskStartDate),businessDaysNeeded-1);}else{const daysPerPerson=totalTaskDays/Math.max(ticket.assigned.length,1);const businessDaysNeeded=Math.ceil(daysPerPerson);taskEndDate=addBusinessDays(new Date(taskStartDate),businessDaysNeeded-1);}const taskStartDay=taskStartDate.getDay();if (taskStartDay===0){taskStartDate=new Date(taskStartDate);taskStartDate.setDate(taskStartDate.getDate()+1);}else if (taskStartDay===6){taskStartDate=new Date(taskStartDate);taskStartDate.setDate(taskStartDate.getDate()+2);}if (taskStartDate<=weekEndDate && taskEndDate>=weekStartDate){weekTasks.push({...ticket,taskStartDate:taskStartDate,taskEndDate:taskEndDate,originalStartDate:new Date(ticket.startDate)});}}});let html='';if (weekTasks.length===0){html='<p class="text-gray-500 text-center py-4">No tasks assigned for this week.</p>';}else{html='<div class="space-y-3">';const heatMapData=calculateWorkloadHeatMap();weekTasks.forEach(task=>{const startStr=task.taskStartDate.toLocaleDateString('en-US',{month:'short',day:'numeric'});const endStr=task.endDate || 'N/A';html+=`<div class="border border-gray-200 rounded-lg p-4 bg-gray-50"><div class="flex justify-between items-start mb-2"><h4 class="font-semibold text-lg">${task.title || `Task ${task.id}`}</h4><span class="text-sm font-medium px-2 py-1 bg-blue-100 text-blue-800 rounded">${task.size}</span></div><p class="text-gray-700 mb-2">${task.description}</p><div class="text-sm text-gray-600 mb-2"><label><strong>Start Date:</strong><input type="date" value="${task.originalStartDate.toISOString().split('T')[0]}" onchange="updateTaskStartDate(${task.id},this.value)" class="border rounded p-1 text-xs ml-2"/></label><div><strong>End Date:</strong>${endStr}</div><div><strong>Priority:</strong>${task.priority}</div><div class="mt-2"><label class="flex items-center space-x-2"><input type="checkbox" ${task.isFixedLength===false ? 'checked':''}onchange="toggleTaskTypeInModal(${task.id},this.checked,${weekIndex})" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"><span class="font-medium">${task.isFixedLength===false ? 'âš¡ Flexible Task':'ğŸ”’ Fixed-Length Task'}<span class="text-xs text-gray-500 ml-1">(check for Flexible)</span></span></label></div></div><div class="mb-2"><strong>Assigned:</strong></div><div class="flex flex-wrap gap-2 mb-2">`;people.forEach(p=>{const personHeat=heatMapData.find(h=>h.name===p.name);const weekUtil=personHeat ? personHeat.weeks[weekIndex]?.utilization:0;const normalizedPersonName=p.name.trim().replace(/^"|"$/g,'').toLowerCase();const isChecked=task.assigned.map(n=>n.trim().toLowerCase()).includes(normalizedPersonName);const escapedName=p.name.replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;');html+=`<label class="flex items-center space-x-1 text-xs whitespace-nowrap"><input type="checkbox" value="${escapedName}" ${isChecked ? 'checked':''}onchange="updateTaskAssignment(${task.id},'${escapedName}',this.checked,${weekIndex})" class="w-3 h-3 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"><span class="text-gray-700 cursor-pointer hover:text-blue-600" title="${weekUtil===999 ? 'Overloaded':weekUtil+'% allocated'}">ğŸ“… ${p.name}(${weekUtil===999 ? 'OVR':weekUtil+'%'})</span></label>`;});html+=`</div></div>`;});html+='</div>';const weekStartDate=new Date(getEffectiveStartDate());weekStartDate.setDate(weekStartDate.getDate()+(weekIndex*7));html+=generateTaskCalendar(weekTasks,weekStartDate);}content.innerHTML=html;modal.classList.remove('hidden');}function closeWeekTaskModal(){const modal=document.getElementById('week-task-modal');modal.classList.add('hidden');}function toggleTaskTypeInModal(taskId,isFlexible,weekIndex){const task=tickets.find(t=>t.id===taskId);if (!task) return;task.isFixedLength=!isFlexible;saveToLocalStorage();const projectedTickets=getProjectedTickets();renderWorkloadHeatMap();renderTickets(projectedTickets);const personName=task.assigned[0];if (personName){const heatMapData=calculateWorkloadHeatMap();const personData=heatMapData.find(p=>p.name===personName);if (personData && personData.weeks[weekIndex]){const week=personData.weeks[weekIndex];showWeekTaskDetails(personName,weekIndex,week.weekStart,week.weekEnd);}}}function showInitiativeTimeline(){const modal=document.getElementById('initiative-timeline-modal');const content=document.getElementById('initiative-timeline-content');if (initiatives.length===0){content.innerHTML=`<div class="text-center py-8 text-gray-500"><div class="text-4xl mb-3">ğŸ“‹</div><p class="text-lg">No initiatives created yet</p><p class="text-sm mt-2">Add initiatives from the management section below</p></div>`;modal.classList.remove('hidden');return;}const initiativeData=getInitiativeTimelineData();if (initiativeData.length===0){content.innerHTML=`<div class="text-center py-8 text-gray-500"><div class="text-4xl mb-3">ğŸ“‹</div><p class="text-lg">No initiatives with tasks yet</p><p class="text-sm mt-2">Assign tasks to initiatives to see the timeline</p></div>`;modal.classList.remove('hidden');return;}let html='';initiativeData.forEach(initiative=>{const isActive=initiative.status==='active';const bgColor=isActive ? 'bg-blue-50 border-blue-300':'bg-gray-50 border-gray-300';const textColor=isActive ? 'text-blue-900':'text-gray-700';const dotColor=isActive ? 'bg-blue-500':'bg-gray-400';const statusText=isActive ? 'Active Now':'Future';const statusColor=isActive ? 'text-blue-600':'text-gray-500';html+=`<div class="border-2 ${bgColor}rounded-lg p-4 transition-all hover:shadow-md"><div class="flex items-start gap-3"><div class="w-6 h-6 rounded-full ${dotColor}flex-shrink-0 mt-1"></div><div class="flex-1"><div class="flex items-start justify-between gap-4"><h4 class="text-lg font-semibold ${textColor}">${initiative.name}</h4><span class="text-xs font-medium ${statusColor}px-2 py-1 rounded-full ${isActive ? 'bg-blue-100':'bg-gray-200'}">${statusText}</span></div><div class="mt-2 text-sm ${textColor}"><div class="flex items-center gap-2"><span class="font-medium">ğŸ“… Start:</span><span>${initiative.startDate.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</span></div><div class="flex items-center gap-2 mt-1"><span class="font-medium">ğŸ End:</span><span>${initiative.endDate.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</span></div></div><div class="mt-2 text-xs ${isActive ? 'text-blue-600':'text-gray-600'}">${initiative.taskCount}task${initiative.taskCount !==1 ? 's':''}${initiative.stakeholder ? ` â€¢ Stakeholder:${initiative.stakeholder}`:''}</div></div></div></div>`;});content.innerHTML=html;modal.classList.remove('hidden');}function closeInitiativeTimeline(){const modal=document.getElementById('initiative-timeline-modal');modal.classList.add('hidden');}function getInitiativeTimelineData(){const timelineData=[];const today=new Date();today.setHours(0,0,0,0);initiatives.forEach(initiative=>{const initiativeTasks=tickets.filter(t=>t.initiative===initiative.name && t.status !=='Closed' );if (initiativeTasks.length===0){return;}const startDates=initiativeTasks.map(t=>new Date(t.startDate));const endDates=initiativeTasks.map(t=>{if (t.endDate && t.endDate !=='N/A'){const endDateStr=t.endDate;if (!endDateStr.includes(',') && !endDateStr.match(/\d{4}/)){return new Date(endDateStr+','+new Date().getFullYear());}return new Date(endDateStr);}return new Date(t.startDate);});const startDate=new Date(Math.min(...startDates));const endDate=new Date(Math.max(...endDates));let status='future';if (today>=startDate && today<=endDate){status='active';}else if (today>endDate){status='completed';}timelineData.push({name:initiative.name,startDate:startDate,endDate:endDate,status:status,taskCount:initiativeTasks.length,stakeholder:initiative.stakeholder || ''});});timelineData.sort((a,b)=>a.startDate-b.startDate);return timelineData;}document.addEventListener('click',function(event){const modal=document.getElementById('week-task-modal');if (event.target===modal){closeWeekTaskModal();}});function exportTaskMapCSV(){const projectedTickets=getProjectedTickets();const effectiveStartDate=getEffectiveStartDate();const dates=[];const currentDate=new Date(effectiveStartDate);for (let week=0;week<8;week++){for (let day=0;day<7;day++){const date=new Date(effectiveStartDate);date.setDate(date.getDate()+(week*7)+day);const dayOfWeek=date.getDay();if (dayOfWeek>=1 && dayOfWeek<=5){dates.push(new Date(date));}}}const headers=['Employee'];dates.forEach(date=>{const dateStr=date.toLocaleDateString('en-US',{month:'short',day:'numeric'});headers.push(dateStr);});const csvRows=[headers];const taskAssignments=[];projectedTickets.forEach(ticket=>{ticket.assigned.forEach(personName=>{taskAssignments.push({person:personName,task:ticket,taskName:ticket.description || ticket.title || `Task ${ticket.id}`});});});const assignmentsByPerson={};taskAssignments.forEach(assignment=>{if (!assignmentsByPerson[assignment.person]){assignmentsByPerson[assignment.person]=[];}assignmentsByPerson[assignment.person].push(assignment);});people.forEach(person=>{const personTasks=assignmentsByPerson[person.name] || [];if (personTasks.length===0){const row=[person.name];dates.forEach(date=>{const dayOfWeek=date.getDay();if (dayOfWeek===0 || dayOfWeek===6){row.push('Weekend');}else{row.push('');}});csvRows.push(row);}else{personTasks.forEach((taskAssignment,taskIndex)=>{const row=[person.name];const task=taskAssignment.task;const taskStartDate=new Date(task.startDate || effectiveStartDate);const taskEndDate=task.rawEndDate ? new Date(task.rawEndDate):null;dates.forEach(date=>{let cellContent='';if (taskEndDate){if (date>=taskStartDate && date<=taskEndDate){cellContent=taskAssignment.taskName;}}else{if (date.toDateString()===taskStartDate.toDateString()){cellContent=taskAssignment.taskName;}}if (!cellContent){const dayOfWeek=date.getDay();if (dayOfWeek===0 || dayOfWeek===6){cellContent='Weekend';}}row.push(cellContent);});csvRows.push(row);});}});const csvContent=csvRows.map(row=>row.map(cell=>{const cellStr=String(cell || '');if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')){return `"${cellStr.replace(/"/g,'""')}"`;}return cellStr;}).join(',') ).join('\n');const blob=new Blob([csvContent],{type:'text/csv;charset=utf-8;'});const link=document.createElement('a');if (link.download !==undefined){const url=URL.createObjectURL(blob);link.setAttribute('href',url);const today=new Date();const dateStr=getLocalDateString(today);link.setAttribute('download',`task-map-${dateStr}.csv`);link.style.visibility='hidden';document.body.appendChild(link);link.click();document.body.removeChild(link);alert('Task map CSV exported successfully!');}else{alert('CSV export not supported in this browser');}}function generateDelayAnalysisGeneric(type){console.log(`â° Generating ${type}delay analysis...`);tickets.forEach(ticket=>{initializeStartDateHistory(ticket);initializeEndDateHistory(ticket);initializeSizeHistory(ticket);});const config=getDelayAnalysisConfig(type);const allTickets=tickets;let delayData;if (type==='comprehensive'){delayData=extractComprehensiveData(allTickets,config);}else{delayData=extractStandardDelayData(allTickets,config);}document.getElementById('delayAnalysisModal').classList.remove('hidden');renderDelayAnalysisGeneric(delayData,config);}function getDelayAnalysisConfig(type){const configs={start:{type:'start',title:'ğŸ“Š Delay Analysis Summary',historyField:'startDateHistory',dateField:'date',bgColor:'blue',labels:{metric:'delays',action:'delayed',problematic:'High Delay Risk'},isProblematic:(count,days)=>count>=2 || days>=7},end:{type:'end',title:'ğŸ“Š End Date Delay Analysis Summary',historyField:'endDateHistory',dateField:'endDate',bgColor:'orange',labels:{metric:'extensions',action:'extended',problematic:'Significant End Date Delays'},isProblematic:(count,days)=>count>=2 || days>=7,checkCustomEndDate:true},comprehensive:{type:'comprehensive',title:'ğŸ” Comprehensive Delay Analysis',bgColor:'purple',labels:{highRisk:'High Risk Tasks',mediumRisk:'Medium Risk Tasks',lowRisk:'Low Risk Tasks'},isHighRisk:(issues,days)=>issues>=3 || days>=10,isMediumRisk:(issues,days)=>issues>=2 || days>=5}};return configs[type];}function extractStandardDelayData(allTickets,config){return allTickets.map(ticket=>{const history=ticket[config.historyField] || [];const delayCount=Math.max(0,history.length-1);const totalDelayDays=calculateDelayDays(history,config.dateField);const data={ticket,delayCount,totalDelayDays,history,isProblematic:config.isProblematic(delayCount,totalDelayDays)};if (config.checkCustomEndDate && ticket.customEndDate && delayCount===0){const projectedTickets=getProjectedTickets();const projectedTicket=projectedTickets.find(pt=>pt.id===ticket.id);if (projectedTicket && projectedTicket.rawEndDate){const originalDate=new Date(projectedTicket.rawEndDate);const customDate=new Date(ticket.customEndDate);const daysDiff=Math.floor((customDate-originalDate)/(1000*60*60*24));if (daysDiff>0){data.delayCount=1;data.totalDelayDays=daysDiff;data.hasCustomEndDate=true;}}}else if (config.checkCustomEndDate){data.hasCustomEndDate=!!ticket.customEndDate;}return data;}).sort((a,b)=>{if (a.isProblematic !==b.isProblematic) return a.isProblematic ?-1:1;return b.delayCount-a.delayCount;});}function extractComprehensiveData(allTickets,config){return allTickets.map(ticket=>{const startHistory=ticket.startDateHistory || [];const endHistory=ticket.endDateHistory || [];const sizeHistory=ticket.sizeHistory || [];const startDelayCount=Math.max(0,startHistory.length-1);const endDelayCount=Math.max(0,endHistory.length-1);const sizeChangeCount=Math.max(0,sizeHistory.length-1);const startDelayDays=calculateDelayDays(startHistory,'date');const endDelayDays=calculateDelayDays(endHistory,'endDate');const totalIssues=startDelayCount+endDelayCount+sizeChangeCount;const totalDelayDays=startDelayDays+endDelayDays;return{ticket,startDelayCount,endDelayCount,sizeChangeCount,startDelayDays,endDelayDays,totalIssues,totalDelayDays,startHistory,endHistory,sizeHistory,isHighRisk:config.isHighRisk(totalIssues,totalDelayDays),isMediumRisk:config.isMediumRisk(totalIssues,totalDelayDays)};}).sort((a,b)=>{if (a.isHighRisk !==b.isHighRisk) return a.isHighRisk ?-1:1;if (a.isMediumRisk !==b.isMediumRisk) return a.isMediumRisk ?-1:1;return b.totalIssues-a.totalIssues;});}function calculateDelayDays(history,dateField){if (history.length<=1) return 0;const originalDate=new Date(history[0][dateField]);const currentDate=new Date(history[history.length-1][dateField]);return Math.max(0,Math.floor((currentDate-originalDate)/(1000*60*60*24)));}function renderDelayAnalysisGeneric(delayData,config){const container=document.getElementById('delayAnalysisContent');if (config.type==='comprehensive'){container.innerHTML=renderComprehensiveAnalysis(delayData,config);}else{container.innerHTML=renderStandardAnalysis(delayData,config);}}function renderStandardAnalysis(delayData,config){const problematicTasks=delayData.filter(d=>d.isProblematic);const goodTasks=delayData.filter(d=>!d.isProblematic);const totalCount=delayData.reduce((sum,d)=>sum+d.delayCount,0);return `<div class="space-y-6"><div class="bg-${config.bgColor}-50 border border-${config.bgColor}-200 rounded-lg p-4"><h3 class="text-lg font-semibold text-${config.bgColor}-800 mb-2">${config.title}</h3><div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm"><div class="bg-white rounded p-3 text-center"><div class="text-2xl font-bold text-gray-800">${delayData.length}</div><div class="text-gray-600">Total Tasks</div></div><div class="bg-white rounded p-3 text-center"><div class="text-2xl font-bold text-red-600">${problematicTasks.length}</div><div class="text-gray-600">${config.type==='end' ? 'Delayed':'Problematic'}Tasks</div></div><div class="bg-white rounded p-3 text-center"><div class="text-2xl font-bold text-green-600">${goodTasks.length}</div><div class="text-gray-600">On-${config.type==='end' ? 'Time':'Track'}Tasks</div></div><div class="bg-white rounded p-3 text-center"><div class="text-2xl font-bold text-orange-600">${totalCount}</div><div class="text-gray-600">Total ${config.labels.metric.charAt(0).toUpperCase()+config.labels.metric.slice(1)}</div></div></div></div>${problematicTasks.length>0 ? `<div class="bg-red-50 border border-red-200 rounded-lg p-4"><h3 class="text-lg font-semibold text-red-800 mb-4">ğŸš¨ ${config.labels.problematic}</h3><div class="space-y-3">${problematicTasks.map(data=>generateStandardDelayCard(data,'red',config)).join('')}</div></div>`:''}${goodTasks.length>0 ? `<div class="bg-green-50 border border-green-200 rounded-lg p-4"><h3 class="text-lg font-semibold text-green-800 mb-4">âœ… On-${config.type==='end' ? 'Time':'Track'}Tasks</h3><div class="space-y-2">${goodTasks.slice(0,10).map(data=>generateStandardDelayCard(data,'green',config)).join('')}${goodTasks.length>10 ? `<div class="text-sm text-gray-600 italic">... and ${goodTasks.length-10}more tasks</div>`:''}</div></div>`:''}<div class="bg-gray-50 border border-gray-200 rounded-lg p-4"><h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“ˆ ${config.type==='end' ? 'End Date Extension':'Delay'}Pattern${config.type==='end' ? '':' Visualization'}</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${renderStandardChart(delayData,config)}</div></div></div>`;}function generateStandardDelayCard(data,colorScheme,config){const ticket=data.ticket;const colorClasses={red:'bg-red-100 border-red-300',green:'bg-green-100 border-green-300'};return `<div class="border rounded-lg p-3 ${colorClasses[colorScheme]}"><div class="flex justify-between items-start"><div class="flex-1"><div class="font-semibold text-sm">${ticket.description}${data.hasCustomEndDate ? '<span class="ml-1 text-xs text-blue-600" title="Custom deadline set">ğŸ“…</span>':''}</div><div class="text-xs text-gray-600 mt-1">${data.delayCount}${config.labels.metric}â€¢ ${data.totalDelayDays}days ${config.labels.action}${data.hasCustomEndDate ? ' â€¢ Custom deadline active':''}</div></div><div class="text-xs">Size:${ticket.size}â€¢ Priority:${ticket.priority || 'P3'}</div></div>${data.history.length>1 || data.hasCustomEndDate ? `<div class="mt-2 text-xs">${data.history.length>1 ? `<div class="font-medium">${config.type==='start' ? 'Start Date History':'Extension History'}:</div>${data.history.map((entry,index)=>`<div class="ml-2">${index+1}. ${formatDate(entry[config.dateField])}${entry.reason ? `(${entry.reason})`:''}</div>`).join('')}`:''}${data.hasCustomEndDate && data.history.length<=1 ? `<div class="font-medium">Current Status:</div><div class="ml-2">â€¢ Custom deadline:${ticket.customEndDate}(Set via bulk resolution)</div>`:''}</div>`:''}</div>`;}function renderStandardChart(delayData,config){const delayCounts={};delayData.forEach(data=>{const count=data.delayCount;delayCounts[count]=(delayCounts[count] || 0)+1;});const maxCount=Math.max(...Object.values(delayCounts));const chartHtml=Object.keys(delayCounts).sort((a,b)=>parseInt(a)-parseInt(b)).map(delayCount=>{const count=delayCounts[delayCount];const barHeight=(count/maxCount)*100;const color=delayCount==='0' ? 'bg-green-200 border-green-300':delayCount>='2' ? 'bg-red-200 border-red-300':'bg-yellow-200 border-yellow-300';return `<div class="text-center"><div class="${color}border mx-auto mb-1" style="width:40px;height:${Math.max(barHeight,5)}px;max-height:100px;"></div><div class="text-xs">${delayCount}${config.labels.metric}</div><div class="text-xs font-semibold">${count}tasks</div></div>`;}).join('');return `<div><h4 class="font-semibold mb-2">${config.labels.metric.charAt(0).toUpperCase()+config.labels.metric.slice(1)}Distribution</h4><div class="flex items-end justify-center space-x-2" style="height:120px;">${chartHtml}</div></div><div><h4 class="font-semibold mb-2">Key Insights</h4><ul class="text-sm space-y-1"><li>â€¢ ${delayData.filter(d=>d.delayCount===0).length}tasks ${config.type==='start' ? 'started on original date':'completed on original timeline'}</li><li>â€¢ ${delayData.filter(d=>d.delayCount>=1).length}tasks experienced ${config.labels.metric}</li><li>â€¢ ${delayData.filter(d=>d.isProblematic).length}tasks need attention</li><li>â€¢ Avg ${config.labels.metric}per task:${(delayData.reduce((sum,d)=>sum+d.delayCount,0)/delayData.length).toFixed(1)}</li></ul></div>`;}function renderComprehensiveAnalysis(comprehensiveData,config){const highRiskTasks=comprehensiveData.filter(d=>d.isHighRisk);const mediumRiskTasks=comprehensiveData.filter(d=>d.isMediumRisk && !d.isHighRisk);const lowRiskTasks=comprehensiveData.filter(d=>!d.isMediumRisk && !d.isHighRisk);return `<div class="space-y-6"><div class="bg-${config.bgColor}-50 border border-${config.bgColor}-200 rounded-lg p-4"><h3 class="text-lg font-semibold text-${config.bgColor}-800 mb-2">${config.title}</h3><div class="grid grid-cols-1 md:grid-cols-5 gap-4 text-sm"><div class="bg-white rounded p-3 text-center"><div class="text-2xl font-bold text-gray-800">${comprehensiveData.length}</div><div class="text-gray-600">Total Tasks</div></div><div class="bg-white rounded p-3 text-center"><div class="text-2xl font-bold text-red-600">${highRiskTasks.length}</div><div class="text-gray-600">High Risk</div></div><div class="bg-white rounded p-3 text-center"><div class="text-2xl font-bold text-orange-600">${mediumRiskTasks.length}</div><div class="text-gray-600">Medium Risk</div></div><div class="bg-white rounded p-3 text-center"><div class="text-2xl font-bold text-green-600">${lowRiskTasks.length}</div><div class="text-gray-600">Low Risk</div></div><div class="bg-white rounded p-3 text-center"><div class="text-2xl font-bold text-purple-600">${comprehensiveData.reduce((sum,d)=>sum+d.totalIssues,0)}</div><div class="text-gray-600">Total Issues</div></div></div></div>${highRiskTasks.length>0 ? `<div class="bg-red-50 border border-red-200 rounded-lg p-4"><h3 class="text-lg font-semibold text-red-800 mb-4">ğŸš¨ ${config.labels.highRisk}(Urgent Attention Needed)</h3><div class="space-y-3">${highRiskTasks.map(data=>generateComprehensiveDelayCard(data,'red')).join('')}</div></div>`:''}${mediumRiskTasks.length>0 ? `<div class="bg-orange-50 border border-orange-200 rounded-lg p-4"><h3 class="text-lg font-semibold text-orange-800 mb-4">âš ï¸ ${config.labels.mediumRisk}(Monitor Closely)</h3><div class="space-y-3">${mediumRiskTasks.map(data=>generateComprehensiveDelayCard(data,'orange')).join('')}</div></div>`:''}${lowRiskTasks.length>0 ? `<div class="bg-green-50 border border-green-200 rounded-lg p-4"><h3 class="text-lg font-semibold text-green-800 mb-4">âœ… ${config.labels.lowRisk}</h3><div class="space-y-2">${lowRiskTasks.slice(0,5).map(data=>generateComprehensiveDelayCard(data,'green')).join('')}${lowRiskTasks.length>5 ? `<div class="text-sm text-gray-600 italic">... and ${lowRiskTasks.length-5}more low-risk tasks</div>`:''}</div></div>`:''}<div class="bg-gray-50 border border-gray-200 rounded-lg p-4"><h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“ˆ Risk Distribution & Patterns</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${renderComprehensiveChart(comprehensiveData)}</div></div></div>`;}function generateComprehensiveDelayCard(data,colorScheme){const ticket=data.ticket;const colorClasses={red:'bg-red-100 border-red-300',orange:'bg-orange-100 border-orange-300',green:'bg-green-100 border-green-300'};return `<div class="border rounded-lg p-3 ${colorClasses[colorScheme]}"><div class="flex justify-between items-start"><div class="flex-1"><div class="font-semibold text-sm">Task #${ticket.id}:${ticket.description}</div><div class="text-xs text-gray-600 mt-1">ğŸ“… ${data.startDelayCount}start delays â€¢ â° ${data.endDelayCount}deadline extensions â€¢ ğŸ“ ${data.sizeChangeCount}size changes</div><div class="text-xs text-gray-600">Total delay impact:${data.totalDelayDays}days â€¢ Risk score:${data.totalIssues}issues</div></div><div class="text-xs">${ticket.assigned.join(',')}</div></div>${(data.startHistory.length>1 || data.endHistory.length>1 || data.sizeHistory.length>1) ? `<div class="mt-2 text-xs">${data.startHistory.length>1 ? `<div class="text-gray-700 font-medium">Start Date Changes:</div>${data.startHistory.slice(1).map(entry=>`<div class="ml-2">â€¢ ${entry.date}${entry.reason ? `(${entry.reason})`:''}</div>` ).join('')}`:''}${data.endHistory.length>1 ? `<div class="text-gray-700 font-medium mt-1">End Date Extensions:</div>${data.endHistory.slice(1).map(entry=>`<div class="ml-2">â€¢ ${entry.endDate}${entry.reason ? `(${entry.reason})`:''}</div>` ).join('')}`:''}${data.sizeHistory.length>1 ? `<div class="text-gray-700 font-medium mt-1">Size Changes:</div>${data.sizeHistory.slice(1).map(entry=>`<div class="ml-2">â€¢ ${entry.oldSize}â†’ ${entry.newSize}${entry.reason ? `(${entry.reason})`:''}</div>` ).join('')}`:''}</div>`:''}</div>`;}function renderComprehensiveChart(comprehensiveData){const riskCounts={'High Risk':comprehensiveData.filter(d=>d.isHighRisk).length,'Medium Risk':comprehensiveData.filter(d=>d.isMediumRisk && !d.isHighRisk).length,'Low Risk':comprehensiveData.filter(d=>!d.isMediumRisk && !d.isHighRisk).length};const maxRiskCount=Math.max(...Object.values(riskCounts));const riskChartHtml=Object.entries(riskCounts).map(([risk,count])=>{const height=maxRiskCount>0 ? (count/maxRiskCount)*100:0;const color=risk==='High Risk' ? 'bg-red-500':risk==='Medium Risk' ? 'bg-orange-500':'bg-green-500';return `<div class="flex flex-col items-center"><div class="${color}" style="width:40px;height:${height}px;min-height:4px;"></div><div class="text-xs mt-1">${count}</div><div class="text-xs text-gray-600">${risk}</div></div>`;}).join('');return `<div><h4 class="font-semibold mb-2">Risk Distribution</h4><div class="flex items-end justify-center space-x-4" style="height:120px;">${riskChartHtml}</div></div><div><h4 class="font-semibold mb-2">Key Risk Indicators</h4><ul class="text-sm space-y-1"><li>â€¢ ${comprehensiveData.filter(d=>d.startDelayCount>0).length}tasks had start delays</li><li>â€¢ ${comprehensiveData.filter(d=>d.endDelayCount>0).length}tasks had deadline extensions</li><li>â€¢ ${comprehensiveData.filter(d=>d.sizeChangeCount>0).length}tasks had size changes</li><li>â€¢ Avg issues per task:${(comprehensiveData.reduce((sum,d)=>sum+d.totalIssues,0)/comprehensiveData.length).toFixed(1)}</li><li>â€¢ Total delay impact:${comprehensiveData.reduce((sum,d)=>sum+d.totalDelayDays,0)}days</li></ul></div>`;}function generateDelayAnalysis(){generateDelayAnalysisGeneric('start');}function generateEndDateDelayAnalysis(){generateDelayAnalysisGeneric('end');}function generateComprehensiveDelayAnalysis(){generateDelayAnalysisGeneric('comprehensive');}function closeDelayAnalysis(){document.getElementById('delayAnalysisModal').classList.add('hidden');}function openBulkTaskResolution(){const overdueInProgressTasks=getOverdueInProgressTasks();if (overdueInProgressTasks.length===0){alert('âœ… No overdue "In Progress" tasks found!\n\nAll tasks are either on track or not yet in progress.');return;}renderBulkTaskResolutionContent(overdueInProgressTasks);document.getElementById('bulkTaskResolutionModal').classList.remove('hidden');}function closeBulkTaskResolution(){document.getElementById('bulkTaskResolutionModal').classList.add('hidden');}function getOverdueInProgressTasks(){const today=new Date();today.setHours(0,0,0,0);const projectedTickets=getProjectedTickets();return tickets.filter(ticket=>{if (ticket.status !=='In Progress') return false;const projectedTicket=projectedTickets.find(pt=>pt.id===ticket.id);if (!projectedTicket || !projectedTicket.rawEndDate) return false;const endDate=new Date(projectedTicket.rawEndDate);endDate.setHours(0,0,0,0);return endDate<today;});}function renderBulkTaskResolutionContent(overdueInProgressTasks){const projectedTickets=getProjectedTickets();let html=`<div class="space-y-4"><div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4"><h3 class="text-lg font-semibold text-yellow-800 mb-2">ğŸ“Š Summary</h3><p class="text-yellow-700">Found<strong>${overdueInProgressTasks.length}</strong>overdue "In Progress" task${overdueInProgressTasks.length !==1 ? 's':''}that need resolution.</p></div>`;overdueInProgressTasks.forEach(ticket=>{const projectedTicket=projectedTickets.find(pt=>pt.id===ticket.id);const endDate=projectedTicket ? new Date(projectedTicket.rawEndDate):null;const daysOverdue=endDate ? Math.floor((new Date()-endDate)/(1000*60*60*24)):0;html+=`<div class="border border-gray-200 rounded-lg p-4 bg-white" id="task-${ticket.id}"><div class="flex justify-between items-start mb-3"><div class="flex-1"><h4 class="text-lg font-semibold text-gray-800">Task #${ticket.id}:${ticket.description}</h4><div class="text-sm text-gray-600 mt-1"><span class="inline-block mr-4">ğŸ“… Started:${ticket.startDate}</span><span class="inline-block mr-4">ğŸ“Š Size:${ticket.size}(${taskSizeDefinitions[ticket.size]?.days || 0}days)</span><span class="inline-block mr-4">ğŸ‘¥ Assigned:${ticket.assigned.join(',')}</span></div><div class="text-sm mt-1"><span class="text-red-600 font-medium">ğŸš¨ Overdue by ${daysOverdue}day${daysOverdue !==1 ? 's':''}(expected completion:${endDate ? endDate.toLocaleDateString():'Unknown'})</span></div></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-3"><div class="bg-green-50 border border-green-200 rounded p-3"><h5 class="font-medium text-green-800 mb-2">âœ… Mark as Done</h5><button onclick="markTaskDone(${ticket.id})" class="w-full px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">Complete Task</button></div><div class="bg-yellow-50 border border-yellow-200 rounded p-3"><h5 class="font-medium text-yellow-800 mb-2">â¸ï¸ Pause Task</h5><textarea id="pause-comment-${ticket.id}" placeholder="Reason for pausing..." class="w-full p-2 border border-yellow-300 rounded text-sm mb-2 h-16 resize-none"></textarea><button onclick="pauseTaskWithComment(${ticket.id})" class="w-full px-3 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 transition-colors">Pause Task</button></div><div class="bg-blue-50 border border-blue-200 rounded p-3"><h5 class="font-medium text-blue-800 mb-2">ğŸ“… Extend Deadline</h5><input type="date" id="new-end-date-${ticket.id}" class="w-full p-2 border border-blue-300 rounded text-sm mb-2" min="${getLocalDateString(new Date())}" onchange="validateNewEndDate(${ticket.id})"><div id="size-info-${ticket.id}" class="text-xs text-blue-600 mb-2 min-h-[2rem]">Select a new end date to see size impact</div><button onclick="extendTaskDeadline(${ticket.id})" id="extend-btn-${ticket.id}" class="w-full px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors disabled:bg-gray-400" disabled>Extend Deadline</button></div></div></div>`;});html+=`</div><div class="mt-6 pt-4 border-t border-gray-200 text-center"><button onclick="closeBulkTaskResolution()" class="px-6 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">Close</button></div>`;document.getElementById('bulkTaskResolutionContent').innerHTML=html;}function markTaskDone(ticketId){const ticket=tickets.find(t=>t.id===ticketId);if (!ticket) return;const oldStatus=ticket.status;ticket.status='Done';console.log(`âœ… Marked task #${ticketId}as Done (was:${oldStatus})`);const taskElement=document.getElementById(`task-${ticketId}`);if (taskElement){taskElement.style.opacity='0.5';taskElement.innerHTML=`<div class="text-center py-4"><div class="text-green-600 font-semibold">âœ… Task marked as Done!</div><div class="text-sm text-gray-600 mt-1">Status updated successfully</div></div>`;}saveToLocalStorage();selectedStatusFilters=[];const doneProjectedTickets=getProjectedTickets();renderTickets(doneProjectedTickets);setTimeout(()=>checkAllTasksResolved(),1000);}function pauseTaskWithComment(ticketId){const ticket=tickets.find(t=>t.id===ticketId);if (!ticket) return;const comment=document.getElementById(`pause-comment-${ticketId}`).value.trim();if (!comment){alert('Please provide a reason for pausing this task.');return;}const oldStatus=ticket.status;ticket.status='Paused';if (!ticket.pauseComments){ticket.pauseComments=[];}ticket.pauseComments.push({comment:comment,timestamp:new Date().toISOString(),action:'Paused from bulk resolution'});console.log(`â¸ï¸ Paused task #${ticketId}(was:${oldStatus}):${comment}`);const taskElement=document.getElementById(`task-${ticketId}`);if (taskElement){taskElement.style.opacity='0.5';taskElement.innerHTML=`<div class="text-center py-4"><div class="text-yellow-600 font-semibold">â¸ï¸ Task paused!</div><div class="text-sm text-gray-600 mt-1">Reason:${comment}</div></div>`;}saveToLocalStorage();selectedStatusFilters=[];const pausedProjectedTickets=getProjectedTickets();renderTickets(pausedProjectedTickets);setTimeout(()=>checkAllTasksResolved(),1000);}function validateNewEndDate(ticketId){const ticket=tickets.find(t=>t.id===ticketId);if (!ticket) return;const newEndDateInput=document.getElementById(`new-end-date-${ticketId}`);const sizeInfoDiv=document.getElementById(`size-info-${ticketId}`);const extendBtn=document.getElementById(`extend-btn-${ticketId}`);const newEndDate=newEndDateInput.value;if (!newEndDate){sizeInfoDiv.innerHTML='Select a new end date to see size impact';extendBtn.disabled=true;return;}const startDate=new Date(ticket.startDate);const endDate=new Date(newEndDate);const daysDiff=calculateBusinessDays(startDate,endDate);const newSize=calculateSizeFromDays(daysDiff);const maxSize=getMaximumSize();const maxDays=taskSizeDefinitions[maxSize]?.days || 0;if (daysDiff>maxDays){const startDate=new Date(ticket.startDate);const maxAllowedEndDate=addBusinessDays(startDate,maxDays-1);const maxAllowedDateStr=maxAllowedEndDate.toLocaleDateString('en-GB');sizeInfoDiv.innerHTML=`<span class="text-red-600">âŒ Duration too long:${daysDiff}business days exceeds maximum (${maxDays}days for ${maxSize}). Latest allowed is ${maxAllowedDateStr}</span>`;extendBtn.disabled=true;}else{const currentSize=ticket.size;const currentDays=taskSizeDefinitions[currentSize]?.days || 0;sizeInfoDiv.innerHTML=`<div class="text-blue-700">ğŸ“Š New duration:${daysDiff}business days<br>ğŸ“ Size change:${currentSize}(${currentDays}d) â†’ ${newSize}(${taskSizeDefinitions[newSize]?.days || 0}d)</div>`;extendBtn.disabled=false;}}function calculateSizeFromDays(days){const sizes=Object.keys(taskSizeDefinitions).sort((a,b)=>taskSizeDefinitions[a].days-taskSizeDefinitions[b].days );for (const size of sizes){if (taskSizeDefinitions[size].days>=days){return size;}}return sizes[sizes.length-1];}function getMaximumSize(){let maxSize='S';let maxDays=0;for (const [size,config] of Object.entries(taskSizeDefinitions)){if (config.days>maxDays){maxDays=config.days;maxSize=size;}}return maxSize;}function extendTaskDeadline(ticketId){const ticket=tickets.find(t=>t.id===ticketId);if (!ticket) return;const newEndDateInput=document.getElementById(`new-end-date-${ticketId}`);const newEndDate=newEndDateInput.value;if (!newEndDate){alert('Please select a new end date.');return;}const startDate=new Date(ticket.startDate);const endDate=new Date(newEndDate);const daysDiff=calculateBusinessDays(startDate,endDate);const oldSize=ticket.size;const newSize=calculateSizeFromDays(daysDiff);trackSizeChange(ticket,oldSize,newSize,'Deadline extension via bulk resolution');const projectedTickets=getProjectedTickets();const projectedTicket=projectedTickets.find(pt=>pt.id===ticketId);const oldEndDate=projectedTicket ? projectedTicket.rawEndDate:null;if (oldEndDate){trackEndDateChange(ticket,oldEndDate,newEndDate,'Deadline extension via bulk resolution');}ticket.size=newSize;ticket.customEndDate=newEndDate;console.log(` Extended deadline for task #${ticketId}:${oldSize}â†’ ${newSize}(${daysDiff}business days)`);const taskElement=document.getElementById(`task-${ticketId}`);if (taskElement){taskElement.style.opacity='0.5';taskElement.innerHTML=`<div class="text-center py-4"><div class="text-blue-600 font-semibold">ğŸ“… Deadline extended!</div><div class="text-sm text-gray-600 mt-1">Size updated:${oldSize}â†’ ${newSize}<br>New target:${new Date(newEndDate).toLocaleDateString()}</div></div>`;}saveToLocalStorage();const extendedProjectedTickets=getProjectedTickets();renderTickets(extendedProjectedTickets);setTimeout(()=>checkAllTasksResolved(),1000);}function checkAllTasksResolved(){const remainingTasks=getOverdueInProgressTasks();if (remainingTasks.length===0){document.getElementById('bulkTaskResolutionContent').innerHTML=`<div class="text-center py-8"><div class="text-6xl mb-4">ğŸ‰</div><h3 class="text-2xl font-bold text-green-600 mb-2">All Tasks Resolved!</h3><p class="text-gray-600 mb-4">Great job! All overdue tasks have been addressed.</p><button onclick="closeBulkTaskResolution()" class="px-6 py-3 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">Close</button></div>`;}}document.addEventListener('click',function(event){const modal=document.getElementById('delayAnalysisModal');if (event.target===modal){closeDelayAnalysis();}});document.addEventListener('click',function(event){const modal=document.getElementById('bulkTaskResolutionModal');if (event.target===modal){closeBulkTaskResolution();}});function generateCompletionGraph(){console.log('ğŸ“ˆ Generating completion projection graph...');const projectedTickets=getProjectedTickets();console.log('ğŸ” Projected tickets:',projectedTickets);if (projectedTickets.length===0){alert('No tasks found to generate completion graph. Please add some tasks first.');return;}const sortedTasks=projectedTickets .filter(task=>task.rawEndDate && task.rawEndDate !=='N/A') .sort((a,b)=>new Date(a.rawEndDate)-new Date(b.rawEndDate));console.log('ğŸ” Filtered and sorted tasks:',sortedTasks);if (sortedTasks.length===0){alert('No scheduled tasks found. Please ensure tasks have valid start dates and team assignments.');return;}const graphData=[];let cumulativeCount=0;sortedTasks.forEach((task,index)=>{cumulativeCount++;graphData.push({taskNumber:cumulativeCount,completionDate:formatDate(getLocalDateString(task.rawEndDate)),task:task,dateString:getLocalDateString(task.rawEndDate)});});console.log('ğŸ“Š Graph data prepared:',graphData);document.getElementById('completionGraphModal').classList.remove('hidden');renderCompletionChart(graphData);}function renderCompletionChart(data){const container=document.getElementById('completionGraphContent');const allDates=[...new Set(data.map(item=>item.dateString))].sort();const dateLabels=allDates.map(dateStr=>formatDate(dateStr));const chartPoints=[];let cumulativeCount=0;allDates.forEach(dateStr=>{const tasksCompletingOnThisDate=data.filter(item=>item.dateString===dateStr).length;cumulativeCount+=tasksCompletingOnThisDate;chartPoints.push({date:dateStr,dateLabel:formatDate(dateStr),cumulativeCount:cumulativeCount,tasksThisDate:tasksCompletingOnThisDate});});let chartHTML=`<div class="w-full h-full bg-gray-50 border rounded-lg p-4"><div class="mb-4"><h3 class="text-lg font-semibold text-gray-800 mb-2">Task Completion Timeline</h3><div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800"><p><strong>ğŸ“Š Chart Explanation:</strong>This graph shows the projected completion dates for all tasks based on current scheduling and team capacity. The line shows cumulative tasks completed over time,with each point representing when tasks are scheduled to finish.</p></div><p class="text-sm text-gray-600">Showing projected completion dates for ${data.length}scheduled tasks across ${allDates.length}completion dates</p></div><div class="relative h-64 mb-6 bg-white border rounded"><div class="absolute left-0 top-0 bottom-0 w-12 flex flex-col justify-between text-xs text-gray-500 py-4"><span>${data.length}</span><span>${Math.floor(data.length*0.75)}</span><span>${Math.floor(data.length*0.5)}</span><span>${Math.floor(data.length*0.25)}</span><span>0</span></div><div class="ml-12 h-full relative"><svg class="w-full h-full" viewBox="0 0 800 200">${generateGridLines(data.length)}${generateRealisticChartPath(chartPoints,800,200,data.length)}${generateRealisticDataPoints(chartPoints,800,200,data.length)}</svg></div><div class="ml-12 mt-2 flex justify-between text-xs text-gray-500">${generateDateLabels(chartPoints)}</div></div><div class="max-h-48 overflow-y-auto"><h4 class="font-semibold mb-2 text-gray-800">Task Details:</h4><div class="space-y-1">${data.map(item=>`<div class="flex justify-between items-center p-2 bg-gray-50 rounded text-sm"><span class="font-medium text-blue-600">Task #${item.taskNumber}</span><span class="text-gray-600">${item.task.description}</span><span class="text-gray-800 font-medium">${item.completionDate}</span></div>`).join('')}</div></div></div>`;container.innerHTML=chartHTML;}function generateGridLines(maxTasks){let lines='';for (let i=0;i<=4;i++){const y=(i/4)*200;lines+=`<line x1="0" y1="${y}" x2="800" y2="${y}" stroke="#e5e7eb" stroke-width="1"/>`;}return lines;}function generateChartPath(data,width,height){if (data.length<2) return '';let path='';data.forEach((point,index)=>{const x=(index/(data.length-1))*width;const y=height-(point.taskNumber/data.length)*height;if (index===0){path+=`M ${x}${y}`;}else{path+=` L ${x}${y}`;}});return `<path d="${path}" stroke="#3b82f6" stroke-width="2" fill="none"/>`;}function generateRealisticChartPath(chartPoints,width,height,maxTasks){if (chartPoints.length<2) return '';let path='';chartPoints.forEach((point,index)=>{const x=(index/(chartPoints.length-1))*width;const y=height-(point.cumulativeCount/maxTasks)*height;if (index===0){path+=`M ${x}${y}`;}else{path+=` L ${x}${y}`;}});return `<path d="${path}" stroke="#3b82f6" stroke-width="2" fill="none"/>`;}function generateDataPoints(data,width,height){return data.map((point,index)=>{const x=(index/(data.length-1))*width;const y=height-(point.taskNumber/data.length)*height;return `<circle cx="${x}" cy="${y}" r="4" fill="#3b82f6" stroke="white" stroke-width="2"><title>Task ${point.taskNumber}:${point.task.description}-${point.completionDate}</title></circle>`;}).join('');}function generateRealisticDataPoints(chartPoints,width,height,maxTasks){return chartPoints.map((point,index)=>{const x=(index/(chartPoints.length-1))*width;const y=height-(point.cumulativeCount/maxTasks)*height;return `<circle cx="${x}" cy="${y}" r="4" fill="#3b82f6" stroke="white" stroke-width="2"><title>${point.cumulativeCount}tasks completed by ${point.dateLabel}(${point.tasksThisDate}task${point.tasksThisDate>1 ? 's':''}completing this date)</title></circle>`;}).join('');}function generateDateLabels(chartPoints){if (chartPoints.length<=3){return chartPoints.map(point=>`<span>${point.dateLabel}</span>`).join('');}const first=chartPoints[0];const middle=chartPoints[Math.floor(chartPoints.length/2)];const last=chartPoints[chartPoints.length-1];return `<span>${first.dateLabel}</span><span>${middle.dateLabel}</span><span>${last.dateLabel}</span>`;}function closeCompletionGraph(){document.getElementById('completionGraphModal').classList.add('hidden');}document.addEventListener('click',function(event){const modal=document.getElementById('completionGraphModal');if (event.target===modal){closeCompletionGraph();}});function getEndDateFormula(){return `How Task End Dates are Calculated:1. FIXED-LENGTH TASKS (Default-marked with ğŸ”’):â€¢ Duration=Task Size (in days) â€¢ Multiple people do NOT reduce the duration â€¢ People work in parallel on different aspects Formula:End Date=Start Date+Task Size Days Example 1:10-day task (XL) with 1 person â†’ Takes 10 business days Example 2:10-day task (XL) with 5 people â†’ Still takes 10 business days â†’ Each person works 20% capacity (10 days Ã· 5 people) 2. FLEXIBLE TASKS (Opt-in-marked with âš¡):â€¢ Duration=Task Size Ã· Number of Assignees â€¢ More people=shorter duration (work is divided) â€¢ People work on same tasks,splitting the effort Formula:End Date=Start Date+(Task Size Days Ã· Number of Assignees) Example 1:10-day task with 1 person â†’ Takes 10 business days (100% capacity) Example 2:10-day task with 2 people â†’ Takes 5 business days (100% capacity each) Example 3:10-day task with 5 people â†’ Takes 2 business days (100% capacity each) 3. WEEKEND HANDLING (Both task types):â€¢ All dates automatically skip weekends (Saturday/Sunday) â€¢ If a calculated end date falls on Saturday:moved to Monday â€¢ If a calculated end date falls on Sunday:moved to Monday â€¢ Only business days (Monday-Friday) count toward duration 4. CUSTOM END DATES:â€¢ You can manually override any calculated end date â€¢ Useful for external deadlines or dependencies â€¢ Custom dates are preserved until you clear them 5. TASK SIZES:â€¢ S (Small)=1 day â€¢ M (Medium)=2 days â€¢ L (Large)=5 days â€¢ XL (Extra Large)=10 days â€¢ XXL (Extra Extra Large)=15 days â€¢ Custom sizes can be configured`;}function getHeatMapFormula(){return `How Team Workload Heat Map Cells are Calculated:1. WEEK GROUPING:â€¢ Heat map shows the next 8 weeks from today (or earliest task) â€¢ Each column represents one week (Monday to Friday) â€¢ Weekends (Saturday/Sunday) are excluded from calculations 2. CAPACITY CALCULATION PER PERSON PER WEEK:â€¢ Each person has a weekly availability (e.g.,25 hours/week) â€¢ Tasks consume capacity based on task type and assignees For FIXED-LENGTH TASKS (ğŸ”’):Capacity per Person=(Task Size Ã— Base Hours) Ã· Number of Assignees Ã· Task Duration Example:10-day task,5 base hours/day,2 people â†’ Total effort:10 days Ã— 5 hours=50 hours â†’ Per person:50 hours Ã· 2 people=25 hours each â†’ Duration:10 business days (not reduced) â†’ Weekly capacity:25 hours Ã· 2 weeks=12.5 hours/week For FLEXIBLE TASKS (âš¡):Capacity per Person=(Task Size Ã— Base Hours) Ã· Task Duration Example:10-day task,5 base hours/day,2 people â†’ Total effort:10 days Ã— 5 hours=50 hours â†’ Duration:10 days Ã· 2 people=5 business days â†’ Per person:50 hours (each does full work faster) â†’ Weekly capacity:50 hours Ã· 1 week=50 hours/week 3. UTILIZATION PERCENTAGE:â€¢ Utilization %=(Hours Consumed Ã· Available Hours) Ã— 100 Example:Person with 25 hours/week availability â€¢ 10 hours consumed â†’ 40% utilization (Green-under capacity) â€¢ 25 hours consumed â†’ 100% utilization (Yellow-at capacity) â€¢ 35 hours consumed â†’ 140% utilization (Red-overallocated) 4. COLOR CODING:â€¢ 0-50%:Light green (plenty of capacity) â€¢ 51-80%:Yellow-green (moderate load) â€¢ 81-100%:Yellow (at capacity) â€¢ 101-120%:Orange (slightly overallocated) â€¢ 121%+:Red (significantly overallocated) 5. TASK STATUS FILTERING:â€¢ Only active tasks are included (To Do,In Progress) â€¢ Done,Paused,and Closed tasks are excluded â€¢ This shows current/future workload only 6. MULTI-TASK ALLOCATION:â€¢ If a person has multiple tasks in the same week â€¢ All task capacities are summed together â€¢ This can lead to>100% utilization (overallocation) 7. CLICKING A CELL:â€¢ Shows all tasks for that person in that week â€¢ Displays capacity breakdown per task â€¢ Allows toggling between Fixed/Flexible task types`;}function showEndDateFormula(){const formula=getEndDateFormula();document.getElementById('formula-modal-title').textContent='ğŸ“… End Date Calculation Formula';document.getElementById('formula-modal-content').textContent=formula;document.getElementById('formula-modal').classList.add('active');}function showHeatMapFormula(){const formula=getHeatMapFormula();document.getElementById('formula-modal-title').textContent='ğŸ“Š Heat Map Calculation Formula';document.getElementById('formula-modal-content').textContent=formula;document.getElementById('formula-modal').classList.add('active');}function closeFormulaModal(){document.getElementById('formula-modal').classList.remove('active');}document.addEventListener('click',function(event){const modal=document.getElementById('formula-modal');if (event.target===modal){closeFormulaModal();}});window.onload=initializeScheduler;</script></body></html>